# nodejså¼‚æ­¥I/Oå’Œäº‹ä»¶å¾ªç¯

## å‰è¨€

æœ¬æ–‡è®²è¯¦ç»†è®²è§£ nodejs ä¸­ä¸¤ä¸ªæ¯”è¾ƒéš¾ä»¥ç†è§£çš„éƒ¨åˆ†**å¼‚æ­¥I/O**å’Œ**äº‹ä»¶å¾ªç¯**ï¼Œå¯¹ nodejs æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œåšæ¢³ç†å’Œè¡¥å……ã€‚

è€è§„çŸ©æˆ‘ä»¬å¸¦ä¸Šç–‘é—®å¼€å§‹ä»Šå¤©çš„åˆ†æğŸ¤”ğŸ¤”ğŸ¤”ï¼š

- 1 è¯´è¯´ nodejs çš„å¼‚æ­¥I/O ï¼Ÿ

- 2 è¯´è¯´ nodejs çš„äº‹ä»¶å¾ªç¯æœºåˆ¶ ï¼Ÿ

- 3 ä»‹ç»ä¸€ä¸‹ nodejs ä¸­äº‹ä»¶å¾ªç¯çš„å„ä¸ªé˜¶æ®µ ï¼Ÿ

- 4 nodejs ä¸­ promise å’Œ nextTick çš„åŒºåˆ«ï¼Ÿ

- 5 nodejs ä¸­ setImmediate å’Œ setTimeout åŒºåˆ« ï¼Ÿ

- 6 setTimeout æ˜¯ç²¾ç¡®çš„å—ï¼Œä»€ä¹ˆæƒ…å†µå½±å“ setTimeout çš„æ‰§è¡Œï¼Ÿ

- 7 nodejs ä¸­äº‹ä»¶å¾ªç¯å’Œæµè§ˆå™¨æœ‰ä»€ä¹ˆä¸åŒ ï¼Ÿ

## å¼‚æ­¥I/O

### æ¦‚å¿µ

å¤„ç†å™¨è®¿é—®ä»»ä½•å¯„å­˜å™¨å’Œ Cache ç­‰å°è£…ä»¥å¤–çš„æ•°æ®èµ„æºéƒ½å¯ä»¥å½“æˆ I/O æ“ä½œï¼ŒåŒ…æ‹¬å†…å­˜ï¼Œç£ç›˜ï¼Œæ˜¾å¡ç­‰å¤–éƒ¨è®¾å¤‡ã€‚**åœ¨ Nodejs ä¸­åƒå¼€å‘è€…è°ƒç”¨Â `fs`Â è¯»å–æœ¬åœ°æ–‡ä»¶æˆ–ç½‘ç»œè¯·æ±‚ç­‰æ“ä½œéƒ½å±äºI/Oæ“ä½œã€‚ï¼ˆæœ€æ™®éæŠ½è±¡ I/O æ˜¯æ–‡ä»¶æ“ä½œå’Œ TCP/UDP ç½‘ç»œæ“ä½œï¼‰**

Nodejs ä¸ºå•çº¿ç¨‹çš„ï¼Œåœ¨å•çº¿ç¨‹æ¨¡å¼ä¸‹ï¼Œä»»åŠ¡éƒ½æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œä½†æ˜¯å‰é¢çš„ä»»åŠ¡å¦‚æœç”¨æ—¶è¿‡é•¿ï¼Œé‚£ä¹ˆåŠ¿å¿…ä¼šå½±å“åˆ°åç»­ä»»åŠ¡çš„è¿›è¡Œï¼Œé€šå¸¸ I/O ä¸ cpu ä¹‹é—´çš„è®¡ç®—æ˜¯å¯ä»¥å¹¶è¡Œè¿›è¡Œçš„ï¼Œä½†æ˜¯åŒæ­¥çš„æ¨¡å¼ä¸‹ï¼ŒI/Oçš„è¿›è¡Œä¼šå¯¼è‡´åç»­ä»»åŠ¡çš„ç­‰å¾…ï¼Œè¿™æ ·é˜»å¡äº†ä»»åŠ¡çš„æ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†èµ„æºä¸èƒ½å¾ˆå¥½çš„åˆ©ç”¨ã€‚

ä¸ºäº†è§£å†³å¦‚ä¸Šçš„é—®é¢˜ï¼Œ**Nodejs é€‰æ‹©äº†å¼‚æ­¥I/Oçš„æ¨¡å¼ï¼Œè®©å•çº¿ç¨‹ä¸å†é˜»å¡ï¼Œæ›´åˆç†çš„ä½¿ç”¨èµ„æºã€‚**

### å¦‚ä½•åˆç†çš„çœ‹å¾…Nodejsä¸­å¼‚æ­¥I/O

å‰ç«¯å¼€å‘è€…å¯èƒ½æ›´æ¸…æ™°æµè§ˆå™¨ç¯å¢ƒä¸‹çš„ JS çš„å¼‚æ­¥ä»»åŠ¡ï¼Œæ¯”å¦‚å‘èµ·ä¸€æ¬¡Â `ajax`Â è¯·æ±‚ï¼Œæ­£å¦‚ ajax æ˜¯æµè§ˆå™¨æä¾›ç»™ js æ‰§è¡Œç¯å¢ƒä¸‹å¯ä»¥è°ƒç”¨çš„ api ä¸€æ · ï¼Œåœ¨ Nodejs ä¸­æä¾›äº† http æ¨¡å—å¯ä»¥è®© js åšç›¸åŒçš„äº‹ã€‚æ¯”å¦‚ç›‘å¬ï½œå‘é€ http è¯·æ±‚ï¼Œé™¤äº† http ä¹‹å¤–ï¼Œnodejs è¿˜æœ‰æ“ä½œæœ¬åœ°æ–‡ä»¶çš„ fs æ–‡ä»¶ç³»ç»Ÿç­‰ã€‚

å¦‚ä¸Š fs http è¿™äº›ä»»åŠ¡åœ¨ nodejs ä¸­å«åš I/O ä»»åŠ¡ã€‚ç†è§£äº† I/O ä»»åŠ¡ä¹‹åï¼Œæ¥åˆ†æä¸€ä¸‹åœ¨ Nodejs ä¸­ï¼ŒI/O ä»»åŠ¡çš„ä¸¤ç§å½¢æ€â€”â€”é˜»å¡å’Œéé˜»å¡ã€‚

### nodejsä¸­é˜»å¡å’Œéé˜»å¡IO

nodejs å¯¹äºå¤§éƒ¨åˆ†çš„ I/O æ“ä½œéƒ½æä¾›äº†**é˜»å¡**å’Œ**éé˜»å¡**ä¸¤ç§ç”¨æ³•ã€‚é˜»å¡æŒ‡çš„æ˜¯æ‰§è¡Œ I/O æ“ä½œçš„æ—¶å€™å¿…é¡»ç­‰å¾…ç»“æœï¼Œæ‰å¾€ä¸‹æ‰§è¡Œ js ä»£ç ã€‚å¦‚ä¸‹ä¸€ä¸‹é˜»å¡ä»£ç 

**é˜»å¡I/O**

```js
/* TODO:  é˜»å¡ */
const fs = require('fs');
const data = fs.readFileSync('./file.js');
console.log(data)
```

- ä»£ç é˜»å¡ ï¼šè¯»å–åŒçº§ç›®å½•ä¸‹çš„Â `file.js`Â æ–‡ä»¶ï¼Œç»“æœÂ `data`Â ä¸ºÂ `buffer`Â ç»“æ„ï¼Œè¿™æ ·å½“è¯»å–è¿‡ç¨‹ä¸­ï¼Œä¼šé˜»å¡ä»£ç çš„æ‰§è¡Œï¼Œæ‰€ä»¥Â `console.log(data)`Â å°†è¢«é˜»å¡ï¼Œåªæœ‰å½“ç»“æœè¿”å›çš„æ—¶å€™ï¼Œæ‰èƒ½æ­£å¸¸æ‰“å°Â `data`Â ã€‚

- å¼‚å¸¸å¤„ç† ï¼šå¦‚ä¸Šæ“ä½œæœ‰ä¸€ä¸ªè‡´å‘½ç‚¹å°±æ˜¯ï¼Œå¦‚æœå‡ºç°äº†å¼‚å¸¸ï¼Œï¼ˆæ¯”å¦‚åœ¨åŒçº§ç›®å½•ä¸‹æ²¡æœ‰ file.js æ–‡ä»¶ï¼‰ï¼Œå°±ä¼šè®©æ•´ä¸ªç¨‹åºæŠ¥é”™ï¼Œæ¥ä¸‹æ¥çš„ä»£ç è®²ä¸ä¼šæ‰§è¡Œã€‚é€šå¸¸éœ€è¦ try catchæ¥æ•è·é”™è¯¯è¾¹ç•Œã€‚ä»£ç å¦‚ä¸‹ï¼š

```js
/* TODO: é˜»å¡ - æ•è·å¼‚å¸¸  */
try{
    const fs = require('fs');
    const data = fs.readFileSync('./file1.js');
    console.log(data)
}catch(e){
    console.log('å‘ç”Ÿé”™è¯¯ï¼š',e)
}
console.log('æ­£å¸¸æ‰§è¡Œ')
```

- å¦‚ä¸Šå³ä¾¿å‘ç”Ÿäº†é”™è¯¯ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°åç»­ä»£ç çš„æ‰§è¡Œä»¥åŠåº”ç”¨ç¨‹åºå‘ç”Ÿé”™è¯¯å¯¼è‡´çš„é€€å‡ºã€‚

é˜»å¡ I/O é€ æˆä»£ç æ‰§è¡Œç­‰å¾… I/O ç»“æœï¼Œæµªè´¹ç­‰å¾…æ—¶é—´ï¼ŒCPU çš„å¤„ç†èƒ½åŠ›å¾—ä¸åˆ°å……åˆ†åˆ©ç”¨ï¼ŒI/O å¤±è´¥è¿˜ä¼šè®©æ•´æ•´ä¸ªçº¿ç¨‹é€€å‡ºã€‚é˜»å¡ I / O åœ¨æ•´ä¸ªè°ƒç”¨æ ˆä¸Šç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-1.jpg)

**éé˜»å¡I/O**

Nodejs çš„éé˜»å¡ I/O é‡‡ç”¨çš„æ˜¯å¼‚æ­¥æ¨¡å¼ï¼Œå°±æ˜¯åˆšåˆšä»‹ç»çš„å¼‚æ­¥I/Oã€‚é¦–å…ˆçœ‹ä¸€ä¸‹å¼‚æ­¥æ¨¡å¼ä¸‹çš„ I/O æ“ä½œï¼š

```js
/* TODO: éé˜»å¡ - å¼‚æ­¥ I/O */
const fs = require('fs')
fs.readFile('./file.js',(err,data)=>{
    console.log(err,data) // null  <Buffer 63 6f 6e 73 6f 6c 65 2e 6c 6f 67 28 27 68 65 6c 6c 6f 2c 77 6f 72 6c 64 27 29>
})
console.log(111) // 111 å…ˆè¢«æ‰“å°ï½

fs.readFile('./file1.js',(err,data)=>{
    console.log(err,data) // ä¿å­˜  [ no such file or directory, open './file1.js'] ï¼Œæ‰¾ä¸åˆ°æ–‡ä»¶ã€‚
})
```

- å›è°ƒ callback è¢«å¼‚æ­¥æ‰§è¡Œï¼Œè¿”å›çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œé‚£ä¹ˆè¿”å›Â `null`Â ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºÂ `fs.readFile`Â æ‰§è¡Œå¾—åˆ°çš„çœŸæ­£å†…å®¹ã€‚

- è¿™ç§å¼‚æ­¥çš„å½¢å¼å¯ä»¥ä¼šä¼˜é›…çš„æ•è·åˆ°æ‰§è¡Œ I/O ä¸­å‡ºç°çš„é”™è¯¯ï¼Œæ¯”å¦‚è¯´å¦‚ä¸Šå½“è¯»å–Â `file1.js`Â æ–‡ä»¶æ—¶å€™ï¼Œå‡ºç°äº†æ‰¾ä¸åˆ°å¯¹åº”æ–‡ä»¶çš„å¼‚å¸¸è¡Œä¸ºï¼Œä¼šç›´æ¥é€šè¿‡ç¬¬ä¸€ä¸ªå‚æ•°å½¢å¼ä¼ é€’åˆ° callback ä¸­ã€‚

æ¯”å¦‚å¦‚ä¸Šçš„ callback ï¼Œä½œä¸ºä¸€ä¸ªå¼‚æ­¥å›è°ƒå‡½æ•°ï¼Œå°±åƒ setTimeout(fn) çš„ fn ä¸€æ ·ï¼Œä¸ä¼šé˜»å¡ä»£ç æ‰§è¡Œã€‚ä¼šåœ¨å¾—åˆ°ç»“æœåè§¦å‘ï¼Œå¯¹äº Nodejs å¼‚æ­¥æ‰§è¡Œ I/O å›è°ƒçš„ç»†èŠ‚ï¼Œæ¥ä¸‹æ¥ä¼šæ…¢æ…¢å‰–æã€‚

å¯¹äºå¼‚æ­¥ I/O çš„å¤„ç†ï¼Œ Nodejs å†…éƒ¨ä½¿ç”¨äº†çº¿ç¨‹æ± æ¥å¤„ç†å¼‚æ­¥ I/O ä»»åŠ¡ï¼Œçº¿ç¨‹æ± ä¸­ä¼šæœ‰å¤šä¸ª I/O çº¿ç¨‹æ¥åŒæ—¶å¤„ç†å¼‚æ­¥çš„ I/O æ“ä½œï¼Œæ¯”å¦‚å¦‚ä¸Šçš„çš„ä¾‹å­ä¸­ï¼Œåœ¨æ•´ä¸ª I/O æ¨¡å‹ä¸­ä¼šè¿™æ ·ã€‚

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-2.jpg)

æ¥ä¸‹æ¥å°†ä¸€èµ·æ¢ç´¢ä¸€ä¸‹å¼‚æ­¥ I/O æ‰§è¡Œè¿‡ç¨‹ã€‚

### äº‹ä»¶å¾ªç¯

å’Œæµè§ˆå™¨ä¸€æ ·ï¼ŒNodejs ä¹Ÿæœ‰è‡ªèº«çš„æ‰§è¡Œæ¨¡å‹â€”â€”äº‹ä»¶å¾ªç¯ï¼ˆ eventLoop ï¼‰ï¼Œäº‹ä»¶å¾ªç¯çš„æ‰§è¡Œæ¨¡å‹å—åˆ°å®¿ä¸»ç¯å¢ƒçš„å½±å“ï¼Œå®ƒä¸å±äº javascript æ‰§è¡Œå¼•æ“ï¼ˆ ä¾‹å¦‚ v8 ï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œè¿™å°±å¯¼è‡´äº†ä¸åŒå®¿ä¸»ç¯å¢ƒä¸‹äº‹ä»¶å¾ªç¯æ¨¡å¼å’Œæœºåˆ¶å¯èƒ½ä¸åŒï¼Œç›´è§‚çš„ä½“ç°å°±æ˜¯ Nodejs å’Œæµè§ˆå™¨ç¯å¢ƒä¸‹å¯¹å¾®ä»»åŠ¡ï¼ˆ microtask ï¼‰å’Œå®ä»»åŠ¡ï¼ˆ macrotask ï¼‰å¤„ç†å­˜åœ¨å·®å¼‚ã€‚å¯¹äº Nodejs çš„äº‹ä»¶å¾ªç¯åŠå…¶æ¯ä¸€ä¸ªé˜¶æ®µï¼Œæ¥ä¸‹æ¥ä¼šè¯¦ç»†æ¢è®¨ã€‚

Nodejs çš„äº‹ä»¶å¾ªç¯æœ‰å¤šä¸ªé˜¶æ®µï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªä¸“é—¨å¤„ç† I/O å›è°ƒçš„é˜¶æ®µï¼Œæ¯ä¸€ä¸ªæ‰§è¡Œé˜¶æ®µæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸ºÂ `Tick`Â ï¼Œ æ¯ä¸€ä¸ªÂ `Tick`Â éƒ½ä¼šæŸ¥è¯¢æ˜¯å¦è¿˜æœ‰äº‹ä»¶ä»¥åŠå…³è”çš„å›è°ƒå‡½æ•° ï¼Œå¦‚ä¸Šå¼‚æ­¥ I/O çš„å›è°ƒå‡½æ•°ï¼Œä¼šåœ¨ I/O å¤„ç†é˜¶æ®µæ£€æŸ¥å½“å‰ I/O æ˜¯å¦å®Œæˆï¼Œå¦‚æœå®Œæˆï¼Œé‚£ä¹ˆæ‰§è¡Œå¯¹åº”çš„ I/O å›è°ƒå‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ£€æŸ¥ I/O æ˜¯å¦å®Œæˆçš„è§‚å¯Ÿè€…æˆ‘ä»¬ç§°ä¹‹ä¸º I/O è§‚å¯Ÿè€…ã€‚

### è§‚å¯Ÿè€…

å¦‚ä¸Šæåˆ°äº† I/O è§‚å¯Ÿè€…çš„æ¦‚å¿µï¼Œä¹Ÿè®²äº† Nodejs ä¸­ä¼šæœ‰å¤šä¸ªé˜¶æ®µï¼Œäº‹å®ä¸Šæ¯ä¸€ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå¯¹åº”çš„è§‚å¯Ÿè€…ï¼Œå®ƒä»¬çš„å·¥ä½œå¾ˆæ˜ç¡®å°±æ˜¯åœ¨æ¯ä¸€æ¬¡å¯¹åº”çš„ Tick è¿‡ç¨‹ä¸­ï¼Œå¯¹åº”çš„è§‚å¯Ÿè€…æŸ¥æ‰¾æœ‰æ²¡æœ‰å¯¹åº”çš„äº‹ä»¶æ‰§è¡Œï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆå–å‡ºæ¥æ‰§è¡Œã€‚

æµè§ˆå™¨çš„äº‹ä»¶æ¥æºäºç”¨æˆ·çš„äº¤äº’å’Œä¸€äº›ç½‘ç»œè¯·æ±‚æ¯”å¦‚Â `ajax`Â ç­‰ï¼ŒÂ `Nodejs`Â ä¸­ï¼Œäº‹ä»¶æ¥æºäºç½‘ç»œè¯·æ±‚Â `http`Â ï¼Œæ–‡ä»¶ I/O ç­‰ï¼Œè¿™äº›äº‹ä»¶éƒ½æœ‰å¯¹åº”çš„è§‚å¯Ÿè€…ï¼Œæˆ‘è¿™é‡Œæšä¸¾å‡ºä¸€äº›é‡è¦çš„è§‚å¯Ÿè€…ã€‚

- æ–‡ä»¶ I/O æ“ä½œ Â  Â  Â â€”â€” I/O è§‚å¯Ÿè€…ï¼›

- ç½‘ç»œ I/O æ“ä½œ Â  Â  Â â€”â€” ç½‘ç»œ I/O è§‚å¯Ÿè€…ï¼›

- process.nextTick Â â€”â€” idle è§‚å¯Ÿè€…

- setImmediate Â  Â  Â â€”â€” check è§‚å¯Ÿè€…

- setTimeout/setInterval â€”â€” å»¶æ—¶å™¨è§‚å¯Ÿè€…

- ...

åœ¨ Nodejs ä¸­ï¼Œå¯¹åº”è§‚å¯Ÿè€…æ¥æ”¶å¯¹åº”ç±»å‹çš„äº‹ä»¶ï¼Œäº‹ä»¶å¾ªç¯è¿‡ç¨‹ä¸­ï¼Œä¼šå‘è¿™äº›è§‚å¯Ÿè€…è¯¢é—®æœ‰æ²¡æœ‰è¯¥æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆè§‚å¯Ÿè€…ä¼šå–å‡ºä»»åŠ¡ï¼Œäº¤ç»™äº‹ä»¶å¾ªç¯å»æ‰§è¡Œã€‚

### è¯·æ±‚å¯¹è±¡ä¸çº¿ç¨‹æ± 

ä»Â `JavaScript`Â è°ƒç”¨åˆ°è®¡ç®—æœºç³»ç»Ÿæ‰§è¡Œå®Œ I/O å›è°ƒï¼Œ**è¯·æ±‚å¯¹è±¡**å……å½“ç€å¾ˆé‡è¦çš„ä½œç”¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸€æ¬¡å¼‚æ­¥ I/O æ“ä½œä¸ºä¾‹

**è¯·æ±‚å¯¹è±¡ï¼š**Â æ¯”å¦‚ä¹‹å‰è°ƒç”¨Â `fs.readFile`Â ï¼Œæœ¬è´¨ä¸Šè°ƒç”¨Â `libuv`Â ä¸Šçš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªè¯·æ±‚å¯¹è±¡ã€‚è¿™ä¸ªè¯·æ±‚å¯¹è±¡ä¸Šä¿ç•™ç€æ­¤æ¬¡ I/O è¯·æ±‚çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ­¤æ¬¡ I/O çš„ä¸»ä½“å’Œå›è°ƒå‡½æ•°ç­‰ã€‚ç„¶åå¼‚æ­¥è°ƒç”¨çš„ç¬¬ä¸€é˜¶æ®µå°±å®Œæˆäº†ï¼ŒJavaScript ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œæ‰§è¡Œæ ˆä¸Šçš„ä»£ç é€»è¾‘ï¼Œå½“å‰çš„ I/O æ“ä½œå°†ä»¥è¯·æ±‚å¯¹è±¡çš„å½¢å¼æ”¾å…¥åˆ°çº¿ç¨‹æ± ä¸­ï¼Œç­‰å¾…æ‰§è¡Œã€‚è¾¾åˆ°äº†å¼‚æ­¥ I/O çš„ç›®çš„ã€‚

**çº¿ç¨‹æ± ï¼š**Â Nodejs çš„çº¿ç¨‹æ± åœ¨ Windows ä¸‹æœ‰å†…æ ¸ï¼ˆ IOCP ï¼‰æä¾›ï¼Œåœ¨ Unix ç³»ç»Ÿä¸­ç”±Â `libuv`Â è‡ªè¡Œå®ç°ï¼Œ çº¿ç¨‹æ± ç”¨æ¥æ‰§è¡Œéƒ¨åˆ†çš„ I/O ï¼ˆç³»ç»Ÿæ–‡ä»¶çš„æ“ä½œï¼‰ï¼Œçº¿ç¨‹æ± å¤§å°é»˜è®¤ä¸º 4 ï¼Œå¤šä¸ªæ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„è¯·æ±‚å¯èƒ½é˜»å¡åˆ°ä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚é‚£ä¹ˆçº¿ç¨‹æ± é‡Œé¢çš„ I/O æ“ä½œæ˜¯æ€ä¹ˆæ‰§è¡Œçš„å‘¢ï¼Ÿä¸Šä¸€æ­¥è¯´åˆ°ï¼Œä¸€æ¬¡å¼‚æ­¥ I/O ä¼šæŠŠè¯·æ±‚å¯¹è±¡æ”¾åœ¨çº¿ç¨‹æ± ä¸­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ± æ˜¯å¦æœ‰å¯ç”¨çš„çº¿ç¨‹ï¼Œå¦‚æœçº¿ç¨‹å¯ç”¨ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œè¯·æ±‚å¯¹è±¡çš„ I/O æ“ä½œï¼Œå¹¶æŠŠæ‰§è¡Œåçš„ç»“æœè¿”å›ç»™è¯·æ±‚å¯¹è±¡ã€‚åœ¨äº‹ä»¶å¾ªç¯ä¸­çš„ I/O å¤„ç†é˜¶æ®µï¼ŒI/O è§‚å¯Ÿè€…ä¼šè·å–åˆ°å·²ç»å®Œæˆçš„ I/O å¯¹è±¡ï¼Œç„¶åå–å‡ºå›è°ƒå‡½æ•°å’Œç»“æœè°ƒç”¨æ‰§è¡Œã€‚**I/O å›è°ƒå‡½æ•°å°±è¿™æ ·æ‰§è¡Œï¼Œè€Œä¸”åœ¨å›è°ƒå‡½æ•°çš„å‚æ•°é‡è·å–åˆ°ç»“æœã€‚**

### å¼‚æ­¥ I/O æ“ä½œæœºåˆ¶

ä¸Šè¿°è®²äº†æ•´ä¸ªå¼‚æ­¥ I/O çš„æ‰§è¡Œæµç¨‹ï¼Œä»ä¸€ä¸ªå¼‚æ­¥ I/O çš„è§¦å‘ï¼Œåˆ° I/O å›è°ƒåˆ°æ‰§è¡Œã€‚**äº‹ä»¶å¾ªç¯**Â ï¼Œ**è§‚å¯Ÿè€…**Â ï¼Œ**è¯·æ±‚å¯¹è±¡**Â ï¼Œ**çº¿ç¨‹æ± **Â æ„æˆäº†æ•´ä¸ªå¼‚æ­¥ I/O æ‰§è¡Œæ¨¡å‹ã€‚

ç”¨ä¸€å¹…å›¾è¡¨ç¤ºå››è€…çš„å…³ç³»ï¼š

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-3.jpg)

æ€»ç»“ä¸Šè¿°è¿‡ç¨‹ï¼š

- ç¬¬ä¸€é˜¶æ®µï¼šæ¯ä¸€æ¬¡**å¼‚æ­¥ I/O çš„è°ƒç”¨**ï¼Œé¦–å…ˆåœ¨ nodejs åº•å±‚è®¾ç½®è¯·æ±‚å‚æ•°å’Œå›è°ƒå‡½ callbackï¼Œå½¢æˆ**è¯·æ±‚å¯¹è±¡**ã€‚

- ç¬¬äºŒé˜¶æ®µï¼šå½¢æˆçš„è¯·æ±‚å¯¹è±¡ï¼Œä¼šè¢«æ”¾å…¥**çº¿ç¨‹æ± **ï¼Œå¦‚æœçº¿ç¨‹æ± æœ‰ç©ºé—²çš„ I/O çº¿ç¨‹ï¼Œä¼šæ‰§è¡Œæ­¤æ¬¡ I/O ä»»åŠ¡ï¼Œå¾—åˆ°ç»“æœã€‚

- ç¬¬ä¸‰é˜¶æ®µï¼š**äº‹ä»¶å¾ªç¯**ä¸­Â **I/O è§‚å¯Ÿè€…**ï¼Œä¼šä»è¯·æ±‚å¯¹è±¡ä¸­æ‰¾åˆ°å·²ç»å¾—åˆ°ç»“æœçš„ I/O è¯·æ±‚å¯¹è±¡ï¼Œå–å‡ºç»“æœå’Œå›è°ƒå‡½æ•°ï¼Œå°†å›è°ƒå‡½æ•°æ”¾å…¥äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ‰§è¡Œå›è°ƒï¼Œå®Œæˆæ•´ä¸ªå¼‚æ­¥ I/O ä»»åŠ¡ã€‚

- å¯¹äºå¦‚ä½•æ„ŸçŸ¥å¼‚æ­¥ I/O ä»»åŠ¡æ‰§è¡Œå®Œæ¯•çš„ï¼Ÿä»¥åŠå¦‚ä½•è·å–å®Œæˆçš„ä»»åŠ¡çš„å‘¢ï¼Ÿlibuv ä½œä¸ºä¸­é—´å±‚ï¼Œ åœ¨ä¸åŒå¹³å°ä¸Šï¼Œé‡‡ç”¨æ‰‹æ®µä¸åŒï¼Œåœ¨ unix ä¸‹é€šè¿‡ epoll è½®è¯¢ï¼Œåœ¨ Windows ä¸‹é€šè¿‡å†…æ ¸ï¼ˆ IOCP ï¼‰æ¥å®ç° ï¼ŒFreeBSD ä¸‹é€šè¿‡ kqueue å®ç°ã€‚

## äº‹ä»¶å¾ªç¯

> äº‹ä»¶å¾ªç¯æœºåˆ¶ç”±å®¿ä¸»ç¯å¢ƒå®ç°

ä¸Šè¿°ä¸­å·²ç»æåŠäº†äº‹ä»¶å¾ªç¯ä¸æ˜¯ JavaScript å¼•æ“çš„ä¸€éƒ¨åˆ† ï¼Œäº‹ä»¶å¾ªç¯æœºåˆ¶ç”±å®¿ä¸»ç¯å¢ƒå®ç°ï¼Œæ‰€ä»¥ä¸åŒå®¿ä¸»ç¯å¢ƒä¸‹äº‹ä»¶å¾ªç¯ä¸åŒ ï¼Œä¸åŒå®¿ä¸»ç¯å¢ƒæŒ‡çš„æ˜¯æµè§ˆå™¨ç¯å¢ƒè¿˜æ˜¯ nodejs ç¯å¢ƒ ï¼Œä½†åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸­ï¼Œnodejs çš„å®¿ä¸»ç¯å¢ƒä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæ¥ä¸‹æ¥ç”¨ä¸€å¹…å›¾æè¿°ä¸€ä¸‹ Nodejs ä¸­çš„äº‹ä»¶å¾ªç¯å’Œ javascript å¼•æ“ä¹‹é—´çš„å…³ç³»ã€‚

ä»¥ libuv ä¸‹ nodejs çš„äº‹ä»¶å¾ªç¯ä¸ºå‚è€ƒï¼Œå…³ç³»å¦‚ä¸‹ï¼š

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-4.jpg)

ä»¥æµè§ˆå™¨ä¸‹ javaScript çš„äº‹ä»¶å¾ªç¯ä¸ºå‚è€ƒï¼Œå…³ç³»å¦‚ä¸‹ï¼š

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-5.jpg)

äº‹ä»¶å¾ªç¯æœ¬è´¨ä¸Šå°±åƒä¸€ä¸ª while å¾ªç¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘æ¥ç”¨ä¸€æ®µä»£ç æ¨¡æ‹Ÿäº‹ä»¶å¾ªç¯çš„æ‰§è¡Œæµç¨‹ã€‚

```js
const queue = [ ... ]   // queue é‡Œé¢æ”¾ç€å¾…å¤„ç†äº‹ä»¶
while(true){
    //å¼€å§‹å¾ªç¯
    //æ‰§è¡Œ queue ä¸­çš„ä»»åŠ¡
    //....

    if(queue.length ===0){
       return // é€€å‡ºè¿›ç¨‹
    }
}
```

- Nodejs å¯åŠ¨åï¼Œå°±åƒåˆ›å»ºä¸€ä¸ª while å¾ªç¯ä¸€æ ·ï¼Œ`queue`Â é‡Œé¢æ”¾ç€å¾…å¤„ç†çš„äº‹ä»¶ï¼Œæ¯ä¸€æ¬¡å¾ªç¯è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿˜æœ‰äº‹ä»¶ï¼Œé‚£ä¹ˆå–å‡ºäº‹ä»¶ï¼Œæ‰§è¡Œäº‹ä»¶ï¼Œå¦‚æœå­˜åœ¨äº‹ä»¶å…³è”çš„å›è°ƒå‡½æ•°ï¼Œé‚£ä¹ˆæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œç„¶åå¼€å§‹ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚

- å¦‚æœå¾ªç¯ä½“ä¸­æ²¡æœ‰äº‹ä»¶ï¼Œé‚£ä¹ˆå°†é€€å‡ºè¿›ç¨‹ã€‚

æˆ‘æ€»ç»“äº†æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![](../../\imgs\nodejs-io-6.jpg)

é‚£ä¹ˆå¦‚ä½•äº‹ä»¶å¾ªç¯æ˜¯å¦‚ä½•å¤„ç†è¿™äº›ä»»åŠ¡çš„å‘¢ï¼Ÿæˆ‘ä»¬åˆ—å‡º Nodejs ä¸­ä¸€äº›å¸¸ç”¨çš„äº‹ä»¶ä»»åŠ¡ï¼š

- `setTimeout`Â æˆ–Â `setInterval`Â å»¶æ—¶å™¨è®¡æ—¶å™¨ã€‚

- å¼‚æ­¥ I/O ä»»åŠ¡ï¼šæ–‡ä»¶ä»»åŠ¡ ï¼Œç½‘ç»œè¯·æ±‚ç­‰ã€‚

- `setImmediate`Â ä»»åŠ¡ã€‚

- `process.nextTick`Â ä»»åŠ¡ã€‚

- `Promise`Â å¾®ä»»åŠ¡ã€‚

æ¥ä¸‹æ¥ä¼šä¸€ä¸€è®²åˆ° ï¼Œè¿™äº›ä»»åŠ¡çš„åŸç†ä»¥åŠ nodejs æ˜¯å¦‚ä½•å¤„ç†è¿™äº›ä»»åŠ¡çš„ã€‚

### äº‹ä»¶å¾ªç¯é˜¶æ®µ

å¯¹äºä¸åŒçš„äº‹ä»¶ä»»åŠ¡ï¼Œä¼šåœ¨ä¸åŒçš„äº‹ä»¶å¾ªç¯é˜¶æ®µæ‰§è¡Œã€‚æ ¹æ® nodejs å®˜æ–¹æ–‡æ¡£ï¼Œåœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œnodejs ä¸­çš„äº‹ä»¶å¾ªç¯æ ¹æ®ä¸åŒçš„æ“ä½œç³»ç»Ÿå¯èƒ½å­˜åœ¨ç‰¹æ®Šçš„é˜¶æ®µï¼Œä½†æ€»ä½“æ˜¯å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 6 ä¸ªé˜¶æ®µ ï¼ˆä»£ç å—çš„å…­ä¸ªé˜¶æ®µï¼‰ ï¼š

```js
/*
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚     -> å®šæ—¶å™¨ï¼Œå»¶æ—¶å™¨çš„æ‰§è¡Œ    
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚     -> i/o
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚           check           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
*/
```

- ç¬¬ä¸€é˜¶æ®µï¼š**`timer`**Â ï¼Œtimer é˜¶æ®µä¸»è¦åšçš„äº‹æ˜¯ï¼Œæ‰§è¡ŒÂ `setTimeout`Â æˆ–Â `setInterval`Â æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚

- ç¬¬äºŒé˜¶æ®µï¼š**pending callback**Â ï¼Œå¤§éƒ¨åˆ† I/O å›è°ƒä»»åŠ¡éƒ½æ˜¯åœ¨ poll é˜¶æ®µæ‰§è¡Œçš„ï¼Œä½†æ˜¯ä¹Ÿä¼šå­˜åœ¨ä¸€äº›ä¸Šä¸€æ¬¡äº‹ä»¶å¾ªç¯é—ç•™çš„è¢«å»¶æ—¶çš„ I/O å›è°ƒå‡½æ•°ï¼Œé‚£ä¹ˆæ­¤é˜¶æ®µå°±æ˜¯ä¸ºäº†è°ƒç”¨ä¹‹å‰äº‹ä»¶å¾ªç¯å»¶è¿Ÿæ‰§è¡Œçš„ I/O å›è°ƒå‡½æ•°ã€‚

- ç¬¬ä¸‰é˜¶æ®µï¼š**idle prepare**Â é˜¶æ®µï¼Œä»…ç”¨äº nodejs å†…éƒ¨æ¨¡å—çš„ä½¿ç”¨ã€‚

- ç¬¬å››é˜¶æ®µï¼š**poll**Â è½®è¯¢é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µä¸»è¦åšä¸¤ä»¶äº‹ï¼Œä¸€è¿™ä¸ªé˜¶æ®µä¼šæ‰§è¡Œå¼‚æ­¥ I/O çš„å›è°ƒå‡½æ•°ï¼›äºŒ è®¡ç®—å½“å‰è½®è¯¢é˜¶æ®µé˜»å¡åç»­é˜¶æ®µçš„æ—¶é—´ã€‚

- ç¬¬äº”é˜¶æ®µï¼š**checké˜¶æ®µ**ï¼Œå½“ poll é˜¶æ®µå›è°ƒå‡½æ•°é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œå¼€å§‹è¿›å…¥ check é˜¶æ®µï¼Œä¸»è¦æ‰§è¡ŒÂ `setImmediate`Â å›è°ƒå‡½æ•°ã€‚

- ç¬¬å…­é˜¶æ®µï¼š**closeé˜¶æ®µ**ï¼Œæ‰§è¡Œæ³¨å†ŒÂ `close`Â äº‹ä»¶çš„å›è°ƒå‡½æ•°ã€‚

å¯¹äºæ¯ä¸€ä¸ªé˜¶æ®µçš„æ‰§è¡Œç‰¹ç‚¹å’Œå¯¹åº”çš„äº‹ä»¶ä»»åŠ¡ï¼Œæˆ‘æ¥ä¸‹æ¥ä¼šè¯¦ç»†å‰–æã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å…­ä¸ªé˜¶æ®µåœ¨åº•å±‚æºç ä¸­æ˜¯æ€ä¹ˆæ ·ä½“ç°çš„ã€‚

æˆ‘ä»¬çœ‹ä¸€ä¸‹Â `libuv`Â ä¸‹ nodejs çš„äº‹ä»¶å¾ªç¯çš„æºä»£ç ï¼ˆåœ¨Â `unix`Â å’ŒÂ `win`Â æœ‰ç‚¹å·®åˆ«ï¼Œä¸è¿‡ä¸å½±å“æµç¨‹ï¼Œè¿™é‡Œä»¥ unix ä¸ºä¾‹å­ã€‚ï¼‰ï¼š

> libuv/src/unix/core.c

```c
int uv_run(uv_loop_t* loop, uv_run_mode mode) {
  // çœå»ä¹‹å‰çš„æµç¨‹ã€‚
  while (r != 0 && loop->stop_flag == 0) {

    /* æ›´æ–°äº‹ä»¶å¾ªç¯çš„æ—¶é—´ */ 
    uv__update_time(loop);

    /*ç¬¬ä¸€é˜¶æ®µï¼štimer é˜¶æ®µæ‰§è¡Œ  */
    uv__run_timers(loop);

    /*ç¬¬äºŒé˜¶æ®µï¼špending é˜¶æ®µ */
    ran_pending = uv__run_pending(loop);

    /*ç¬¬ä¸‰é˜¶æ®µï¼šidle prepare é˜¶æ®µ */
    uv__run_idle(loop);
    uv__run_prepare(loop);

    timeout = 0;
    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)
     /* è®¡ç®— timeout æ—¶é—´  */
      timeout = uv_backend_timeout(loop);

    /* ç¬¬å››é˜¶æ®µï¼špoll é˜¶æ®µ */
    uv__io_poll(loop, timeout);

    /* ç¬¬äº”é˜¶æ®µï¼šcheck é˜¶æ®µ */
    uv__run_check(loop);
    /* ç¬¬å…­é˜¶æ®µï¼šclose é˜¶æ®µ  */
    uv__run_closing_handles(loop);
    /* åˆ¤æ–­å½“å‰çº¿ç¨‹è¿˜æœ‰ä»»åŠ¡ */ 
     r = uv__loop_alive(loop);

    /* çœå»ä¹‹åçš„æµç¨‹ */
  }
  return r;
}
```

- æˆ‘ä»¬çœ‹åˆ°å…­ä¸ªé˜¶æ®µæ˜¯æŒ‰åºæ‰§è¡Œçš„ï¼Œåªæœ‰å®Œæˆä¸Šä¸€é˜¶æ®µçš„ä»»åŠ¡ï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€é˜¶æ®µ

- å½“Â `uv__loop_alive`Â åˆ¤æ–­å½“å‰äº‹ä»¶å¾ªç¯æ²¡æœ‰ä»»åŠ¡ï¼Œé‚£ä¹ˆé€€å‡ºçº¿ç¨‹ã€‚

### ä»»åŠ¡é˜Ÿåˆ—

åœ¨æ•´ä¸ªäº‹ä»¶å¾ªç¯è¿‡ç¨‹ä¸­ï¼Œæœ‰å››ä¸ªé˜Ÿåˆ—ï¼ˆ**å®é™…çš„æ•°æ®ç»“æ„ä¸æ˜¯é˜Ÿåˆ—**ï¼‰æ˜¯åœ¨ libuv çš„äº‹ä»¶å¾ªç¯ä¸­è¿›è¡Œçš„ï¼Œè¿˜æœ‰ä¸¤ä¸ªé˜Ÿåˆ—æ˜¯åœ¨ nodejs ä¸­æ‰§è¡Œçš„åˆ†åˆ«æ˜¯Â **promise é˜Ÿåˆ—**Â å’ŒÂ **nextTick**Â é˜Ÿåˆ—ã€‚

> åœ¨ NodeJS ä¸­ä¸æ­¢ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸åŒç±»å‹çš„äº‹ä»¶åœ¨å®ƒä»¬è‡ªå·±çš„é˜Ÿåˆ—ä¸­å…¥é˜Ÿã€‚åœ¨å¤„ç†å®Œä¸€ä¸ªé˜¶æ®µåï¼Œç§»å‘ä¸‹ä¸€ä¸ªé˜¶æ®µä¹‹å‰ï¼Œäº‹ä»¶å¾ªç¯å°†ä¼šå¤„ç†ä¸¤ä¸ªä¸­é—´é˜Ÿåˆ—ï¼Œç›´åˆ°ä¸¤ä¸ªä¸­é—´é˜Ÿåˆ—ä¸ºç©ºã€‚

#### libuv å¤„ç†ä»»åŠ¡é˜Ÿåˆ—

äº‹ä»¶å¾ªç¯çš„æ¯ä¸€ä¸ªé˜¶æ®µï¼Œéƒ½ä¼šæ‰§è¡Œå¯¹åº”ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢çš„å†…å®¹ã€‚

- timer é˜Ÿåˆ—ï¼ˆÂ **PriorityQueue**Â ï¼‰ï¼šæœ¬è´¨ä¸Šçš„æ•°æ®ç»“æ„æ˜¯**äºŒå‰æœ€å°å †**ï¼ŒäºŒå‰æœ€å°å †çš„æ ¹èŠ‚ç‚¹è·å–æœ€è¿‘çš„æ—¶é—´çº¿ä¸Šçš„ timer å¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚

- I/O äº‹ä»¶é˜Ÿåˆ—ï¼šå­˜æ”¾ I/O ä»»åŠ¡ã€‚

- Immediate é˜Ÿåˆ—ï¼ˆÂ **ImmediateList**Â ï¼‰ï¼šå¤šä¸ª Immediate ï¼Œnode å±‚ç”¨é“¾è¡¨æ•°æ®ç»“æ„å‚¨å­˜ã€‚

- å…³é—­å›è°ƒäº‹ä»¶é˜Ÿåˆ—ï¼šæ”¾ç½®å¾… close çš„å›è°ƒå‡½æ•°ã€‚

#### é libuv ä¸­é—´é˜Ÿåˆ—

- **nextTick**Â é˜Ÿåˆ— ï¼šå­˜æ”¾ nextTick çš„å›è°ƒå‡½æ•°ã€‚è¿™ä¸ªæ˜¯åœ¨ nodejs ä¸­ç‰¹æœ‰çš„ã€‚

- **Microtasks**Â å¾®é˜Ÿåˆ— Promise ï¼šå­˜æ”¾ promise çš„å›è°ƒå‡½æ•°ã€‚

ä¸­é—´é˜Ÿåˆ—çš„æ‰§è¡Œç‰¹ç‚¹ï¼š

- é¦–å…ˆè¦æ˜ç™½ä¸¤ä¸ªä¸­é—´é˜Ÿåˆ—å¹¶éåœ¨ libuv ä¸­è¢«æ‰§è¡Œï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨ nodejs å±‚æ‰§è¡Œçš„ï¼Œåœ¨ libuv å±‚å¤„ç†æ¯ä¸€ä¸ªé˜¶æ®µçš„ä»»åŠ¡ä¹‹åï¼Œä¼šå’Œ node å±‚è¿›è¡Œé€šè®¯ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆå¤„ç†ä¸¤ä¸ªé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚

- nextTick ä»»åŠ¡çš„ä¼˜å…ˆçº§è¦å¤§äº Microtasks ä»»åŠ¡ä¸­çš„ Promise å›è°ƒã€‚ä¹Ÿå°±æ˜¯è¯´ node ä¼šé¦–å…ˆæ¸…ç©º nextTick ä¸­çš„ä»»åŠ¡ï¼Œç„¶åæ‰æ˜¯ Promise ä¸­çš„ä»»åŠ¡ã€‚ä¸ºäº†éªŒè¯è¿™ä¸ªç»“è®ºï¼Œä¾‹ä¸¾ä¸€ä¸ªæ‰“å°ç»“æœçš„é¢˜ç›®å¦‚ä¸‹ï¼š

```js
/* TODO: æ‰“å°é¡ºåº  */
setTimeout(()=>{
    console.log('setTimeout æ‰§è¡Œ')
},0)

const p = new Promise((resolve)=>{
     console.log('Promiseæ‰§è¡Œ')
     resolve()
})
p.then(()=>{
    console.log('Promise å›è°ƒæ‰§è¡Œ')
})

process.nextTick(()=>{
    console.log('nextTick æ‰§è¡Œ')
})
console.log('ä»£ç æ‰§è¡Œå®Œæ¯•')
```

å¦‚ä¸Šä»£ç å—ä¸­çš„ nodejs ä¸­çš„æ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ

æ•ˆæœï¼š

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-7.jpg)

æ‰“å°ç»“æœï¼šPromiseæ‰§è¡Œ -> ä»£ç æ‰§è¡Œå®Œæ¯• -> nextTick æ‰§è¡Œ -> Promise å›è°ƒæ‰§è¡Œ -> setTimeout æ‰§è¡Œ

è§£é‡Šï¼šå¾ˆå¥½ç†è§£ä¸ºä»€ä¹ˆè¿™ä¹ˆæ‰“å°ï¼Œåœ¨ä¸»ä»£ç äº‹ä»¶å¾ªç¯ä¸­ï¼Œ`Promiseæ‰§è¡Œ`Â å’ŒÂ `ä»£ç æ‰§è¡Œå®Œæ¯•`Â æœ€å…ˆè¢«æ‰“å°ï¼ŒnextTick è¢«æ”¾å…¥ nextTick é˜Ÿåˆ—ä¸­ï¼ŒPromise å›è°ƒæ”¾å…¥ Microtasks é˜Ÿåˆ—ä¸­ï¼ŒsetTimeout è¢«æ”¾å…¥ timer å †ä¸­ã€‚æ¥ä¸‹æ¥ä¸»å¾ªç¯å®Œæˆï¼Œå¼€å§‹æ¸…ç©ºä¸¤ä¸ªé˜Ÿåˆ—ä¸­çš„å†…å®¹ï¼Œé¦–å…ˆæ¸…ç©º nextTick é˜Ÿåˆ—ï¼Œ`nextTick æ‰§è¡Œ`Â è¢«æ‰“å°ï¼Œæ¥ä¸‹æ¥æ¸…ç©º Microtasks é˜Ÿåˆ—ï¼Œ`Promise å›è°ƒæ‰§è¡Œ`Â è¢«æ‰“å°ï¼Œæœ€åå†åˆ¤æ–­äº‹ä»¶å¾ªç¯ loop ä¸­è¿˜æœ‰ timer ä»»åŠ¡ï¼Œé‚£ä¹ˆå¼€å¯æ–°çš„äº‹ä»¶å¾ªç¯ ï¼Œé¦–å…ˆæ‰§è¡Œï¼Œtimer ä»»åŠ¡ï¼Œ`setTimeout æ‰§è¡Œ`è¢«æ‰“å°ã€‚æ•´ä¸ªæµç¨‹å®Œæ¯•ã€‚

- æ— è®ºæ˜¯ nextTick çš„ä»»åŠ¡ï¼Œè¿˜æ˜¯ promise ä¸­çš„ä»»åŠ¡ï¼ŒÂ **ä¸¤ä¸ªä»»åŠ¡ä¸­çš„ä»£ç ä¼šé˜»å¡äº‹ä»¶å¾ªç¯çš„æœ‰åºè¿›è¡Œ**ï¼Œå¯¼è‡´ I/O é¥¿æ­»çš„æƒ…å†µå‘ç”Ÿï¼Œæ‰€ä»¥éœ€è¦è°¨æ…å¤„ç†ä¸¤ä¸ªä»»åŠ¡ä¸­çš„é€»è¾‘ã€‚æ¯”å¦‚å¦‚ä¸‹ï¼š

```js
/* TODO: é˜»å¡ I/O æƒ…å†µ */
process.nextTick(()=>{
    const now = +new Date()
    /* é˜»å¡ä»£ç ä¸‰ç§’é’Ÿ */
    while( +new Date() < now + 3000 ){}
})

fs.readFile('./file.js',()=>{
    console.log('I/O: file ')
})

setTimeout(() => {
    console.log('setTimeout: ')
}, 0);
```

**æ•ˆæœï¼š**

![](../../\imgs\nodejs-io-8.gif)

- ä¸‰ç§’é’Ÿï¼Œ äº‹ä»¶å¾ªç¯ä¸­çš„ timer ä»»åŠ¡å’Œ I/O ä»»åŠ¡ï¼Œæ‰è¢«æœ‰åºæ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ `nextTick` ä¸­çš„ä»£ç ï¼Œé˜»å¡äº†äº‹ä»¶å¾ªç¯çš„æœ‰åºè¿›è¡Œã€‚

### äº‹ä»¶å¾ªç¯æµç¨‹å›¾

æ¥ä¸‹æ¥ç”¨æµç¨‹å›¾ï¼Œè¡¨ç¤ºäº‹ä»¶å¾ªç¯çš„å…­å¤§é˜¶æ®µçš„æ‰§è¡Œé¡ºåºï¼Œä»¥åŠä¸¤ä¸ªä¼˜å…ˆé˜Ÿåˆ—çš„æ‰§è¡Œé€»è¾‘ã€‚

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-9.jpg)

### timer é˜¶æ®µ -> Â è®¡æ—¶å™¨ timer / å»¶æ—¶å™¨ interval

**å»¶æ—¶å™¨è®¡æ—¶å™¨è§‚å¯Ÿè€…ï¼ˆExpired timers and intervalsï¼‰**ï¼šå»¶æ—¶å™¨è®¡æ—¶å™¨è§‚å¯Ÿè€…ç”¨æ¥æ£€æŸ¥é€šè¿‡Â `setTimeout`Â æˆ–Â `setInterval`åˆ›å»ºçš„å¼‚æ­¥ä»»åŠ¡ï¼Œå†…éƒ¨åŸç†å’Œå¼‚æ­¥ I/O ç›¸ä¼¼ï¼Œä¸è¿‡å®šæœŸå™¨/å»¶æ—¶å™¨å†…éƒ¨å®ç°æ²¡æœ‰ç”¨çº¿ç¨‹æ± ã€‚é€šè¿‡`setTimeout`Â æˆ–Â `setInterval`å®šæ—¶å™¨å¯¹è±¡ä¼šè¢«æ’å…¥åˆ°å»¶æ—¶å™¨è®¡æ—¶å™¨è§‚å¯Ÿè€…å†…éƒ¨çš„äºŒå‰æœ€å°å †ä¸­ï¼Œæ¯æ¬¡äº‹ä»¶å¾ªç¯è¿‡ç¨‹ä¸­ï¼Œä¼šä»äºŒå‰æœ€å°å †é¡¶éƒ¨å–å‡ºè®¡æ—¶å™¨å¯¹è±¡ï¼Œåˆ¤æ–­ timer/interval æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœæœ‰ï¼Œç„¶åè°ƒç”¨å®ƒï¼Œå‡ºé˜Ÿã€‚å†æ£€æŸ¥å½“å‰é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªï¼Œç›´åˆ°æ²¡æœ‰è¿‡æœŸçš„ï¼Œç§»åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚

#### libuv å±‚å¦‚ä½•å¤„ç† timer

é¦–å…ˆä¸€èµ·çœ‹ä¸€ä¸‹ libuv å±‚æ˜¯å¦‚ä½•å¤„ç†çš„ timer

> libuv/src/timer.c

```c
void uv__run_timers(uv_loop_t* loop) {
  struct heap_node* heap_node;
  uv_timer_t* handle;

  for (;;) {
    /* æ‰¾åˆ° loop ä¸­ timer_heap ä¸­çš„æ ¹èŠ‚ç‚¹ ï¼ˆ å€¼æœ€å° ï¼‰ */  
    heap_node = heap_min((struct heap*) &loop->timer_heap);
    /*  */
    if (heap_node == NULL)
      break;

    handle = container_of(heap_node, uv_timer_t, heap_node);
    if (handle->timeout > loop->time)
      /*  æ‰§è¡Œæ—¶é—´å¤§äºäº‹ä»¶å¾ªç¯äº‹ä»¶ï¼Œé‚£ä¹ˆä¸éœ€è¦åœ¨æ­¤æ¬¡ loop ä¸­æ‰§è¡Œ  */
      break;

    uv_timer_stop(handle);
    uv_timer_again(handle);
    handle->timer_cb(handle);
  }
}
```

- å¦‚ä¸Š handle timeout å¯ä»¥ç†è§£æˆè¿‡æœŸæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è®¡æ—¶å™¨å›åˆ°å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ã€‚

- å½“ timeout å¤§äºå½“å‰äº‹ä»¶å¾ªç¯çš„å¼€å§‹æ—¶é—´æ—¶ï¼Œå³è¡¨ç¤ºè¿˜æ²¡æœ‰åˆ°æ‰§è¡Œæ—¶æœºï¼Œå›è°ƒå‡½æ•°è¿˜ä¸åº”è¯¥è¢«æ‰§è¡Œã€‚é‚£ä¹ˆæ ¹æ®äºŒå‰æœ€å°å †çš„æ€§è´¨ï¼Œçˆ¶èŠ‚ç‚¹å§‹ç»ˆæ¯”å­èŠ‚ç‚¹å°ï¼Œé‚£ä¹ˆæ ¹èŠ‚ç‚¹çš„æ—¶é—´èŠ‚ç‚¹éƒ½ä¸æ»¡è¶³æ‰§è¡Œæ—¶æœºçš„è¯ï¼Œå…¶ä»–çš„ timer ä¹Ÿä¸æ»¡è¶³æ‰§è¡Œæ—¶é—´ã€‚æ­¤æ—¶ï¼Œé€€å‡º timer é˜¶æ®µçš„å›è°ƒå‡½æ•°æ‰§è¡Œï¼Œç›´æ¥è¿›å…¥äº‹ä»¶å¾ªç¯ä¸‹ä¸€é˜¶æ®µã€‚

- å½“è¿‡æœŸæ—¶é—´å°äºå½“å‰äº‹ä»¶å¾ªç¯ tick çš„å¼€å§‹æ—¶é—´æ—¶ï¼Œè¡¨ç¤ºè‡³å°‘å­˜åœ¨ä¸€ä¸ªè¿‡æœŸçš„è®¡æ—¶å™¨ï¼Œé‚£ä¹ˆå¾ªç¯è¿­ä»£è®¡æ—¶å™¨æœ€å°å †çš„æ ¹èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨è¯¥è®¡æ—¶å™¨æ‰€å¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚æ¯æ¬¡å¾ªç¯è¿­ä»£æ—¶éƒ½ä¼šæ›´æ–°æœ€å°å †çš„æ ¹èŠ‚ç‚¹ä¸ºæœ€è¿‘æ—¶é—´èŠ‚ç‚¹çš„è®¡æ—¶å™¨ã€‚

å¦‚ä¸Šæ˜¯ timer é˜¶æ®µåœ¨ libuv ä¸­æ‰§è¡Œç‰¹ç‚¹ã€‚æ¥ä¸‹é‡Œåˆ†æä¸€ä¸‹ node ä¸­æ˜¯å¦‚ä½•å¤„ç†å®šæ—¶å™¨å»¶æ—¶å™¨çš„ã€‚

#### node å±‚å¦‚ä½•å¤„ç† timer

åœ¨ Nodejs ä¸­Â `setTimeout`Â å’ŒÂ `setInterval`Â æ˜¯ nodejs è‡ªå·±å®ç°çš„ï¼Œæ¥ä¸€èµ·çœ‹ä¸€ä¸‹å®ç°ç»†èŠ‚ï¼š

> node/lib/timers.js

```js
function setTimeout(callbackï¼Œafter){
    //...
    /* åˆ¤æ–­å‚æ•°é€»è¾‘ */
    //..
    /* åˆ›å»ºä¸€ä¸ª timer è§‚å¯Ÿè€… */
    const timeout = new Timeout(callback, after, args, false, true);
    /* å°† timer è§‚å¯Ÿè€…æ’å…¥åˆ° timer å †ä¸­  */
    insert(timeout, timeout._idleTimeout);

    return timeout;
}
```

- setTimeoutï¼šé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª timer æ—¶é—´è§‚å¯Ÿè€…ï¼Œç„¶åæ”¾å…¥è®¡æ—¶å™¨å †ä¸­ã€‚

é‚£ä¹ˆ Timeout åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ

> node/lib/internal/timers.js

```js
function Timeout(callback, after, args, isRepeat, isRefed) {
  after *= 1 
  if (!(after >= 1 && after <= 2 ** 31 - 1)) {
    after = 1 // å¦‚æœå»¶æ—¶å™¨ timeout ä¸º 0 ï¼Œæˆ–è€…æ˜¯å¤§äº 2 ** 31 - 1 ï¼Œé‚£ä¹ˆè®¾ç½®æˆ 1 
  }
  this._idleTimeout = after; // å»¶æ—¶æ—¶é—´ 
  this._idlePrev = this;
  this._idleNext = this;
  this._idleStart = null;
  this._onTimeout = null;
  this._onTimeout = callback; // å›è°ƒå‡½æ•°
  this._timerArgs = args;
  this._repeat = isRepeat ? after : null;
  this._destroyed = false;  

  initAsyncResource(this, 'Timeout');
}
```

- åœ¨ nodejs ä¸­æ— è®º setTimeout è¿˜æ˜¯ setInterval æœ¬è´¨ä¸Šéƒ½æ˜¯ Timeout ç±»ã€‚è¶…å‡ºæœ€å¤§æ—¶é—´é˜€Â `2 ** 31 - 1`Â æˆ–è€…Â `setTimeout(callback, 0)`Â ï¼Œ_idleTimeout ä¼šè¢«è®¾ç½®æˆ 1 ï¼Œè½¬æ¢ä¸º setTimeout(callback, 1) æ¥æ‰§è¡Œã€‚

#### timer å¤„ç†æµç¨‹å›¾

ç”¨ä¸€å‰¯æµç¨‹å›¾æè¿°ä¸€ä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª timer ï¼Œå†åˆ° timer åœ¨äº‹ä»¶å¾ªç¯é‡Œé¢æ‰§è¡Œçš„æµç¨‹ã€‚

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-10.jpg)

#### timer ç‰¹æ€§

è¿™é‡Œæœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š

- **æ‰§è¡Œæœºåˆ¶**Â ï¼šå»¶æ—¶å™¨è®¡æ—¶å™¨è§‚å¯Ÿè€…ï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šæ‰§è¡Œä¸€ä¸ªï¼Œæ‰§è¡Œä¸€ä¸ªä¹‹åä¼šæ¸…ç©º nextTick å’Œ Promiseï¼Œ è¿‡æœŸæ—¶é—´æ˜¯å†³å®šä¸¤è€…æ˜¯å¦æ‰§è¡Œçš„é‡è¦å› ç´ ï¼Œè¿˜æœ‰ä¸€ç‚¹ poll ä¼šè®¡ç®—é˜»å¡ timer æ‰§è¡Œçš„æ—¶é—´ï¼Œå¯¹ timer é˜¶æ®µä»»åŠ¡çš„æ‰§è¡Œä¹Ÿæœ‰å¾ˆé‡è¦çš„å½±å“ã€‚

éªŒè¯ç»“è®ºä¸€æ¬¡æ‰§è¡Œä¸€ä¸ª timer ä»»åŠ¡ ï¼Œå…ˆæ¥çœ‹ä¸€æ®µä»£ç ç‰‡æ®µï¼š

```js
setTimeout(()=>{
    console.log('setTimeout1:')
    process.nextTick(()=>{
        console.log('nextTick')
    })
},0)
setTimeout(()=>{
    console.log('setTimeout2:')
},0)
```

æ‰“å°ç»“æœï¼š

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-11.jpg)

nextTick é˜Ÿåˆ—æ˜¯åœ¨äº‹ä»¶å¾ªç¯çš„æ¯ä¸€é˜¶æ®µç»“æŸæ‰§è¡Œçš„ï¼Œä¸¤ä¸ªå»¶æ—¶å™¨çš„é˜€å€¼éƒ½æ˜¯ 0 ï¼Œå¦‚æœåœ¨ timer é˜¶æ®µä¸€æ¬¡æ€§æ‰§è¡Œå®Œï¼Œè¿‡æœŸä»»åŠ¡çš„è¯ï¼Œé‚£ä¹ˆæ‰“å° setTimeout1 Â -> setTimeout2 -> nextTick ï¼Œå®é™…ä¸Šå…ˆæ‰§è¡Œä¸€ä¸ª timer ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œ nextTick ä»»åŠ¡ï¼Œæœ€åå†æ‰§è¡Œä¸‹ä¸€ä¸ª timer ä»»åŠ¡ã€‚

- **ç²¾åº¦é—®é¢˜**Â ï¼šå…³äº setTimeout çš„è®¡æ•°å™¨é—®é¢˜ï¼Œè®¡æ—¶å™¨å¹¶éç²¾ç¡®çš„ï¼Œå°½ç®¡åœ¨ nodejs çš„äº‹ä»¶å¾ªç¯éå¸¸çš„å¿«ï¼Œä½†æ˜¯ä»å»¶æ—¶å™¨ timeout ç±»çš„åˆ›å»ºï¼Œä¼šå ç”¨ä¸€äº›äº‹ä»¶ï¼Œå†åˆ°ä¸Šä¸‹æ–‡æ‰§è¡Œï¼Œ I/O çš„æ‰§è¡Œï¼ŒnextTick é˜Ÿåˆ—æ‰§è¡Œï¼ŒMicrotasks æ‰§è¡Œï¼Œéƒ½ä¼šé˜»å¡å»¶æ—¶å™¨çš„æ‰§è¡Œã€‚ç”šè‡³åœ¨æ£€æŸ¥ timer è¿‡æœŸçš„æ—¶å€™ï¼Œä¹Ÿä¼šæ¶ˆè€—ä¸€äº› cpu æ—¶é—´ã€‚

- **æ€§èƒ½é—®é¢˜**Â ï¼šå¦‚æœæƒ³ç”¨ setTimeout(fn,0) æ¥æ‰§è¡Œä¸€äº›éç«‹å³è°ƒç”¨çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆæ€§èƒ½ä¸Šä¸å¦‚Â `process.nextTick`Â å®åœ¨ï¼Œé¦–å…ˆ setTimeout ç²¾åº¦ä¸å¤Ÿï¼Œè¿˜æœ‰ä¸€ç‚¹å°±æ˜¯é‡Œé¢æœ‰å®šæ—¶å™¨å¯¹è±¡ï¼Œå¹¶éœ€è¦åœ¨ libuv åº•å±‚æ‰§è¡Œï¼Œå ç”¨ä¸€å®šæ€§èƒ½ï¼Œæ‰€ä»¥å¯ä»¥ç”¨Â `process.nextTick`Â è§£å†³è¿™ç§åœºæ™¯ã€‚

### pending é˜¶æ®µ

pending é˜¶æ®µç”¨æ¥å¤„ç†æ­¤æ¬¡äº‹ä»¶å¾ªç¯ä¹‹å‰å»¶æ—¶çš„ I/O å›è°ƒå‡½æ•°ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹åœ¨ libuv ä¸­æ‰§è¡Œæ—¶æœºã€‚

> libuv/src/unix/core.c

```c
static int uv__run_pending(uv_loop_t* loop) {
  QUEUE* q;
  QUEUE pq;
  uv__io_t* w
  /* pending_queue ä¸ºç©ºï¼Œæ¸…ç©ºé˜Ÿåˆ— ï¼Œè¿”å› 0  */
  if (QUEUE_EMPTY(&loop->pending_queue))
    return 0;

  QUEUE_MOVE(&loop->pending_queue, &pq);
  while (!QUEUE_EMPTY(&pq)) { /* pending_queue ä¸ä¸ºç©ºçš„æƒ…å†µï¼Œæ¸…ç©º I/O å›è°ƒã€‚è¿”å› 1  */
    q = QUEUE_HEAD(&pq);
    QUEUE_REMOVE(q);
    QUEUE_INIT(q);
    w = QUEUE_DATA(q, uv__io_t, pending_queue);
    w->cb(loop, w, POLLOUT);
  }
  return 1;
}
```

- å¦‚æœå­˜æ”¾ I/O å›è°ƒçš„ä»»åŠ¡çš„Â `pending_queue`Â æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› 0ã€‚

- å¦‚æœ pending_queue æœ‰ I/O å›è°ƒä»»åŠ¡ï¼Œé‚£ä¹ˆæ‰§è¡Œå›è°ƒä»»åŠ¡ã€‚

### idle, prepare Â é˜¶æ®µ

`idle`Â åšä¸€äº› libuv ä¸€äº›å†…éƒ¨æ“ä½œï¼ŒÂ `prepare`Â ä¸ºæ¥ä¸‹æ¥çš„ I/O è½®è¯¢åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚æ¥ä¸‹æ¥ä¸€èµ·è§£æä¸€ä¸‹æ¯”è¾ƒé‡è¦Â `poll`Â é˜¶æ®µã€‚

### poll I / O è½®è¯¢é˜¶æ®µ

åœ¨æ­£å¼è®²è§£ poll é˜¶æ®µåšå“ªäº›äº‹æƒ…ä¹‹å‰ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹ï¼Œåœ¨ libuv ä¸­ï¼Œè½®è¯¢é˜¶æ®µçš„æ‰§è¡Œé€»è¾‘ï¼š

```c
 timeout = 0;
    if ((mode == UV_RUN_ONCE && !ran_pending) || mode == UV_RUN_DEFAULT)
      /* è®¡ç®— timeout   */
      timeout = uv_backend_timeout(loop);
      /* è¿›å…¥ I/O è½®è¯¢ */
      uv__io_poll(loop, timeout);
```

- åˆå§‹åŒ–è¶…æ—¶æ—¶é—´ timeout = 0 ï¼Œé€šè¿‡Â `uv_backend_timeout`Â è®¡ç®—æœ¬æ¬¡Â `poll`Â é˜¶æ®µçš„è¶…æ—¶æ—¶é—´ã€‚è¶…æ—¶æ—¶é—´ä¼šå½±å“åˆ°å¼‚æ­¥ I/O å’Œåç»­äº‹ä»¶å¾ªç¯çš„æ‰§è¡Œã€‚

**timeoutä»£è¡¨ä»€ä¹ˆ**

é¦–å…ˆè¦æ˜ç™½ä¸åŒ timeout ï¼Œåœ¨ I/O è½®è¯¢ä¸­ä»£è¡¨ä»€ä¹ˆæ„æ€ã€‚

- å½“Â `timeout = 0`Â çš„æ—¶å€™ï¼Œè¯´æ˜ poll é˜¶æ®µä¸ä¼šé˜»å¡äº‹ä»¶å¾ªç¯çš„è¿›è¡Œï¼Œé‚£ä¹ˆè¯´æ˜æœ‰æ›´è¿«åˆ‡æ‰§è¡Œçš„ä»»åŠ¡ã€‚é‚£ä¹ˆå½“å‰çš„ poll é˜¶æ®µä¸ä¼šå‘ç”Ÿé˜»å¡ï¼Œä¼šå°½å¿«è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼Œå°½å¿«ç»“æŸå½“å‰ tickï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ï¼Œé‚£ä¹ˆè¿™äº›**ç´§æ€¥**ä»»åŠ¡å°†è¢«æ‰§è¡Œã€‚

- å½“Â `timeout = -1`æ—¶ï¼Œè¯´æ˜ä¼šä¸€ç›´é˜»å¡äº‹ä»¶å¾ªç¯ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥åœç•™åœ¨å¼‚æ­¥ I/O çš„ poll é˜¶æ®µï¼Œç­‰å¾…æ–°çš„ I/O ä»»åŠ¡å®Œæˆã€‚

- å½“Â `timeout`ç­‰äºå¸¸æ•°çš„æƒ…å†µï¼Œè¯´æ˜æ­¤æ—¶ io poll å¾ªç¯é˜¶æ®µèƒ½å¤Ÿåœç•™çš„æ—¶é—´ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šå­˜åœ¨ timeout ä¸ºå¸¸æ•°å‘¢ï¼Œå°†é©¬ä¸Šæ­æ™“ã€‚

**è·å–timeout**

timeout çš„è·å–æ˜¯é€šè¿‡ uv_backend_timeout é‚£ä¹ˆå¦‚ä½•è·å¾—çš„å‘¢ï¼Ÿ

```c
int uv_backend_timeout(const uv_loop_t* loop) {
    /* å½“å‰äº‹ä»¶å¾ªç¯ä»»åŠ¡åœæ­¢ ï¼Œä¸é˜»å¡ */
  if (loop->stop_flag != 0)
    return 0;
   /* å½“å‰äº‹ä»¶å¾ªç¯ loop ä¸æ´»è·ƒçš„æ—¶å€™ ï¼Œä¸é˜»å¡ */
  if (!uv__has_active_handles(loop) && !uv__has_active_reqs(loop))
    return 0;
  /* å½“ idle å¥æŸ„é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼Œè¿”å› 0ï¼Œå³ä¸é˜»å¡ã€‚ */
  if (!QUEUE_EMPTY(&loop->idle_handles))
    return 0;
   /* i/o pending é˜Ÿåˆ—ä¸ä¸ºç©ºçš„æ—¶å€™ã€‚ */  
  if (!QUEUE_EMPTY(&loop->pending_queue))
    return 0;
   /* æœ‰å…³é—­å›è°ƒ */
  if (loop->closing_handles)
    return 0;
  /* è®¡ç®—æœ‰æ²¡æœ‰å»¶æ—¶æœ€å°çš„å»¶æ—¶å™¨ ï½œ å®šæ—¶å™¨ */
  return uv__next_timeout(loop);
}
```

uv_backend_timeout ä¸»è¦åšçš„äº‹æƒ…æ˜¯ï¼š

- å½“å‰äº‹ä»¶å¾ªç¯åœæ­¢æ—¶ï¼Œä¸é˜»å¡ã€‚

- å½“å‰äº‹ä»¶å¾ªç¯ loop ä¸æ´»è·ƒçš„æ—¶å€™ ï¼Œä¸é˜»å¡ã€‚

- å½“ idle é˜Ÿåˆ— ï¼ˆ setImmediate ï¼‰ ä¸ä¸ºç©ºæ—¶ï¼Œè¿”å› 0ï¼Œä¸é˜»å¡ã€‚

- i/o pending é˜Ÿåˆ—ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œä¸é˜»å¡ã€‚

- æœ‰å…³é—­å›è°ƒå‡½æ•°çš„æ—¶å€™ï¼Œä¸é˜»å¡ã€‚

- å¦‚æœä¸Šè¿°å‡ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆé€šè¿‡Â `uv__next_timeout`Â è®¡ç®—æœ‰æ²¡æœ‰å»¶æ—¶é˜€å€¼æœ€å°çš„å®šæ—¶å™¨ ï½œ å»¶æ—¶å™¨ï¼ˆ æœ€æ€¥è¿«æ‰§è¡Œ ï¼‰ï¼Œè¿”å›å»¶æ—¶æ—¶é—´ã€‚

æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹Â `uv__next_timeout`Â é€»è¾‘ã€‚

```c
int uv__next_timeout(const uv_loop_t* loop) {
  const struct heap_node* heap_node;
  const uv_timer_t* handle;
  uint64_t diff;
  /* æ‰¾åˆ°å»¶æ—¶æ—¶é—´æœ€å°çš„ timer  */
  heap_node = heap_min((const struct heap*) &loop->timer_heap);
  if (heap_node == NULL) /* å¦‚ä½•æ²¡æœ‰ timerï¼Œé‚£ä¹ˆè¿”å› -1 ï¼Œä¸€ç›´è¿›å…¥ poll çŠ¶æ€  */
    return -1; 

  handle = container_of(heap_node, uv_timer_t, heap_node);
   /* æœ‰è¿‡æœŸçš„ timer ä»»åŠ¡ï¼Œé‚£ä¹ˆè¿”å› 0ï¼Œpoll é˜¶æ®µä¸é˜»å¡ */
  if (handle->timeout <= loop->time)
    return 0;
  /* è¿”å›å½“å‰æœ€å°é˜€å€¼çš„ timer ä¸ å½“å‰äº‹ä»¶å¾ªç¯çš„äº‹ä»¶ç›¸å‡ï¼Œå¾—å‡ºæ¥çš„æ—¶é—´ï¼Œå¯ä»¥è¯æ˜ poll å¯ä»¥åœç•™å¤šé•¿æ—¶é—´ */ 
  diff = handle->timeout - loop->time;
  return (int) diff;
}
```

`uv__next_timeout`Â åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š

- æ‰¾åˆ°æ—¶é—´é˜€å€¼æœ€å°çš„ timer ï¼ˆæœ€ä¼˜å…ˆæ‰§è¡Œçš„ï¼‰ï¼Œå¦‚ä½•æ²¡æœ‰ timerï¼Œé‚£ä¹ˆè¿”å› -1 ã€‚poll é˜¶æ®µå°†**æ— é™åˆ¶é˜»å¡**ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ä¸€æ—¦æœ‰ I/O æ‰§è¡Œå®Œæ¯• ï¼ŒI/O å›è°ƒå‡½æ•°ä¼šç›´æ¥åŠ å…¥åˆ° poll ï¼Œæ¥ä¸‹æ¥å°±ä¼šæ‰§è¡Œå¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚

- å¦‚æœæœ‰ timer ï¼Œä½†æ˜¯Â `timeout <= loop.time`Â è¯æ˜å·²ç»è¿‡æœŸäº†ï¼Œé‚£ä¹ˆè¿”å› 0ï¼Œpoll é˜¶æ®µä¸é˜»å¡ï¼Œä¼˜å…ˆæ‰§è¡Œè¿‡æœŸä»»åŠ¡ã€‚

- å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œè¿”å›å½“å‰æœ€å°é˜€å€¼çš„ timer ä¸ å½“å‰äº‹ä»¶å¾ªç¯çš„äº‹ä»¶ç›¸å‡å¾—å€¼ï¼Œå³æ˜¯å¯ä»¥è¯æ˜ poll å¯ä»¥åœç•™å¤šé•¿æ—¶é—´ã€‚å½“åœç•™å®Œæ¯•ï¼Œè¯æ˜æœ‰è¿‡æœŸ timer ï¼Œé‚£ä¹ˆè¿›å…¥åˆ°ä¸‹ä¸€ä¸ª tickã€‚

**æ‰§è¡Œio_poll**

æ¥ä¸‹æ¥å°±æ˜¯Â `uv__io_poll`Â çœŸæ­£çš„æ‰§è¡Œï¼Œé‡Œé¢æœ‰ä¸€ä¸ªÂ `epoll_wait`Â æ–¹æ³•ï¼Œæ ¹æ® timeout ï¼Œæ¥è½®è¯¢æœ‰æ²¡æœ‰ I/O å®Œæˆï¼Œæœ‰å¾—è¯é‚£ä¹ˆæ‰§è¡Œ I/O å›è°ƒã€‚è¿™ä¹Ÿæ˜¯ unix ä¸‹å¼‚æ­¥I/O å®ç°çš„é‡è¦ç¯èŠ‚ã€‚

**pollé˜¶æ®µæœ¬è´¨**

æ¥ä¸‹æ¥æ€»ç»“ä¸€ä¸‹ poll é˜¶æ®µçš„æœ¬è´¨ï¼š

- poll é˜¶æ®µå°±æ˜¯é€šè¿‡ timeout æ¥åˆ¤æ–­ï¼Œæ˜¯å¦é˜»å¡äº‹ä»¶å¾ªç¯ã€‚poll ä¹Ÿæ˜¯ä¸€ç§è½®è¯¢ï¼Œè½®è¯¢çš„æ˜¯ i/o ä»»åŠ¡ï¼Œäº‹ä»¶å¾ªç¯å€¾å‘äº poll é˜¶æ®µçš„æŒç»­è¿›è¡Œï¼Œå…¶ç›®çš„å°±æ˜¯æ›´å¿«çš„æ‰§è¡Œ I/O ä»»åŠ¡ã€‚å¦‚æœæ²¡æœ‰å…¶ä»–ä»»åŠ¡ï¼Œé‚£ä¹ˆå°†ä¸€ç›´å¤„äº poll é˜¶æ®µã€‚

- å¦‚æœæœ‰å…¶ä»–é˜¶æ®µæ›´ç´§æ€¥å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¯”å¦‚ timer ï¼Œclose ï¼Œé‚£ä¹ˆ poll é˜¶æ®µå°†ä¸é˜»å¡ï¼Œä¼šè¿›è¡Œä¸‹ä¸€ä¸ª tick é˜¶æ®µã€‚

**poll é˜¶æ®µæµç¨‹å›¾**

æˆ‘æŠŠæ•´ä¸ª poll é˜¶æ®µåšçš„äº‹ç”¨æµç¨‹å›¾è¡¨ç¤ºï¼Œçœå»äº†ä¸€äº›ç»†ææœ«èŠ‚ã€‚

![](../../\imgs\nodejs-io-12.jpg)

### check é˜¶æ®µ

å¦‚æœ poll é˜¶æ®µè¿›å…¥ idle çŠ¶æ€å¹¶ä¸” setImmediate å‡½æ•°å­˜åœ¨å›è°ƒå‡½æ•°æ—¶ï¼Œé‚£ä¹ˆ poll é˜¶æ®µå°†æ‰“ç ´æ— é™åˆ¶çš„ç­‰å¾…çŠ¶æ€ï¼Œå¹¶è¿›å…¥ check é˜¶æ®µæ‰§è¡Œ check é˜¶æ®µçš„å›è°ƒå‡½æ•°ã€‚

**check åšçš„äº‹å°±æ˜¯å¤„ç† setImmediate å›è°ƒã€‚**ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ Nodejs ä¸­æ˜¯æ€ä¹ˆå®šä¹‰çš„Â `setImmediate`ã€‚

#### Nodejs åº•å±‚ä¸­çš„ setImmediate

**setImmediateå®šä¹‰**

> node/lib/timer.js

```js
function setImmediate(callback, arg1, arg2, arg3) {
  validateCallback(callback); /* æ ¡éªŒä¸€ä¸‹å›è°ƒå‡½æ•° */
   /* åˆ›å»ºä¸€ä¸ª Immediate ç±»   */
   return new Immediate(callback, args);
}
```

- å½“è°ƒç”¨Â `setImmediate`Â æœ¬è´¨ä¸Šè°ƒç”¨ nodejs ä¸­çš„ setImmediate æ–¹æ³•ï¼Œé¦–å…ˆæ ¡éªŒå›è°ƒå‡½æ•°ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªÂ `Immediate`Â ç±»ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ Immediate ç±»ã€‚

> node/lib/internal/timers.js

```js
class Immediate{
   constructor(callback, args) {
    this._idleNext = null;
    this._idlePrev = null; /* åˆå§‹åŒ–å‚æ•° */
    this._onImmediate = callback;
    this._argv = args;
    this._destroyed = false;
    this[kRefed] = false;

    initAsyncResource(this, 'Immediate');
    this.ref();
    immediateInfo[kCount]++;

    immediateQueue.append(this); /* æ·»åŠ  */
  }
}
```

- Immediate ç±»ä¼šåˆå§‹åŒ–ä¸€äº›å‚æ•°ï¼Œç„¶åå°†å½“å‰ Immediate ç±»ï¼Œæ’å…¥åˆ°Â `immediateQueue`Â é“¾è¡¨ä¸­ã€‚

- immediateQueue æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå­˜æ”¾æ¯ä¸€ä¸ª Immediateã€‚

**setImmediateæ‰§è¡Œ**

poll é˜¶æ®µä¹‹åï¼Œä¼šé©¬ä¸Šåˆ° check é˜¶æ®µï¼Œæ‰§è¡Œ immediateQueue é‡Œé¢çš„ Immediateã€‚åœ¨æ¯ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œä¼šå…ˆæ‰§è¡Œä¸€ä¸ªsetImmediate å›è°ƒï¼Œç„¶åæ¸…ç©º nextTick å’Œ Promise é˜Ÿåˆ—çš„å†…å®¹ã€‚ä¸ºäº†éªŒè¯è¿™ä¸ªç»“è®ºï¼ŒåŒæ ·å’Œ setTimeout ä¸€æ ·ï¼Œçœ‹ä¸€ä¸‹å¦‚ä¸‹ä»£ç å—ï¼š

```js
setImmediate(()=>{
    console.log('setImmediate1')
    process.nextTick(()=>{
        console.log('nextTick')
    })
})

setImmediate(()=>{
    console.log('setImmediate2')
})
```

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-13.jpg)

æ‰“å° setImmediate1 -> nextTick -> setImmediate2 ï¼Œåœ¨æ¯ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ‰§è¡Œä¸€ä¸ª setImmediate ï¼Œç„¶åæ‰§è¡Œæ¸…ç©º nextTick é˜Ÿåˆ—ï¼Œåœ¨ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ‰§è¡Œå¦å¤–ä¸€ä¸ª setImmediate2 ã€‚

**setImmediateæ‰§è¡Œæµç¨‹å›¾**

![](../../\imgs\nodejs-io-14.jpg)

#### setTimeout & setImmediate

æ¥ä¸‹æ¥å¯¹æ¯”ä¸€ä¸‹Â **setTimeout**Â å’ŒÂ **setImmediate**ï¼Œå¦‚æœå¼€å‘è€…æœŸæœ›å»¶æ—¶æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å¯¹æ¯”ä¸€ä¸‹Â `setTimeout(fn,0)`Â å’ŒÂ `setImmediate(fn)`Â åŒºåˆ«ã€‚

- setTimeout æ˜¯ ç”¨äºåœ¨è®¾å®šé˜€å€¼çš„æœ€å°è¯¯å·®å†…ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°ï¼ŒsetTimeout å­˜åœ¨ç²¾åº¦é—®é¢˜ï¼Œåˆ›å»º setTimeout å’Œ poll é˜¶æ®µéƒ½å¯èƒ½å½±å“åˆ° setTimeout å›è°ƒå‡½æ•°çš„æ‰§è¡Œã€‚

- setImmediate åœ¨ poll é˜¶æ®µä¹‹åï¼Œä¼šé©¬ä¸Šè¿›å…¥ check é˜¶æ®µï¼Œä¼šæ‰§è¡ŒÂ `setImmediate`å›è°ƒã€‚

å¦‚æœ setTimeout å’Œ setImmediate åœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆè°å…ˆæ‰§è¡Œå‘¢ï¼Ÿ

é¦–å…ˆå†™ä¸€ä¸ª demoï¼š

```js
setTimeout(()=>{
    console.log('setTimeout')
},0)

setImmediate(()=>{
    console.log( 'setImmediate' )
})
```

**çŒœæµ‹**

å…ˆçŒœæµ‹ä¸€ä¸‹ï¼ŒsetTimeout å‘ç”ŸÂ `timer`Â é˜¶æ®µï¼ŒsetImmediate å‘ç”Ÿåœ¨Â `check`Â é˜¶æ®µï¼Œtimer é˜¶æ®µæ—©äº check é˜¶æ®µï¼Œé‚£ä¹ˆ setTimeout ä¼˜å…ˆäº setImmediate æ‰“å°ã€‚ä½†äº‹å®æ˜¯è¿™æ ·å—ï¼Ÿ

**å®é™…æ‰“å°ç»“æœ**

![](../../\imgs\nodejs-io-15.jpg)

ä»ä»¥ä¸Šæ‰“å°ç»“æœä¸Šçœ‹ï¼ŒÂ `setTimeout`Â å’ŒÂ `setImmediate`Â æ‰§è¡Œæ—¶æœºæ˜¯ä¸ç¡®å®šçš„ï¼Œä¸ºä»€ä¹ˆä¼šé€ æˆè¿™ç§æƒ…å†µï¼Œä¸Šæ–‡ä¸­è®²åˆ°å³ä½¿ setTimeout ç¬¬äºŒä¸ªå‚æ•°ä¸º 0ï¼Œåœ¨ nodejs ä¸­ä¹Ÿä¼šè¢«å¤„ç†Â `setTimeout(fn,1)`ã€‚å½“ä¸»è¿›ç¨‹çš„åŒæ­¥ä»£ç æ‰§è¡Œä¹‹åï¼Œä¼šè¿›å…¥åˆ°äº‹ä»¶å¾ªç¯é˜¶æ®µï¼Œç¬¬ä¸€æ¬¡è¿›å…¥ timer ä¸­ï¼Œæ­¤æ—¶ settimeout å¯¹åº”çš„ timer çš„æ—¶é—´é˜€å€¼ä¸º 1ï¼Œè‹¥åœ¨å‰æ–‡ uv__run_timer(loop) ä¸­ï¼Œç³»ç»Ÿæ—¶é—´è°ƒç”¨å’Œæ—¶é—´æ¯”è¾ƒçš„è¿‡ç¨‹æ€»è€—æ—¶æ²¡æœ‰è¶…è¿‡ 1ms çš„è¯ï¼Œåœ¨ timer é˜¶æ®µä¼šå‘ç°æ²¡æœ‰è¿‡æœŸçš„è®¡æ—¶å™¨ï¼Œé‚£ä¹ˆå½“å‰ timer å°±ä¸ä¼šæ‰§è¡Œï¼Œæ¥ä¸‹æ¥åˆ° check é˜¶æ®µï¼Œå°±ä¼šæ‰§è¡Œ setImmediate å›è°ƒï¼Œæ­¤æ—¶çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š**setImmediate -> setTimeout**ã€‚

ä½†æ˜¯å¦‚æœæ€»è€—æ—¶è¶…è¿‡ä¸€æ¯«ç§’çš„è¯ï¼Œæ‰§è¡Œé¡ºåºå°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨ timer é˜¶æ®µï¼Œå–å‡ºè¿‡æœŸçš„ setTimeout ä»»åŠ¡æ‰§è¡Œï¼Œç„¶ååˆ° check é˜¶æ®µï¼Œå†æ‰§è¡Œ setImmediate ï¼Œæ­¤æ—¶ Â **setTimeout**Â ->Â **setImmediate**ã€‚

é€ æˆè¿™ç§æƒ…å†µå‘ç”Ÿçš„åŸå› æ˜¯ï¼štimer çš„æ—¶é—´æ£€æŸ¥è·å½“å‰äº‹ä»¶å¾ªç¯ tick çš„é—´éš”å¯èƒ½å°äº 1ms ä¹Ÿå¯èƒ½å¤§äº 1ms çš„é˜ˆå€¼ï¼Œæ‰€ä»¥å†³å®šäº† setTimeout åœ¨ç¬¬ä¸€æ¬¡äº‹ä»¶å¾ªç¯æ‰§è¡Œä¸å¦ã€‚

æ¥ä¸‹æ¥æˆ‘ç”¨ä»£ç é˜»å¡çš„æƒ…å†µï¼Œä¼šå¤§æ¦‚ç‡é€ æˆ setTimeout ä¸€ç›´ä¼˜å…ˆäº setImmediate æ‰§è¡Œã€‚

```js
/* TODO:  setTimeout & setImmediate */
setImmediate(()=>{
    console.log( 'setImmediate' )
})

setTimeout(()=>{
    console.log('setTimeout')
},0)
/* ç”¨ 100000 å¾ªç¯é˜»å¡ä»£ç ï¼Œä¿ƒä½¿ setTimeout è¿‡æœŸ */
for(let i=0;i<100000;i++){
}
```

æ•ˆæœï¼š

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-16.jpg)

`100000`Â å¾ªç¯é˜»å¡ä»£ç ï¼Œè¿™æ ·ä¼šè®© setTimeout è¶…è¿‡æ—¶é—´é˜€å€¼æ‰§è¡Œï¼Œè¿™æ ·å°±ä¿è¯äº†æ¯æ¬¡å…ˆæ‰§è¡ŒÂ **setTimeout**Â ->Â **setImmediate**Â ã€‚

ç‰¹æ®Šæƒ…å†µï¼šç¡®å®šé¡ºåºä¸€è‡´æ€§ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ç‰¹æ®Šçš„æƒ…å†µã€‚

```js
const fs = require('fs')
fs.readFile('./file.js',()=>{
    setImmediate(()=>{
        console.log( 'setImmediate' )
    })
    setTimeout(()=>{
        console.log('setTimeout')
    },0)
})
```

å¦‚ä¸Šæƒ…å†µå°±ä¼šé€ æˆï¼ŒsetImmediate ä¸€ç›´ä¼˜å…ˆäº setTimeout æ‰§è¡Œï¼Œè‡³äºä¸ºä»€ä¹ˆï¼Œæ¥ä¸€èµ·åˆ†æä¸€ä¸‹åŸå› ã€‚

- é¦–å…ˆåˆ†æä¸€ä¸‹å¼‚æ­¥ä»»åŠ¡â€”â€”ä¸»è¿›ç¨‹ä¸­æœ‰ä¸€ä¸ªå¼‚æ­¥ I/O ä»»åŠ¡ï¼ŒI/O å›è°ƒä¸­æœ‰ä¸€ä¸ª setImmediate å’Œ ä¸€ä¸ª setTimeout ã€‚

- åœ¨Â `poll`Â é˜¶æ®µä¼šæ‰§è¡Œ I/O å›è°ƒã€‚ç„¶åå¤„ç†ä¸€ä¸ª setImmediate

ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œåªè¦æŒæ¡äº†å¦‚ä¸Šå„ä¸ªé˜¶æ®µçš„ç‰¹æ€§ï¼Œé‚£ä¹ˆå¯¹äºä¸åŒæƒ…å†µçš„æ‰§è¡Œæƒ…å†µï¼Œå°±å¯ä»¥æ¸…æ™°çš„åˆ†è¾¨å‡ºæ¥ã€‚

### close é˜¶æ®µ

close é˜¶æ®µç”¨äºæ‰§è¡Œä¸€äº›å…³é—­çš„å›è°ƒå‡½æ•°ã€‚æ‰§è¡Œæ‰€æœ‰çš„ close äº‹ä»¶ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ close äº‹ä»¶Â `libuv`Â çš„å®ç°ã€‚

> libuv/src/unix/core.c

```c
static void uv__run_closing_handles(uv_loop_t* loop) {
  uv_handle_t* p;
  uv_handle_t* q;

  p = loop->closing_handles;
  loop->closing_handles = NULL;

  while (p) {
    q = p->next_closing;
    uv__finish_close(p);
    p = q;
  }
}
```

`uv__run_closing_handles` è¿™ä¸ªæ–¹æ³•å¾ªç¯æ‰§è¡Œ close é˜Ÿåˆ—é‡Œé¢çš„å›è°ƒå‡½æ•°ã€‚

### Nodejs äº‹ä»¶å¾ªç¯æ€»ç»“

æ¥ä¸‹æ¥æ€»ç»“ä¸€ä¸‹ Nodejs äº‹ä»¶å¾ªç¯ã€‚

- Nodejs çš„äº‹ä»¶å¾ªç¯åˆ†ä¸º 6 å¤§é˜¶æ®µã€‚åˆ†åˆ«ä¸º timer é˜¶æ®µï¼Œpending é˜¶æ®µï¼Œprepare é˜¶æ®µï¼Œpoll é˜¶æ®µï¼Œ check é˜¶æ®µï¼Œclose é˜¶æ®µã€‚

- nextTick é˜Ÿåˆ—å’Œ Microtasks é˜Ÿåˆ—æ‰§è¡Œç‰¹ç‚¹ï¼Œåœ¨æ¯ä¸€é˜¶æ®µå®Œæˆåæ‰§è¡Œï¼Œ nextTick ä¼˜å…ˆçº§å¤§äº Microtasks ï¼ˆ Promise ï¼‰ã€‚

- poll é˜¶æ®µä¸»è¦å¤„ç† I/Oï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–ä»»åŠ¡ï¼Œä¼šå¤„äºè½®è¯¢é˜»å¡é˜¶æ®µã€‚

- timer é˜¶æ®µä¸»è¦å¤„ç†å®šæ—¶å™¨/å»¶æ—¶å™¨ï¼Œå®ƒä»¬å¹¶éå‡†ç¡®çš„ï¼Œè€Œä¸”åˆ›å»ºéœ€è¦é¢å¤–çš„æ€§èƒ½æµªè´¹ï¼Œå®ƒä»¬çš„æ‰§è¡Œè¿˜æ”¶åˆ° poll é˜¶æ®µçš„å½±å“ã€‚

- pending é˜¶æ®µå¤„ç† I/O è¿‡æœŸçš„å›è°ƒä»»åŠ¡ã€‚

- check é˜¶æ®µå¤„ç† setImmediateã€‚setImmediate å’Œ setTimeout æ‰§è¡Œæ—¶æœºå’ŒåŒºåˆ«ã€‚

## Nodejsäº‹ä»¶å¾ªç¯ä¹ é¢˜æ¼”ç»ƒ

æ¥ä¸‹æ¥ä¸ºäº†æ›´æ¸…æ¥šäº‹ä»¶å¾ªç¯æµç¨‹ï¼Œè¿™é‡Œå‡ºä¸¤é“äº‹ä»¶å¾ªç¯çš„é—®é¢˜ã€‚ä½œä¸ºå®è·µï¼š

### ä¹ é¢˜ä¸€

```js
process.nextTick(function(){
    console.log('1');
});
process.nextTick(function(){
    console.log('2');
     setImmediate(function(){
        console.log('3');
    });
    process.nextTick(function(){
        console.log('4');
    });
});

setImmediate(function(){
    console.log('5');
     process.nextTick(function(){
        console.log('6');
    });
    setImmediate(function(){
        console.log('7');
    });
});

setTimeout(e=>{
    console.log(8);
    new Promise((resolve,reject)=>{
        console.log(8+'promise');
        resolve();
    }).then(e=>{
        console.log(8+'promise+then');
    })
},0)

setTimeout(e=>{ console.log(9); },0)

setImmediate(function(){
    console.log('10');
    process.nextTick(function(){
        console.log('11');
    });
    process.nextTick(function(){
        console.log('12');
    });
    setImmediate(function(){
        console.log('13');
    });
});

console.log('14');
 new Promise((resolve,reject)=>{
    console.log(15);
    resolve();
}).then(e=>{
    console.log(16);
})
```

å¦‚æœåˆšçœ‹è¿™ä¸ª demo å¯ä»¥ä¼šå‘è’™ï¼Œä¸è¿‡ä¸Šè¿°è®²åˆ°äº†æ•´ä¸ªäº‹ä»¶å¾ªç¯ï¼Œå†æ¥çœ‹è¿™ä¸ªé—®é¢˜å°±å¾ˆè½»æ¾äº†ï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹æ•´ä½“æµç¨‹ï¼š

- ç¬¬ä¸€é˜¶æ®µï¼šé¦–å…ˆå¼€å§‹å¯åŠ¨ js æ–‡ä»¶ï¼Œé‚£ä¹ˆè¿›å…¥ç¬¬ä¸€æ¬¡äº‹ä»¶å¾ªç¯ï¼Œé‚£ä¹ˆå…ˆä¼šæ‰§è¡ŒåŒæ­¥ä»»åŠ¡ï¼š

æœ€å…ˆæ‰“å°ï¼š

> æ‰“å°console.log('14');

> æ‰“å°console.log(15);

**nextTick é˜Ÿåˆ—ï¼š**

nextTick -> console.log(1) nextTick -> console.log(2) -> setImmediate(3) -> nextTick(4)

**Promiseé˜Ÿåˆ—**

Promise.then(16)

**checké˜Ÿåˆ—**

setImmediate(5) -> nextTick(6) -> setImmediate(7) setImmediate(10) -> nextTick(11) -> nextTick(12) -> setImmediate(13)

**timeré˜Ÿåˆ—**

setTimeout(8) -> promise(8+'promise') -> promise.then(8+'promise+then') setTimeout(9)

- ç¬¬äºŒé˜¶æ®µï¼šåœ¨è¿›å…¥æ–°çš„äº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œæ¸…ç©º nextTick é˜Ÿåˆ—ï¼Œå’Œ promise é˜Ÿåˆ—ï¼Œé¡ºåºæ˜¯ nextTick é˜Ÿåˆ—å¤§äº Promise é˜Ÿåˆ—ã€‚

**æ¸…ç©º nextTick**Â ï¼Œæ‰“å°ï¼š

> console.log('1');

> console.log('2'); æ‰§è¡Œç¬¬äºŒä¸ª nextTick çš„æ—¶å€™ï¼Œåˆæœ‰ä¸€ä¸ª nextTick ï¼Œæ‰€ä»¥ä¼šæŠŠè¿™ä¸ª nextTick ä¹ŸåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚æ¥ä¸‹æ¥é©¬ä¸Šæ‰§è¡Œã€‚console.log('4')

**æ¥ä¸‹æ¥æ¸…ç©ºMicrotasks**

> console.log(16);

æ­¤æ—¶çš„ check é˜Ÿåˆ—åŠ å…¥äº†æ–°çš„ setImmediateã€‚

**checké˜Ÿåˆ—**setImmediate(5) -> nextTick(6) -> setImmediate(7) setImmediate(10) -> nextTick(11) -> nextTick(12) -> setImmediate(13) setImmediate(3)

- ç„¶åè¿›å…¥æ–°çš„äº‹ä»¶å¾ªç¯ï¼Œé¦–å…ˆæ‰§è¡Œ timer é‡Œé¢çš„ä»»åŠ¡ã€‚æ‰§è¡Œç¬¬ä¸€ä¸ª setTimeoutã€‚

**æ‰§è¡Œç¬¬ä¸€ä¸ª timer:**

> console.log(8); æ­¤æ—¶å‘ç°ä¸€ä¸ª Promise ã€‚åœ¨æ­£å¸¸çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ï¼šconsole.log(8+'promise'); ç„¶åå°† Promise.then åŠ å…¥åˆ° nextTick é˜Ÿåˆ—ä¸­ã€‚æ¥ä¸‹é‡Œä¼šé©¬ä¸Šæ¸…ç©º nextTick é˜Ÿåˆ—ã€‚console.log(8+'promise+then');

**æ‰§è¡Œç¬¬äºŒä¸ª timer:**

> console.log(9)

- æ¥ä¸‹æ¥åˆ°äº† check é˜¶æ®µï¼Œæ‰§è¡Œ check é˜Ÿåˆ—é‡Œé¢çš„å†…å®¹ï¼š

**æ‰§è¡Œç¬¬ä¸€ä¸ª check:**

> console.log(5); æ­¤æ—¶å‘ç°ä¸€ä¸ª nextTick ï¼Œç„¶åè¿˜æœ‰ä¸€ä¸ª setImmediate å°† setImmediate åŠ å…¥åˆ° check é˜Ÿåˆ—ä¸­ã€‚ç„¶åæ‰§è¡Œ nextTick ã€‚console.log(6)

**æ‰§è¡Œç¬¬äºŒä¸ª check**

> console.log(10)

æ­¤æ—¶å‘ç°ä¸¤ä¸ª nextTick å’Œä¸€ä¸ª setImmediate ã€‚æ¥ä¸‹æ¥æ¸…ç©º nextTick é˜Ÿåˆ—ã€‚å°† setImmediate æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚

> console.log(11)

> console.log(12)

æ­¤æ—¶çš„ check é˜Ÿåˆ—æ˜¯è¿™æ ·çš„ï¼š

setImmediate(3) setImmediate(7) setImmediate(13)

æ¥ä¸‹æ¥æŒ‰é¡ºåºæ¸…ç©º check é˜Ÿåˆ—ã€‚æ‰“å°

> console.log(3)

> console.log(7)

> console.log(13)

åˆ°æ­¤ä¸ºæ­¢ï¼Œæ‰§è¡Œæ•´ä¸ªäº‹ä»¶å¾ªç¯ã€‚é‚£ä¹ˆæ•´ä½“æ‰“å°å†…å®¹å¦‚ä¸‹ï¼š

![](C:\Users\Administrator\Desktop\docs\imgs\nodejs-io-17.jpg)

## æ€»ç»“

æœ¬æ–‡ä¸»è¦è®²çš„å†…å®¹å¦‚ä¸‹ï¼š

- å¼‚æ­¥ I/O ä»‹ç»åŠå…¶å†…éƒ¨åŸç†ã€‚

- Nodejs çš„äº‹ä»¶å¾ªç¯ï¼Œå…­å¤§é˜¶æ®µã€‚

- Nodejs ä¸­ setTimeout ï¼ŒsetImmediate ï¼Œ å¼‚æ­¥ i/o ï¼ŒnextTick ï¼ŒPromise çš„åŸç†åŠå…¶åŒºåˆ«ã€‚

- Nodejs äº‹ä»¶å¾ªç¯å®è·µã€‚

### å‚è€ƒèµ„æ–™

- ä» libuv çœ‹ nodejs äº‹ä»¶å¾ªç¯

- æ·±å…¥æµ…å‡ºNodejs

- Node.js äº‹ä»¶å¾ªç¯çš„å·¥ä½œæµç¨‹ & ç”Ÿå‘½å‘¨æœŸ
