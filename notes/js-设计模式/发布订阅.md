# å‘å¸ƒ-è®¢é˜…æ¨¡å¼

## ä»€ä¹ˆæ˜¯å‘å¸ƒ-è®¢é˜…æ¨¡å¼

### å®šä¹‰

å‘å¸ƒ-è®¢é˜…æ¨¡å¼å…¶å®æ˜¯ä¸€ç§å¯¹è±¡é—´ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘é€æ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å°†å¾—åˆ°çŠ¶æ€æ”¹å˜çš„é€šçŸ¥ã€‚

è®¢é˜…è€…ï¼ˆSubscriberï¼‰æŠŠè‡ªå·±æƒ³è®¢é˜…çš„äº‹ä»¶æ³¨å†Œï¼ˆSubscribeï¼‰åˆ°è°ƒåº¦ä¸­å¿ƒï¼ˆEvent Channelï¼‰ï¼Œå½“å‘å¸ƒè€…ï¼ˆPublisherï¼‰å‘å¸ƒè¯¥äº‹ä»¶ï¼ˆPublish Eventï¼‰åˆ°è°ƒåº¦ä¸­å¿ƒï¼Œä¹Ÿå°±æ˜¯è¯¥äº‹ä»¶è§¦å‘æ—¶ï¼Œç”±è°ƒåº¦ä¸­å¿ƒç»Ÿä¸€è°ƒåº¦ï¼ˆFire Eventï¼‰è®¢é˜…è€…æ³¨å†Œåˆ°è°ƒåº¦ä¸­å¿ƒçš„å¤„ç†ä»£ç ã€‚

### ä¾‹å­ğŸŒ°

æ¯”å¦‚æˆ‘ä»¬å¾ˆå–œæ¬¢çœ‹æŸä¸ªå…¬ä¼—å·å·çš„æ–‡ç« ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å‘å¸ƒæ–°æ–‡ç« ï¼Œè¦ä¸å®šæ—¶çš„å»ç¿»é˜…ï¼›è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å…³æ³¨è¯¥å…¬ä¼—å·ï¼Œå½“æœ‰æ–‡ç« æ¨é€æ—¶ï¼Œä¼šæœ‰æ¶ˆæ¯åŠæ—¶é€šçŸ¥æˆ‘ä»¬æ–‡ç« æ›´æ–°äº†ã€‚

ä¸Šé¢ä¸€ä¸ªçœ‹ä¼¼ç®€å•çš„æ“ä½œï¼Œå…¶å®æ˜¯ä¸€ä¸ªå…¸å‹çš„å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œå…¬ä¼—å·å±äºå‘å¸ƒè€…ï¼Œç”¨æˆ·å±äºè®¢é˜…è€…ï¼›ç”¨æˆ·å°†è®¢é˜…å…¬ä¼—å·çš„äº‹ä»¶æ³¨å†Œåˆ°è°ƒåº¦ä¸­å¿ƒï¼Œå…¬ä¼—å·ä½œä¸ºå‘å¸ƒè€…ï¼Œå½“æœ‰æ–°æ–‡ç« å‘å¸ƒæ—¶ï¼Œå…¬ä¼—å·å‘å¸ƒè¯¥äº‹ä»¶åˆ°è°ƒåº¦ä¸­å¿ƒï¼Œè°ƒåº¦ä¸­å¿ƒä¼šåŠæ—¶å‘æ¶ˆæ¯å‘ŠçŸ¥ç”¨æˆ·ã€‚

## å®ç°å‘å¸ƒ-è®¢é˜…æ¨¡å¼

### å®ç°æ€è·¯

- åˆ›å»ºä¸€ä¸ªå¯¹è±¡
- åœ¨è¯¥å¯¹è±¡ä¸Šåˆ›å»ºä¸€ä¸ªç¼“å­˜åˆ—è¡¨ï¼ˆè°ƒåº¦ä¸­å¿ƒï¼‰
- on æ–¹æ³•ç”¨æ¥æŠŠå‡½æ•° fn éƒ½åŠ åˆ°ç¼“å­˜åˆ—è¡¨ä¸­ï¼ˆè®¢é˜…è€…æ³¨å†Œäº‹ä»¶åˆ°è°ƒåº¦ä¸­å¿ƒï¼‰
- emit æ–¹æ³•å–åˆ° arguments é‡Œç¬¬ä¸€ä¸ªå½“åš eventï¼Œæ ¹æ® event å€¼å»æ‰§è¡Œå¯¹åº”ç¼“å­˜åˆ—è¡¨ä¸­çš„å‡½æ•°ï¼ˆå‘å¸ƒè€…å‘å¸ƒäº‹ä»¶åˆ°è°ƒåº¦ä¸­å¿ƒï¼Œè°ƒåº¦ä¸­å¿ƒå¤„ç†ä»£ç ï¼‰
- off æ–¹æ³•å¯ä»¥æ ¹æ® event å€¼å–æ¶ˆè®¢é˜…ï¼ˆå–æ¶ˆè®¢é˜…ï¼‰
- once æ–¹æ³•åªç›‘å¬ä¸€æ¬¡ï¼Œè°ƒç”¨å®Œæ¯•ååˆ é™¤ç¼“å­˜å‡½æ•°ï¼ˆè®¢é˜…ä¸€æ¬¡ï¼‰

### demo1

```js
// å…¬ä¼—å·å¯¹è±¡
let eventEmitter = {};

// ç¼“å­˜åˆ—è¡¨ï¼ˆè°ƒåº¦ä¸­å¿ƒï¼‰ï¼Œå­˜æ”¾ event åŠ fn
eventEmitter.list = {};

// è®¢é˜…
eventEmitter.on = function (event, fn) {
    let _this = this;

    // å¦‚æœå¯¹è±¡ä¸­æ²¡æœ‰å¯¹åº”çš„ event å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜æ²¡æœ‰è®¢é˜…è¿‡ï¼Œå°±ç»™eventåˆ›å»ºä¸ªç¼“å­˜åˆ—è¡¨
    // å¦‚æœ‰å¯¹è±¡ä¸­æœ‰ç›¸åº”çš„ event å€¼ï¼ŒæŠŠ fn æ·»åŠ åˆ°å¯¹åº” event çš„ç¼“å­˜åˆ—è¡¨é‡Œ
    (_this.list[event] || (_this.list[event] = [])).push(fn);

    return _this;
};

// å‘å¸ƒ
eventEmitter.emit = function () {
    let _this = this;

    // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹åº”çš„ event å€¼ï¼Œç›´æ¥ç”¨æ•°ç»„çš„ shift æ–¹æ³•å–å‡º
    let event = [].shift.call(arguments)
    let fns = _this.list[event] ? [..._this.list[event]] : [];

    // å¦‚æœç¼“å­˜åˆ—è¡¨é‡Œæ²¡æœ‰ fn å°±è¿”å› false
    if (!fns || fns.length === 0) {
        return false;
    }

    // éå† event å€¼å¯¹åº”çš„ç¼“å­˜åˆ—è¡¨ï¼Œä¾æ¬¡æ‰§è¡Œ fn
    fns.forEach(fn => {
        fn.apply(_this, arguments);
    });

    return _this;
};

function user1 (content) {
    console.log('ç”¨æˆ·1è®¢é˜…äº†:', content);
};

function user2 (content) {
    console.log('ç”¨æˆ·2è®¢é˜…äº†:', content);
};

// è®¢é˜…
eventEmitter.on('article', user1);
eventEmitter.on('article', user2);

// å‘å¸ƒ
eventEmitter.emit('article', 'Javascript å‘å¸ƒ-è®¢é˜…æ¨¡å¼');

/*
    ç”¨æˆ·1è®¢é˜…äº†: Javascript å‘å¸ƒ-è®¢é˜…æ¨¡å¼
    ç”¨æˆ·2è®¢é˜…äº†: Javascript å‘å¸ƒ-è®¢é˜…æ¨¡å¼
*/
```

### demo2

è¡¥å……äº† once å’Œ off æ–¹æ³•ã€‚

```js
let eventEmitter = {
    // ç¼“å­˜åˆ—è¡¨
    list: {},

    // è®¢é˜…
    on (event, fn) {
        let _this = this;

        //å¦‚æœå¯¹è±¡ä¸­æ²¡æœ‰å¯¹åº”çš„eventå€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜æ²¡æœ‰è®¢é˜…è¿‡ï¼Œå°±ç»™eventåˆ›å»ºä¸ªç¼“å­˜åˆ—è¡¨
        // å¦‚æœ‰å¯¹è±¡ä¸­æœ‰ç›¸åº”çš„ event å€¼ï¼ŒæŠŠ fn æ·»åŠ åˆ°å¯¹åº” event çš„ç¼“å­˜åˆ—è¡¨é‡Œ
        (_this.list[event] || (_this.list[event] = [])).push(fn);

        return _this;
    },

    // è®¢é˜… - ç›‘å¬ä¸€æ¬¡
    once (event, fn) {
        // å…ˆç»‘å®šï¼Œè°ƒç”¨ååˆ é™¤
        let _this = this;

        function on () {
            _this.off(event, on);

            // fnè¿˜æ˜¯onceä¼ çš„å‚æ•°fn
            fn.apply(_this, arguments);
        }

        // ä¸ºäº†å¯ä»¥åˆ é™¤ï¼Œå› ä¸ºå…ˆè®¢é˜…ï¼Œå†åˆ é™¤
        on.fn = fn;
        _this.on(event, on);

        return _this;
    },

    // å–æ¶ˆè®¢é˜…
    off (event, fn) {
        let _this = this;
        let fns = _this.list[event];

        // å¦‚æœç¼“å­˜åˆ—è¡¨ä¸­æ²¡æœ‰ç›¸åº”çš„ fnï¼Œè¿”å›false
        if (!fns) return false;

        if (!fn) {
            // å¦‚æœæ²¡æœ‰ä¼  fn çš„è¯ï¼Œå°±ä¼šå°† event å€¼å¯¹åº”ç¼“å­˜åˆ—è¡¨ä¸­çš„ fn éƒ½æ¸…ç©º
            fns && (fns.length = 0);
        } 
        else {
            // è‹¥æœ‰ fnï¼Œéå†ç¼“å­˜åˆ—è¡¨ï¼Œçœ‹çœ‹ä¼ å…¥çš„ fn ä¸å“ªä¸ªå‡½æ•°ç›¸åŒï¼Œ
            // å¦‚æœç›¸åŒå°±ç›´æ¥ä»ç¼“å­˜åˆ—è¡¨ä¸­åˆ æ‰å³å¯
            let cb;

            for (let i = 0, cbLen = fns.length; i < cbLen; i++) {
                cb = fns[i];

                // cb === fn -> é’ˆå¯¹æ­£å¸¸çš„è®¢é˜…
                // cb.fn === fn -> é’ˆå¯¹onceçš„è®¢é˜…
                if (cb === fn || cb.fn === fn) {
                    fns.splice(i, 1);
                    break
                }
            }
        }

        return _this;
    },

    // å‘å¸ƒ
    emit () {
        let _this = this;
        // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹åº”çš„ event å€¼ï¼Œç›´æ¥ç”¨æ•°ç»„çš„ shift æ–¹æ³•å–å‡º
        let event = [].shift.call(arguments);
        let fns = [..._this.list[event]];


        // å¦‚æœç¼“å­˜åˆ—è¡¨é‡Œæ²¡æœ‰ fn å°±è¿”å› false
        if (!fns || fns.length === 0) {
            return false;
        }

        // éå† event å€¼å¯¹åº”çš„ç¼“å­˜åˆ—è¡¨ï¼Œä¾æ¬¡æ‰§è¡Œ fn
        fns.forEach(fn => {
            fn.apply(_this, arguments);
        });

        return _this;
    }
};

function user1 (content) {
    console.log('ç”¨æˆ·1è®¢é˜…äº†:', content);
}

function user2 (content) {
    console.log('ç”¨æˆ·2è®¢é˜…äº†:', content);
}

function user3 (content) {
    console.log('ç”¨æˆ·3è®¢é˜…äº†:', content);
}

function user4 (content) {
    console.log('ç”¨æˆ·4è®¢é˜…äº†:', content);
}

// è®¢é˜…
eventEmitter.on('article1', user1);
eventEmitter.on('article1', user2);
eventEmitter.on('article1', user3);

// å–æ¶ˆuser2æ–¹æ³•çš„è®¢é˜…
eventEmitter.off('article1', user2);

eventEmitter.once('article2', user4)

// å‘å¸ƒ
eventEmitter.emit('article1', 'Javascript å‘å¸ƒ-è®¢é˜…æ¨¡å¼');
eventEmitter.emit('article1', 'Javascript å‘å¸ƒ-è®¢é˜…æ¨¡å¼');
eventEmitter.emit('article2', 'Javascript è§‚å¯Ÿè€…æ¨¡å¼');
eventEmitter.emit('article2', 'Javascript è§‚å¯Ÿè€…æ¨¡å¼');

// eventEmitter.on('article1', user3).emit('article1', 'test111');

/*
    ç”¨æˆ·1è®¢é˜…äº†: Javascript å‘å¸ƒ-è®¢é˜…æ¨¡å¼
    ç”¨æˆ·3è®¢é˜…äº†: Javascript å‘å¸ƒ-è®¢é˜…æ¨¡å¼
    ç”¨æˆ·1è®¢é˜…äº†: Javascript å‘å¸ƒ-è®¢é˜…æ¨¡å¼
    ç”¨æˆ·3è®¢é˜…äº†: Javascript å‘å¸ƒ-è®¢é˜…æ¨¡å¼
    ç”¨æˆ·4è®¢é˜…äº†: Javascript è§‚å¯Ÿè€…æ¨¡å¼
*/
```

## Vue ä¸­çš„å®ç°

ä¸‹ Vue ä¸­æ€ä¹ˆå®ç° `$on` å’Œ `$emit` çš„æ–¹æ³•ï¼š

```js
function eventsMixin (Vue) {
    var hookRE = /^hook:/;

    Vue.prototype.$on = function (event, fn) {
        var this$1 = this;

        var vm = this;
        // event ä¸ºæ•°ç»„æ—¶ï¼Œå¾ªç¯æ‰§è¡Œ $on
        if (Array.isArray(event)) {
            for (var i = 0, l = event.length; i < l; i++) {
                this$1.$on(event[i], fn);
            }
        }
Â Â Â Â Â Â Â Â else {
            (vm._events[event] || (vm._events[event] = [])).push(fn);
            // optimize hook:event cost by using a boolean 
            // flag marked at registration

            // instead of a hash lookup
            if (hookRE.test(event)) {
                vm._hasHookEvent = true;
            }
        }

        return vm
    };

    Vue.prototype.$once = function (event, fn) {
        var vm = this;
        // å…ˆç»‘å®šï¼Œååˆ é™¤
        function on () {
            vm.$off(event, on);
            fn.apply(vm, arguments);
        }

        on.fn = fn;
        vm.$on(event, on);

        return vm
    };

    Vue.prototype.$off = function (event, fn) {
        var this$1 = this;

        var vm = this;
        // allï¼Œè‹¥æ²¡æœ‰ä¼ å‚æ•°ï¼Œæ¸…ç©ºæ‰€æœ‰è®¢é˜…
        if (!arguments.length) {
            vm._events = Object.create(null);
            return vm
        }

        // array of eventsï¼Œevents ä¸ºæ•°ç»„æ—¶ï¼Œå¾ªç¯æ‰§è¡Œ $off
        if (Array.isArray(event)) {
            for (var i = 0, l = event.length; i < l; i++) {
                this$1.$off(event[i], fn);
            }
            return vm
        }

        // specific event
        var cbs = vm._events[event];
        if (!cbs) {
            // æ²¡æœ‰ cbs ç›´æ¥ return this
            return vm
        }

        if (!fn) {
            // è‹¥æ²¡æœ‰ handlerï¼Œæ¸…ç©º event å¯¹åº”çš„ç¼“å­˜åˆ—è¡¨
            vm._events[event] = null;
            return vm
        }

        if (fn) {
            // specific handlerï¼Œåˆ é™¤ç›¸åº”çš„ handler
            var cb;
            var i$1 = cbs.length;
            while (i$1--) {
                cb = cbs[i$1];
                if (cb === fn || cb.fn === fn) {
                    cbs.splice(i$1, 1);
                    break
                }
            }
        }

        return vm
    };

    Vue.prototype.$emit = function (event) {
        var vm = this;
        {
            // ä¼ å…¥çš„ event åŒºåˆ†å¤§å°å†™ï¼Œè‹¥ä¸ä¸€è‡´ï¼Œæœ‰æç¤º
            var lowerCaseEvent = event.toLowerCase();
            if (lowerCaseEvent !== event && vm._events[lowerCaseEvent]) {
                tip(
                    "Event \"" + lowerCaseEvent + "\" is emitted in component " +
                    (formatComponentName(vm)) + " but the handler is registered for \"" + event + "\". " +
                    "Note that HTML attributes are case-insensitive and you cannot use " +
                    "v-on to listen to camelCase events when using in-DOM templates. " +
                    "You should probably use \"" + (hyphenate(event)) + "\" instead of \"" + event + "\"."
                );
            }
        }

        var cbs = vm._events[event];
        if (cbs) {
            cbs = cbs.length > 1 ? toArray(cbs) : cbs;
            // åªå–å›è°ƒå‡½æ•°ï¼Œä¸å– event
            var args = toArray(arguments, 1);
            for (var i = 0, l = cbs.length; i < l; i++) {
                try {
                    cbs[i].apply(vm, args);
                } catch (e) {
                    handleError(e, vm, ("event handler for \"" + event + "\""));
                }
            }
        }

        return vm
    };
}

/***
   * Convert an Array-like object to a real Array.
   */
function toArray (list, start) {
    start = start || 0;
    var i = list.length - start;
    var ret = new Array(i);
    while (i--) {
          ret[i] = list[i + start];
    }
    return ret
}
```

## æ€»ç»“

### ä¼˜ç‚¹

- å¯¹è±¡ä¹‹é—´è§£è€¦
- å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œå¯ä»¥æ›´æ¾è€¦åˆçš„ä»£ç ç¼–å†™

### ç¼ºç‚¹

- åˆ›å»ºè®¢é˜…è€…æœ¬èº«è¦æ¶ˆè€—ä¸€å®šçš„æ—¶é—´å’Œå†…å­˜
- è™½ç„¶å¯ä»¥å¼±åŒ–å¯¹è±¡ä¹‹é—´çš„è”ç³»ï¼Œå¤šä¸ªå‘å¸ƒè€…å’Œè®¢é˜…è€…åµŒå¥—ä¸€èµ·çš„æ—¶å€™ï¼Œç¨‹åºéš¾ä»¥è·Ÿè¸ªç»´æŠ¤

## æ‰©å±•ï¼ˆå‘å¸ƒ-è®¢é˜…æ¨¡å¼ä¸è§‚å¯Ÿè€…æ¨¡å¼çš„åŒºåˆ«ï¼‰

![](../../imgs/design-mode-1.png)

`è§‚å¯Ÿè€…æ¨¡å¼`ï¼šè§‚å¯Ÿè€…ï¼ˆObserverï¼‰ç›´æ¥è®¢é˜…ï¼ˆSubscribeï¼‰ä¸»é¢˜ï¼ˆSubjectï¼‰ï¼Œè€Œå½“ä¸»é¢˜è¢«æ¿€æ´»çš„æ—¶å€™ï¼Œä¼šè§¦å‘ï¼ˆFire Eventï¼‰è§‚å¯Ÿè€…é‡Œçš„äº‹ä»¶ã€‚

`å‘å¸ƒè®¢é˜…æ¨¡å¼`ï¼šè®¢é˜…è€…ï¼ˆSubscriberï¼‰æŠŠè‡ªå·±æƒ³è®¢é˜…çš„äº‹ä»¶æ³¨å†Œï¼ˆSubscribeï¼‰åˆ°è°ƒåº¦ä¸­å¿ƒï¼ˆEvent Channelï¼‰ï¼Œå½“å‘å¸ƒè€…ï¼ˆPublisherï¼‰å‘å¸ƒè¯¥äº‹ä»¶ï¼ˆPublish Eventï¼‰åˆ°è°ƒåº¦ä¸­å¿ƒï¼Œä¹Ÿå°±æ˜¯è¯¥äº‹ä»¶è§¦å‘æ—¶ï¼Œç”±è°ƒåº¦ä¸­å¿ƒç»Ÿä¸€è°ƒåº¦ï¼ˆFire Eventï¼‰è®¢é˜…è€…æ³¨å†Œåˆ°è°ƒåº¦ä¸­å¿ƒçš„å¤„ç†ä»£ç ã€‚

`å·®å¼‚`ï¼š

- åœ¨è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œè§‚å¯Ÿè€…æ˜¯çŸ¥é“ Subject çš„ï¼ŒSubject ä¸€ç›´ä¿æŒå¯¹è§‚å¯Ÿè€…è¿›è¡Œè®°å½•ã€‚ç„¶è€Œï¼Œåœ¨å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­ï¼Œå‘å¸ƒè€…å’Œè®¢é˜…è€…ä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚å®ƒä»¬åªæœ‰é€šè¿‡æ¶ˆæ¯ä»£ç†è¿›è¡Œé€šä¿¡ã€‚

- åœ¨å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­ï¼Œç»„ä»¶æ˜¯æ¾æ•£è€¦åˆçš„ï¼Œæ­£å¥½å’Œè§‚å¯Ÿè€…æ¨¡å¼ç›¸åã€‚

- è§‚å¯Ÿè€…æ¨¡å¼å¤§å¤šæ•°æ—¶å€™æ˜¯åŒæ­¥çš„ï¼Œæ¯”å¦‚å½“äº‹ä»¶è§¦å‘ï¼ŒSubject å°±ä¼šå»è°ƒç”¨è§‚å¯Ÿè€…çš„æ–¹æ³•ã€‚è€Œå‘å¸ƒ-è®¢é˜…æ¨¡å¼å¤§å¤šæ•°æ—¶å€™æ˜¯å¼‚æ­¥çš„ï¼ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚

- è§‚å¯Ÿè€…æ¨¡å¼éœ€è¦åœ¨å•ä¸ªåº”ç”¨ç¨‹åºåœ°å€ç©ºé—´ä¸­å®ç°ï¼Œè€Œå‘å¸ƒ-è®¢é˜…æ›´åƒäº¤å‰åº”ç”¨æ¨¡å¼ã€‚
