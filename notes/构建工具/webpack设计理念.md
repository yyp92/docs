# Webpackè®¾è®¡ç†å¿µ

## å‰è¨€

[Webpack](https://webpack.js.org/) ä¸€ç›´éƒ½æ˜¯æœ‰äº›äººçš„å¿ƒé­”ï¼Œä¸æ¸…æ¥šåŸç†æ˜¯ä»€ä¹ˆï¼Œä¸çŸ¥é“æ€ä¹ˆå»é…ç½®ï¼Œåªä¼šåŸºæœ¬çš„ API ä½¿ç”¨ã€‚å®ƒå°±åƒä¸€ä¸ªé»‘ç›’ï¼Œè®©éƒ¨åˆ†å¼€å‘è€…å¯¹å®ƒæœ›è€Œç”Ÿç•ã€‚

å¤§å®¶ä¹‹æ‰€ä»¥è®¤ä¸º **Webpack** å¤æ‚ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å› ä¸ºå®ƒä¾é™„ç€ä¸€å¥—åºå¤§çš„ç”Ÿæ€ç³»ç»Ÿã€‚**å…¶å® Webpack çš„æ ¸å¿ƒæµç¨‹è¿œæ²¡æœ‰æˆ‘ä»¬æƒ³è±¡ä¸­é‚£ä¹ˆå¤æ‚**ï¼Œç”šè‡³åªéœ€ç™¾æ¥è¡Œä»£ç å°±èƒ½å®Œæ•´å¤åˆ»å‡ºæ¥ã€‚

å› æ­¤åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åº”**æ³¨é‡å­¦ä¹ å®ƒæœ¬èº«çš„è®¾è®¡æ€æƒ³**ï¼Œä¸ç®¡æ˜¯å®ƒçš„ `Plugin ç³»ç»Ÿ`è¿˜æ˜¯ `Loader ç³»ç»Ÿ`ï¼Œ**éƒ½æ˜¯å»ºç«‹äºè¿™å¥—æ ¸å¿ƒæ€æƒ³ä¹‹ä¸Š**ã€‚æ‰€è°“ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œä¸€é€šç™¾é€šã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä¼šä» Webpack çš„æ•´ä½“æµç¨‹å‡ºå‘ï¼Œé€šç¯‡é‡‡ç”¨**ç»“è®ºå…ˆè¡Œã€è‡ªé¡¶å‘ä¸‹**çš„æ–¹å¼è¿›è¡Œè®²è§£ã€‚åœ¨æ¶‰åŠåˆ°åŸç†æ€§çš„çŸ¥è¯†æ—¶ï¼Œå°½é‡é‡‡ç”¨å›¾æ–‡çš„æ–¹å¼è¾…ä»¥ç†è§£ï¼Œ`æ³¨é‡å®ç°æ€è·¯`ï¼Œ`æ³¨é‡è®¾è®¡æ€æƒ³`ã€‚

## åŸºæœ¬ä½¿ç”¨

åˆå§‹åŒ–é¡¹ç›®ï¼š

```bash
# åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®
npm init  
# å®‰è£…é¡¹ç›®ä¾èµ–
yarn add webpack 
```

å®‰è£…å®Œä¾èµ–åï¼Œæ ¹æ®ä»¥ä¸‹ç›®å½•ç»“æ„æ¥æ·»åŠ å¯¹åº”çš„ç›®å½•å’Œæ–‡ä»¶ï¼š

```bash
â”œâ”€â”€ node_modules
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ webpack.config.js # é…ç½®æ–‡ä»¶
â”œâ”€â”€ debugger.js # æµ‹è¯•æ–‡ä»¶
â””â”€â”€ src # æºç ç›®å½•
     |â”€â”€ index.js
     |â”€â”€ name.js
     â””â”€â”€ age.js
```

**webpack.config.js**

```js
const path = require("path");
module.exports = {
  mode: "development", // é˜²æ­¢ä»£ç è¢«å‹ç¼©
  entry: "./src/index.js", // å…¥å£æ–‡ä»¶
  output: {
    path: path.resolve(__dirname, "dist"),
    filename: "[name].js",
  },
  devtool: "source-map", // é˜²æ­¢å¹²æ‰°æºæ–‡ä»¶
};
```

**src/index.jsï¼ˆ`æœ¬æ–‡ä¸è®¨è®ºCommonJS å’Œ ES Moduleä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼Œä»¥CommonJSä¸ºå‡†`ï¼‰**

```js
const name = require("./name");
const age = require("./age");
console.log("entryæ–‡ä»¶æ‰“å°ä½œè€…ä¿¡æ¯", name, age);
```

**src/name.js**

```js
module.exports = "ä¸è¦ç§ƒå¤´å•Š";
```

**src/age.js**

```js
module.exports = "99";
```

**æ–‡ä»¶ä¾èµ–å…³ç³»ï¼š**

![](../../\images\webpack-study-1.png)

[Webpack](https://webpack.js.org/) æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªé…ç½®ä¿¡æ¯ä½œä¸ºå‚æ•°ï¼Œæ‰§è¡Œåè¿”å›ä¸€ä¸ª [compiler å¯¹è±¡](https://webpack.js.org/plugins/internal-plugins/#compiler)ï¼Œè°ƒç”¨ `compiler` å¯¹è±¡ä¸­çš„ [run](https://webpack.js.org/api/node/#run) æ–¹æ³•å°±ä¼šå¯åŠ¨ç¼–è¯‘ã€‚`run` æ–¹æ³•æ¥å—ä¸€ä¸ªå›è°ƒï¼Œå¯ä»¥ç”¨æ¥æŸ¥çœ‹ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯æˆ–ç¼–è¯‘ä¿¡æ¯ã€‚

**debugger.js**

```js
// const { webpack } = require("./webpack.js"); // åé¢è‡ªå·±æ‰‹å†™
const { webpack } = require("webpack");
const webpackOptions = require("./webpack.config.js");
const compiler = webpack(webpackOptions);

// å¼€å§‹ç¼–è¯‘
compiler.run((err, stats) => {
  console.log(err);
  console.log(
    stats.toJson({
      assets: true, // æ‰“å°æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æº
      chunks: true, // æ‰“å°æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„ä»£ç å—
      modules: true, // æ‰“å°æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ¨¡å—
    })
  );
});
```

æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼š

```bash
node ./debugger.js
```

å¾—åˆ°äº§å‡ºæ–‡ä»¶ **dist/main.js**ï¼ˆå…ˆæš‚åœä¸‰åç§’è¯»ä¸€è¯»ä¸‹é¢ä»£ç ï¼Œå‘½åç»ä¼˜åŒ–ï¼‰ï¼š

![](../../\images\webpack-study-2.png)

è¿è¡Œè¯¥æ–‡ä»¶ï¼Œå¾—åˆ°ç»“æœï¼š

```js
entryæ–‡ä»¶æ‰“å°ä½œè€…ä¿¡æ¯ ä¸è¦ç§ƒå¤´å•Š 99
```

## æ ¸å¿ƒæ€æƒ³

æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹æºä»£ç å’Œæ„å»ºäº§ç‰©ä¹‹é—´çš„å…³ç³»ï¼š

![](../../\images\webpack-study-3.png)

ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå…¥å£æ–‡ä»¶ï¼ˆ`src/index.js`ï¼‰è¢«åŒ…è£¹åœ¨æœ€åçš„ç«‹å³æ‰§è¡Œå‡½æ•°ä¸­ï¼Œè€Œå®ƒæ‰€ä¾èµ–çš„æ¨¡å—ï¼ˆ`src/name.js`ã€`src/age.js`ï¼‰åˆ™è¢«æ”¾è¿›äº† `modules` å¯¹è±¡ä¸­ï¼ˆ`modules` ç”¨äºå­˜æ”¾**å…¥å£æ–‡ä»¶çš„ä¾èµ–æ¨¡å—**ï¼Œ`key å€¼ä¸ºä¾èµ–æ¨¡å—è·¯å¾„ï¼Œvalue å€¼ä¸ºä¾èµ–æ¨¡å—æºä»£ç `ï¼‰ã€‚

`require` å‡½æ•°æ˜¯ **web ç¯å¢ƒä¸‹** åŠ è½½æ¨¡å—çš„æ–¹æ³•ï¼ˆ `require` åŸæœ¬æ˜¯ **nodeç¯å¢ƒ** ä¸­å†…ç½®çš„æ–¹æ³•ï¼Œæµè§ˆå™¨å¹¶ä¸è®¤è¯† `require`ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æ‰‹åŠ¨å®ç°ä¸€ä¸‹ï¼‰ï¼Œå®ƒæ¥å—æ¨¡å—çš„è·¯å¾„ä¸ºå‚æ•°ï¼Œè¿”å›æ¨¡å—å¯¼å‡ºçš„å†…å®¹ã€‚

è¦æƒ³å¼„æ¸…æ¥š Webpack åŸç†ï¼Œé‚£ä¹ˆæ ¸å¿ƒé—®é¢˜å°±å˜æˆäº†ï¼šå¦‚ä½•å°†å·¦è¾¹çš„æºä»£ç è½¬æ¢æˆ **dist/main.js** æ–‡ä»¶ï¼Ÿ

### æ ¸å¿ƒæ€æƒ³ï¼š

- ç¬¬ä¸€æ­¥ï¼šé¦–å…ˆï¼Œæ ¹æ®é…ç½®ä¿¡æ¯ï¼ˆ`webpack.config.js`ï¼‰æ‰¾åˆ°å…¥å£æ–‡ä»¶ï¼ˆ`src/index.js`ï¼‰
- ç¬¬äºŒæ­¥ï¼šæ‰¾åˆ°å…¥å£æ–‡ä»¶æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œå¹¶æ”¶é›†å…³é”®ä¿¡æ¯ï¼šæ¯”å¦‚`è·¯å¾„ã€æºä»£ç ã€å®ƒæ‰€ä¾èµ–çš„æ¨¡å—`ç­‰ï¼š

```js
var modules = [
  {
    id: "./src/name.js",//è·¯å¾„
    dependencies: [], //æ‰€ä¾èµ–çš„æ¨¡å—
    source: 'module.exports = "ä¸è¦ç§ƒå¤´å•Š";', //æºä»£ç 
  },
  {
    id: "./src/age.js",
    dependencies: [], 
    source: 'module.exports = "99";',
  },
  {
    id: "./src/index.js",
    dependencies: ["./src/name.js", "./src/age.js"], 
    source:
      'const name = require("./src/name.js");\n' +
      'const age = require("./src/age.js");\n' +
      'console.log("entryæ–‡ä»¶æ‰“å°ä½œè€…ä¿¡æ¯", name, age);',
  },
];
```

- ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®ä¸Šä¸€æ­¥å¾—åˆ°çš„ä¿¡æ¯ï¼Œç”Ÿæˆæœ€ç»ˆè¾“å‡ºåˆ°ç¡¬ç›˜ä¸­çš„æ–‡ä»¶ï¼ˆdistï¼‰ï¼š åŒ…æ‹¬ modules å¯¹è±¡ã€require æ¨¡ç‰ˆä»£ç ã€å…¥å£æ‰§è¡Œæ–‡ä»¶ç­‰

åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œç”±äºæµè§ˆå™¨å¹¶ä¸è®¤è¯†é™¤ `htmlã€jsã€css` ä»¥å¤–çš„æ–‡ä»¶æ ¼å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å¯¹æºæ–‡ä»¶è¿›è¡Œè½¬æ¢ â€”â€” **`Loader ç³»ç»Ÿ`**ã€‚

**Loader ç³»ç»Ÿ** æœ¬è´¨ä¸Šå°±æ˜¯æ¥æ”¶èµ„æºæ–‡ä»¶ï¼Œå¹¶å¯¹å…¶è¿›è¡Œè½¬æ¢ï¼Œæœ€ç»ˆè¾“å‡ºè½¬æ¢åçš„æ–‡ä»¶ï¼š

![](../../\images\webpack-study-4.png)

é™¤æ­¤ä¹‹å¤–ï¼Œæ‰“åŒ…è¿‡ç¨‹ä¸­ä¹Ÿæœ‰ä¸€äº›ç‰¹å®šçš„æ—¶æœºéœ€è¦å¤„ç†ï¼Œæ¯”å¦‚ï¼š

- åœ¨æ‰“åŒ…å‰éœ€è¦æ ¡éªŒç”¨æˆ·ä¼ è¿‡æ¥çš„å‚æ•°ï¼Œåˆ¤æ–­æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚
- åœ¨æ‰“åŒ…è¿‡ç¨‹ä¸­ï¼Œéœ€è¦çŸ¥é“å“ªäº›æ¨¡å—å¯ä»¥å¿½ç•¥ç¼–è¯‘ï¼Œç›´æ¥å¼•ç”¨ cdn é“¾æ¥
- åœ¨ç¼–è¯‘å®Œæˆåï¼Œéœ€è¦å°†è¾“å‡ºçš„å†…å®¹æ’å…¥åˆ° html æ–‡ä»¶ä¸­
- åœ¨è¾“å‡ºåˆ°ç¡¬ç›˜å‰ï¼Œéœ€è¦å…ˆæ¸…ç©º dist æ–‡ä»¶å¤¹
- ......

è¿™ä¸ªæ—¶å€™éœ€è¦ä¸€ä¸ªå¯æ’æ‹”çš„è®¾è®¡ï¼Œæ–¹ä¾¿ç»™ç¤¾åŒºæä¾›å¯æ‰©å±•çš„æ¥å£ â€”â€” **`Plugin ç³»ç»Ÿ`**ã€‚

**Plugin ç³»ç»Ÿ** æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç§äº‹ä»¶æµçš„æœºåˆ¶ï¼Œåˆ°äº†å›ºå®šçš„æ—¶é—´èŠ‚ç‚¹å°±å¹¿æ’­ç‰¹å®šçš„äº‹ä»¶ï¼Œç”¨æˆ·å¯ä»¥åœ¨äº‹ä»¶å†…æ‰§è¡Œç‰¹å®šçš„é€»è¾‘ï¼Œç±»ä¼¼äºç”Ÿå‘½å‘¨æœŸï¼š

![](../../\images\webpack-study-5.png)

è¿™äº›è®¾è®¡ä¹Ÿéƒ½æ˜¯æ ¹æ®ä½¿ç”¨åœºæ™¯æ¥çš„ï¼Œåªæœ‰ç†æ¸…éœ€æ±‚åæˆ‘ä»¬æ‰èƒ½æ›´å¥½çš„ç†è§£å®ƒçš„è®¾è®¡æ€æƒ³ã€‚

## æ¶æ„è®¾è®¡

åœ¨ç†æ¸…æ¥šæ ¸å¿ƒæ€æƒ³åï¼Œå‰©ä¸‹çš„å°±æ˜¯å¯¹å…¶è¿›è¡Œä¸€æ­¥æ­¥æ‹†è§£ã€‚

ä¸Šé¢æåˆ°ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€å¥—äº‹ä»¶æµçš„æœºåˆ¶æ¥ç®¡æ§æ•´ä¸ªæ‰“åŒ…è¿‡ç¨‹ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

- æ‰“åŒ…å¼€å§‹å‰çš„å‡†å¤‡å·¥ä½œ
- æ‰“åŒ…è¿‡ç¨‹ä¸­ï¼ˆä¹Ÿå°±æ˜¯ç¼–è¯‘é˜¶æ®µï¼‰
- æ‰“åŒ…ç»“æŸåï¼ˆåŒ…å«æ‰“åŒ…æˆåŠŸå’Œæ‰“åŒ…å¤±è´¥ï¼‰

è¿™å…¶ä¸­åˆä»¥ç¼–è¯‘é˜¶æ®µæœ€ä¸ºå¤æ‚ï¼Œå¦å¤–è¿˜è€ƒè™‘åˆ°ä¸€ä¸ªåœºæ™¯ï¼š[watch mode](https://webpack.docschina.org/guides/development/#using-watch-mode)ï¼ˆå½“æ–‡ä»¶å˜åŒ–æ—¶ï¼Œå°†é‡æ–°è¿›è¡Œç¼–è¯‘ï¼‰ï¼Œå› æ­¤è¿™é‡Œæœ€å¥½å°†ç¼–è¯‘é˜¶æ®µï¼ˆä¹Ÿå°±æ˜¯ä¸‹æ–‡ä¸­çš„`compilation`ï¼‰å•ç‹¬è§£è€¦å‡ºæ¥ã€‚

åœ¨ **Webpack** æºç ä¸­ï¼Œ`compiler` å°±åƒæ˜¯ä¸€ä¸ªå¤§ç®¡å®¶ï¼Œå®ƒå°±ä»£è¡¨ä¸Šé¢è¯´çš„ä¸‰ä¸ªé˜¶æ®µï¼Œåœ¨å®ƒä¸Šé¢æŒ‚è½½ç€å„ç§ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œè€Œ `compilation` å°±åƒä¸“ç®¡ä¼™é£Ÿçš„å¨å¸ˆï¼Œä¸“é—¨è´Ÿè´£ç¼–è¯‘ç›¸å…³çš„å·¥ä½œï¼Œä¹Ÿå°±æ˜¯`æ‰“åŒ…è¿‡ç¨‹ä¸­`è¿™ä¸ªé˜¶æ®µã€‚ç”»ä¸ªå›¾å¸®åŠ©å¤§å®¶ç†è§£ï¼š

![](../../\images\webpack-study-6.png)

å¤§è‡´æ¶æ„å®šä¸‹åï¼Œé‚£ç°åœ¨åº”è¯¥å¦‚ä½•å®ç°è¿™å¥—äº‹ä»¶æµå‘¢ï¼Ÿ

è¿™æ—¶å€™å°±éœ€è¦å€ŸåŠ©Â [Tapable](https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ftapable) äº†ï¼å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼äº Node.js ä¸­çš„Â [EventEmitter](https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fevents)Â çš„åº“ï¼Œä½†**æ›´ä¸“æ³¨äºè‡ªå®šä¹‰äº‹ä»¶çš„è§¦å‘å’Œå¤„ç†**ã€‚é€šè¿‡ Tapable æˆ‘ä»¬å¯ä»¥æ³¨å†Œè‡ªå®šä¹‰äº‹ä»¶ï¼Œç„¶ååœ¨é€‚å½“çš„æ—¶æœºå»æ‰§è¡Œè‡ªå®šä¹‰äº‹ä»¶ã€‚

ç±»æ¯”åˆ°Â `Vue`Â å’ŒÂ `React`Â æ¡†æ¶ä¸­çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œå®ƒä»¬å°±æ˜¯åˆ°äº†å›ºå®šçš„æ—¶é—´èŠ‚ç‚¹å°±æ‰§è¡Œå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸï¼Œ`tapable`Â åšçš„äº‹æƒ…å°±å’Œè¿™ä¸ªå·®ä¸å¤šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒå…ˆæ³¨å†Œä¸€ç³»åˆ—çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶é—´ç‚¹æ‰§è¡Œã€‚

example ğŸŒ°ï¼š

```js
const { SyncHook } = require("tapable"); // è¿™æ˜¯ä¸€ä¸ªåŒæ­¥é’©å­

// ç¬¬ä¸€æ­¥ï¼šå®ä¾‹åŒ–é’©å­å‡½æ•°ï¼Œå¯ä»¥åœ¨è¿™é‡Œå®šä¹‰å½¢å‚
const syncHook = new SyncHook(["author", "age"]);

// ç¬¬äºŒæ­¥ï¼šæ³¨å†Œäº‹ä»¶1
syncHook.tap("ç›‘å¬å™¨1", (name, age) => {
  console.log("ç›‘å¬å™¨1:", name, age);
});

// ç¬¬äºŒæ­¥ï¼šæ³¨å†Œäº‹ä»¶2
syncHook.tap("ç›‘å¬å™¨2", (name) => {
  console.log("ç›‘å¬å™¨2", name);
});

// ç¬¬ä¸‰æ­¥ï¼šæ³¨å†Œäº‹ä»¶3
syncHook.tap("ç›‘å¬å™¨3", (name) => {
  console.log("ç›‘å¬å™¨3", name);
});
// ç¬¬ä¸‰æ­¥ï¼šè§¦å‘äº‹ä»¶ï¼Œè¿™é‡Œä¼ çš„æ˜¯å®å‚ï¼Œä¼šè¢«æ¯ä¸€ä¸ªæ³¨å†Œå‡½æ•°æ¥æ”¶åˆ°
syncHook.call("ä¸è¦ç§ƒå¤´å•Š", "99");
```

è¿è¡Œä¸Šé¢è¿™æ®µä»£ç ï¼Œå¾—åˆ°ç»“æœï¼š

```js
ç›‘å¬å™¨1 ä¸è¦ç§ƒå¤´å•Š 99
ç›‘å¬å™¨2 ä¸è¦ç§ƒå¤´å•Š
ç›‘å¬å™¨3 ä¸è¦ç§ƒå¤´å•Š
```

åœ¨ Webpack ä¸­ï¼Œå°±æ˜¯é€šè¿‡ `tapable` åœ¨ `comiler` å’Œ `compilation` ä¸Šåƒè¿™æ ·æŒ‚è½½ç€ä¸€ç³»åˆ—`ç”Ÿå‘½å‘¨æœŸ Hook`ï¼Œå®ƒå°±åƒæ˜¯ä¸€åº§æ¡¥æ¢ï¼Œè´¯ç©¿ç€æ•´ä¸ªæ„å»ºè¿‡ç¨‹ï¼š

```js
class Compiler {
  constructor() {
    // å®ƒå†…éƒ¨æä¾›äº†å¾ˆå¤šé’©å­
    this.hooks = {
      run: new SyncHook(), // ä¼šåœ¨ç¼–è¯‘åˆšå¼€å§‹çš„æ—¶å€™è§¦å‘æ­¤é’©å­
      done: new SyncHook(), // ä¼šåœ¨ç¼–è¯‘ç»“æŸçš„æ—¶å€™è§¦å‘æ­¤é’©å­
    };
  }
}
```

## å…·ä½“å®ç°

æ•´ä¸ªå®ç°è¿‡ç¨‹å¤§è‡´åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š

- ï¼ˆ1ï¼‰æ­å»ºç»“æ„ï¼Œè¯»å–é…ç½®å‚æ•°
- ï¼ˆ2ï¼‰ç”¨é…ç½®å‚æ•°å¯¹è±¡åˆå§‹åŒ– `Compiler` å¯¹è±¡
- ï¼ˆ3ï¼‰æŒ‚è½½é…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶
- ï¼ˆ4ï¼‰æ‰§è¡Œ `Compiler` å¯¹è±¡çš„ `run` æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘
- ï¼ˆ5ï¼‰æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ `entry` é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
- ï¼ˆ6ï¼‰ä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
- ï¼ˆ7ï¼‰æ‰¾å‡ºæ­¤æ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œå†å¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘
- ï¼ˆ8ï¼‰ç­‰æ‰€æœ‰æ¨¡å—éƒ½ç¼–è¯‘å®Œæˆåï¼Œæ ¹æ®æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…ä»£ç å— `chunk`
- ï¼ˆ9ï¼‰æŠŠå„ä¸ªä»£ç å— `chunk` è½¬æ¢æˆä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶åŠ å…¥åˆ°è¾“å‡ºåˆ—è¡¨
- ï¼ˆ10ï¼‰ç¡®å®šå¥½è¾“å‡ºå†…å®¹ä¹‹åï¼Œæ ¹æ®é…ç½®çš„è¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶åï¼Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿ

### æ­å»ºç»“æ„ï¼Œè¯»å–é…ç½®å‚æ•°

æ ¹æ® [Webpack](https://webpack.js.org/) çš„ç”¨æ³•å¯ä»¥çœ‹å‡ºï¼Œ
Webpack æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªé…ç½®ä¿¡æ¯ä½œä¸ºå‚æ•°ï¼Œæ‰§è¡Œåè¿”å›ä¸€ä¸ª [compiler å¯¹è±¡](https://webpack.js.org/plugins/internal-plugins/#compiler)ï¼Œè°ƒç”¨ `compiler` å¯¹è±¡ä¸­çš„ [run](https://webpack.js.org/api/node/#run) æ–¹æ³•å°±ä¼šå¯åŠ¨ç¼–è¯‘ã€‚`run` æ–¹æ³•æ¥å—ä¸€ä¸ªå›è°ƒï¼Œå¯ä»¥ç”¨æ¥æŸ¥çœ‹ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯æˆ–ç¼–è¯‘ä¿¡æ¯ã€‚

ä¿®æ”¹ **debugger.js** ä¸­ webpack çš„å¼•ç”¨ï¼š

```js
+ const webpack = require("./webpack"); //æ‰‹å†™webpack
const webpackOptions = require("./webpack.config.js"); //è¿™é‡Œä¸€èˆ¬ä¼šæ”¾é…ç½®ä¿¡æ¯
const compiler = webpack(webpackOptions);

compiler.run((err, stats) => {
  console.log(err);
  console.log(
    stats.toJson({
      assets: true, //æ‰“å°æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æº
      chunks: true, //æ‰“å°æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„ä»£ç å—
      modules: true, //æ‰“å°æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ¨¡å—
    })
  );
});
```

æ­å»ºç»“æ„ï¼š

```js
class Compiler {
  constructor() {}

  run(callback) {}
}

// ç¬¬ä¸€æ­¥ï¼šæ­å»ºç»“æ„ï¼Œè¯»å–é…ç½®å‚æ•°ï¼Œè¿™é‡Œæ¥å—çš„æ˜¯webpack.config.jsä¸­çš„å‚æ•°
function webpack(webpackOptions) {
  const compiler = new Compiler()
  return compiler;
}
```

è¿è¡Œæµç¨‹å›¾ï¼š

![](../../\images\webpack-study-7.png)

### ç”¨é…ç½®å‚æ•°å¯¹è±¡åˆå§‹åŒ–Â `Compiler`Â å¯¹è±¡

ä¸Šé¢æåˆ°è¿‡ï¼Œ`Compiler`Â å®ƒå°±æ˜¯æ•´ä¸ªæ‰“åŒ…è¿‡ç¨‹çš„å¤§ç®¡å®¶ï¼Œå®ƒé‡Œé¢æ”¾ç€å„ç§ä½ å¯èƒ½éœ€è¦çš„`ç¼–è¯‘ä¿¡æ¯`å’Œ`ç”Ÿå‘½å‘¨æœŸ Hook`ï¼Œè€Œä¸”æ˜¯å•ä¾‹æ¨¡å¼ã€‚

```js
//Compilerå…¶å®æ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒæ˜¯æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹çš„å¤§ç®¡å®¶ï¼Œè€Œä¸”æ˜¯å•ä¾‹æ¨¡å¼
class Compiler {
+ constructor(webpackOptions) {
+   this.options = webpackOptions; //å­˜å‚¨é…ç½®ä¿¡æ¯
+   //å®ƒå†…éƒ¨æä¾›äº†å¾ˆå¤šé’©å­
+   this.hooks = {
+     run: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘åˆšå¼€å§‹çš„æ—¶å€™è§¦å‘æ­¤runé’©å­
+     done: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘ç»“æŸçš„æ—¶å€™è§¦å‘æ­¤doneé’©å­
+   };
+ }
}

//ç¬¬ä¸€æ­¥ï¼šæ­å»ºç»“æ„ï¼Œè¯»å–é…ç½®å‚æ•°ï¼Œè¿™é‡Œæ¥å—çš„æ˜¯webpack.config.jsä¸­çš„å‚æ•°
function webpack(webpackOptions) {
  //ç¬¬äºŒæ­¥ï¼šç”¨é…ç½®å‚æ•°å¯¹è±¡åˆå§‹åŒ– `Compiler` å¯¹è±¡
+ const compiler = new Compiler(webpackOptions)
  return compiler;
}
```

è¿è¡Œæµç¨‹å›¾ï¼š

![](../../\images\webpack-study-8.png)

### æŒ‚è½½é…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶

å…ˆå†™ä¸¤ä¸ªè‡ªå®šä¹‰æ’ä»¶é…ç½®åˆ° **webpack.config.js** ä¸­ï¼šä¸€ä¸ªåœ¨å¼€å§‹æ‰“åŒ…çš„æ—¶å€™æ‰§è¡Œï¼Œä¸€ä¸ªåœ¨æ‰“åŒ…å®Œæˆåæ‰§è¡Œã€‚

`Webpack Plugin å…¶å®å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­éœ€è¦æˆ‘ä»¬å®šåˆ¶ä¸€ä¸ª apply æ–¹æ³•ã€‚`å½“ Webpack å†…éƒ¨è¿›è¡Œæ’ä»¶æŒ‚è½½æ—¶ä¼šæ‰§è¡Œ `apply` å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ `apply` æ–¹æ³•ä¸­è®¢é˜…å„ç§ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œå½“åˆ°è¾¾å¯¹åº”çš„æ—¶é—´ç‚¹æ—¶å°±ä¼šæ‰§è¡Œã€‚

```js
//è‡ªå®šä¹‰æ’ä»¶WebpackRunPlugin
class WebpackRunPlugin {
  apply(compiler) {
    compiler.hooks.run.tap("WebpackRunPlugin", () => {
      console.log("å¼€å§‹ç¼–è¯‘");
    });
  }
}

//è‡ªå®šä¹‰æ’ä»¶WebpackDonePlugin
class WebpackDonePlugin {
  apply(compiler) {
    compiler.hooks.done.tap("WebpackDonePlugin", () => {
      console.log("ç»“æŸç¼–è¯‘");
    });
  }
}
```

**webpack.config.js**ï¼š

```js
+ const { WebpackRunPlugin, WebpackDonePlugin } = require("./webpack");
module.exports = {
  //å…¶ä»–çœç•¥
+ plugins: [new WebpackRunPlugin(), new WebpackDonePlugin()],
};
```

æ’ä»¶å®šä¹‰æ—¶å¿…é¡»è¦æœ‰ä¸€ä¸ª `apply` æ–¹æ³•ï¼ŒåŠ è½½æ’ä»¶å…¶å®æ‰§è¡Œ `apply` æ–¹æ³•ã€‚

```js
//ç¬¬ä¸€æ­¥ï¼šæ­å»ºç»“æ„ï¼Œè¯»å–é…ç½®å‚æ•°ï¼Œè¿™é‡Œæ¥å—çš„æ˜¯webpack.config.jsä¸­çš„å‚æ•°
function webpack(webpackOptions) {
  //ç¬¬äºŒæ­¥ï¼šç”¨é…ç½®å‚æ•°å¯¹è±¡åˆå§‹åŒ– `Compiler` å¯¹è±¡
  const compiler = new Compiler(webpackOptions);
  //ç¬¬ä¸‰æ­¥ï¼šæŒ‚è½½é…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶
+ const { plugins } = webpackOptions;
+ for (let plugin of plugins) {
+   plugin.apply(compiler);
+ }
  return compiler;
}
```

è¿è¡Œæµç¨‹å›¾ï¼š

![](../../\images\webpack-study-9.png)

### æ‰§è¡Œ`Compiler`å¯¹è±¡çš„`run`æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘

> é‡ç‚¹æ¥äº†ï¼

åœ¨æ­£å¼å¼€å§‹ç¼–è¯‘å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè°ƒç”¨Â `Compiler`Â ä¸­çš„Â `run`Â é’©å­ï¼Œè¡¨ç¤ºå¼€å§‹å¯åŠ¨ç¼–è¯‘äº†ï¼›åœ¨ç¼–è¯‘ç»“æŸåï¼Œéœ€è¦è°ƒç”¨Â `done`Â é’©å­ï¼Œè¡¨ç¤ºç¼–è¯‘å®Œæˆã€‚

```js
//Compilerå…¶å®æ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒæ˜¯æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹çš„å¤§ç®¡å®¶ï¼Œè€Œä¸”æ˜¯å•ä¾‹æ¨¡å¼
class Compiler {
  constructor(webpackOptions) {
   //çœç•¥
  }

+ compile(callback){
+  //
+ }

+ //ç¬¬å››æ­¥ï¼šæ‰§è¡Œ`Compiler`å¯¹è±¡çš„`run`æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘
+ run(callback) {
+   this.hooks.run.call(); //åœ¨ç¼–è¯‘å‰è§¦å‘runé’©å­æ‰§è¡Œï¼Œè¡¨ç¤ºå¼€å§‹å¯åŠ¨ç¼–è¯‘äº†
+   const onCompiled = () => {
+     this.hooks.done.call(); //å½“ç¼–è¯‘æˆåŠŸåä¼šè§¦å‘doneè¿™ä¸ªé’©å­æ‰§è¡Œ
+   };
+   this.compile(onCompiled); //å¼€å§‹ç¼–è¯‘ï¼ŒæˆåŠŸä¹‹åè°ƒç”¨onCompiled
  }
}
```

ä¸Šé¢æ¶æ„è®¾è®¡ä¸­æåˆ°è¿‡ï¼Œç¼–è¯‘è¿™ä¸ªé˜¶æ®µéœ€è¦å•ç‹¬è§£è€¦å‡ºæ¥ï¼Œé€šè¿‡ `Compilation` æ¥å®Œæˆï¼Œå®šä¹‰`Compilation` å¤§è‡´ç»“æ„ï¼š

```js
class Compiler {
  //çœç•¥å…¶ä»–
  run(callback) {
    //çœç•¥
  }

  compile(callback) {
    //è™½ç„¶webpackåªæœ‰ä¸€ä¸ªCompilerï¼Œä½†æ˜¯æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šäº§å‡ºä¸€ä¸ªæ–°çš„Compilationï¼Œ
    //è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†è€ƒè™‘åˆ°watchæ¨¡å¼ï¼Œå®ƒä¼šåœ¨å¯åŠ¨æ—¶å…ˆç¼–è¯‘ä¸€æ¬¡ï¼Œç„¶åç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ä¼šé‡æ–°å¼€å§‹ç¼–è¯‘
    //æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šäº§å‡ºä¸€ä¸ªæ–°çš„Compilationï¼Œä»£è¡¨æ¯æ¬¡çš„ç¼–è¯‘ç»“æœ
+   let compilation = new Compilation(this.options);
+   compilation.build(callback); //æ‰§è¡Œcompilationçš„buildæ–¹æ³•è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æˆåŠŸä¹‹åæ‰§è¡Œå›è°ƒ
  }
}

+ class Compilation {
+   constructor(webpackOptions) {
+     this.options = webpackOptions;
+     this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
+     this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
+     this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
+     this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
+   }

+   build(callback) {
+    //è¿™é‡Œå¼€å§‹åšç¼–è¯‘å·¥ä½œï¼Œç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
+    callback()
+   }
+ }
```

è¿è¡Œæµç¨‹å›¾ï¼ˆç‚¹å‡»å¯æ”¾å¤§ï¼‰ï¼š

![](../../\images\webpack-study-10.png)

### æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£

æ¥ä¸‹æ¥å°±æ­£å¼å¼€å§‹ç¼–è¯‘äº†ï¼Œé€»è¾‘å‡åœ¨ `Compilation` ä¸­ã€‚

åœ¨ç¼–è¯‘å‰æˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“å…¥å£æ–‡ä»¶ï¼Œè€Œ [å…¥å£çš„é…ç½®æ–¹å¼](https://webpack.js.org/configuration/entry-context/#entry) æœ‰å¤šç§ï¼Œå¯ä»¥é…ç½®æˆå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥é…ç½®æˆä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸€æ­¥éª¤å°±æ˜¯ä¸ºäº†ç»Ÿä¸€é…ç½®ä¿¡æ¯çš„æ ¼å¼ï¼Œç„¶åæ‰¾å‡ºæ‰€æœ‰çš„å…¥å£ï¼ˆè€ƒè™‘å¤šå…¥å£æ‰“åŒ…çš„åœºæ™¯ï¼‰ã€‚

```js
class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
+   let entry = {};
+   if (typeof this.options.entry === "string") {
+     entry.main = this.options.entry; //å¦‚æœæ˜¯å•å…¥å£ï¼Œå°†entry:"xx"å˜æˆ{main:"xx"}ï¼Œè¿™é‡Œéœ€è¦åšå…¼å®¹
+   } else {
+     entry = this.options.entry;
+   }

    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

è¿è¡Œæµç¨‹å›¾ï¼ˆç‚¹å‡»å¯æ”¾å¤§ï¼‰ï¼š

![](../../\images\webpack-study-11.png)

### ä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„`loader`è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘

Loader æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶èµ„æºæ–‡ä»¶æˆ–è€…ä¸Šä¸€ä¸ª Loader äº§ç”Ÿçš„ç»“æœä½œä¸ºå…¥å‚ï¼Œæœ€ç»ˆè¾“å‡ºè½¬æ¢åçš„ç»“æœã€‚

å†™ä¸¤ä¸ªè‡ªå®šä¹‰ Loader é…ç½®åˆ°Â **webpack.config.js**Â ä¸­ï¼š

```js
const loader1 = (source) => {
  return source + "//ç»™ä½ çš„ä»£ç åŠ ç‚¹æ³¨é‡Šï¼šloader1";
};

const loader2 = (source) => {
  return source + "//ç»™ä½ çš„ä»£ç åŠ ç‚¹æ³¨é‡Šï¼šloader2";
};
```

**webpack.config.js**

```js
const { loader1, loader2 } = require("./webpack");
module.exports = {
  //çœç•¥å…¶ä»–
  module: {
    rules: [
      {
        test: /\.js$/,
        use: [loader1, loader2],
      },
    ],
  },
};
```

è¿™ä¸€æ­¥éª¤å°†ä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œç„¶åæŸ¥æ‰¾å‡ºå¯¹åº”çš„ Loader å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢ã€‚

ä¸»è¦æœ‰ä¸‰ä¸ªè¦ç‚¹ï¼š

- æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
- å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
  - è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
  - åˆ›å»ºæ¨¡å—å¯¹è±¡
  - æ‰¾åˆ°å¯¹åº”çš„ `Loader` å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢
- å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `module` å¯¹è±¡ push è¿› `this.modules` ä¸­

### æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—

è¿™é‡Œå› ä¸ºè¦è·å–å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œè€ƒè™‘åˆ°æ“ä½œç³»ç»Ÿçš„å…¼å®¹æ€§é—®é¢˜ï¼Œéœ€è¦å°†è·¯å¾„çš„ `\` éƒ½æ›¿æ¢æˆ `/`ï¼š

```js
//å°†\æ›¿æ¢æˆ/
function toUnixPath(filePath) {
  return filePath.replace(/\\/g, "/");
}

const baseDir = toUnixPath(process.cwd()); //è·å–å·¥ä½œç›®å½•ï¼Œåœ¨å“ªé‡Œæ‰§è¡Œå‘½ä»¤å°±è·å–å“ªé‡Œçš„ç›®å½•ï¼Œè¿™é‡Œè·å–çš„ä¹Ÿæ˜¯è·Ÿæ“ä½œç³»ç»Ÿæœ‰å…³ç³»ï¼Œè¦æ›¿æ¢æˆ/

class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    let entry = {};
    if (typeof this.options.entry === "string") {
      entry.main = this.options.entry; //å¦‚æœæ˜¯å•å…¥å£ï¼Œå°†entry:"xx"å˜æˆ{main:"xx"}ï¼Œè¿™é‡Œéœ€è¦åšå…¼å®¹
    } else {
      entry = this.options.entry;
    }
+   //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
+   for (let entryName in entry) {
+     //entryName="main" entryNameå°±æ˜¯entryçš„å±æ€§åï¼Œä¹Ÿå°†ä¼šæˆä¸ºä»£ç å—çš„åç§°
+     let entryFilePath = path.posix.join(baseDir, entry[entryName]); //path.posixä¸ºäº†è§£å†³ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„åˆ†éš”ç¬¦,è¿™é‡Œæ‹¿åˆ°çš„å°±æ˜¯å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
+     //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
+     this.fileDependencies.push(entryFilePath);
+   }

    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

### å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰

#### è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 

```js
class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

+ //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
+ buildModule(name, modulePath) {
+   //6.2.1 è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
+   let sourceCode = fs.readFileSync(modulePath, "utf8");
+
+   return {};
+ }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    //ä»£ç çœç•¥...
    //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
    for (let entryName in entry) {
      //entryName="main" entryNameå°±æ˜¯entryçš„å±æ€§åï¼Œä¹Ÿå°†ä¼šæˆä¸ºä»£ç å—çš„åç§°
      let entryFilePath = path.posix.join(baseDir, entry[entryName]); //path.posixä¸ºäº†è§£å†³ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„åˆ†éš”ç¬¦,è¿™é‡Œæ‹¿åˆ°çš„å°±æ˜¯å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
      //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
      this.fileDependencies.push(entryFilePath);
      //6.2 å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
+     let entryModule = this.buildModule(entryName, entryFilePath);
    }

    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

#### åˆ›å»ºæ¨¡å—å¯¹è±¡

```js
class Compilation {
  //çœç•¥å…¶ä»–

  //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
  buildModule(name, modulePath) {
    //6.2.1 è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
    let sourceCode = fs.readFileSync(modulePath, "utf8");
    //buildModuleæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªmodulesæ¨¡å—å¯¹è±¡ï¼Œæ¯ä¸ªæ¨¡å—éƒ½ä¼šæœ‰ä¸€ä¸ªid,idæ˜¯ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„
+   let moduleId = "./" + path.posix.relative(baseDir, modulePath); //æ¨¡å—id:ä»æ ¹ç›®å½•å‡ºå‘ï¼Œæ‰¾åˆ°ä¸è¯¥æ¨¡å—çš„ç›¸å¯¹è·¯å¾„ï¼ˆ./src/index.jsï¼‰
+   //6.2.2 åˆ›å»ºæ¨¡å—å¯¹è±¡
+   let module = {
+     id: moduleId,
+     names: [name], //namesè®¾è®¡æˆæ•°ç»„æ˜¯å› ä¸ºä»£è¡¨çš„æ˜¯æ­¤æ¨¡å—å±äºå“ªä¸ªä»£ç å—ï¼Œå¯èƒ½å±äºå¤šä¸ªä»£ç å—
+     dependencies: [], //å®ƒä¾èµ–çš„æ¨¡å—
+     _source: "", //è¯¥æ¨¡å—çš„ä»£ç ä¿¡æ¯
+   };
+   return module;
  }

  build(callback) {
    //çœç•¥
  }
}
```

#### æ‰¾åˆ°å¯¹åº”çš„ `Loader` å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢

```js
class Compilation {
  //çœç•¥å…¶ä»–

  //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
  buildModule(name, modulePath) {
    //6.2.1 è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
    let sourceCode = fs.readFileSync(modulePath, "utf8");
    //buildModuleæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªmodulesæ¨¡å—å¯¹è±¡ï¼Œæ¯ä¸ªæ¨¡å—éƒ½ä¼šæœ‰ä¸€ä¸ªid,idæ˜¯ç›¸å¯¹äºæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„
    let moduleId = "./" + path.posix.relative(baseDir, modulePath); //æ¨¡å—id:ä»æ ¹ç›®å½•å‡ºå‘ï¼Œæ‰¾åˆ°ä¸è¯¥æ¨¡å—çš„ç›¸å¯¹è·¯å¾„ï¼ˆ./src/index.jsï¼‰
    //6.2.2 åˆ›å»ºæ¨¡å—å¯¹è±¡
    let module = {
      id: moduleId,
      names: [name], //namesè®¾è®¡æˆæ•°ç»„æ˜¯å› ä¸ºä»£è¡¨çš„æ˜¯æ­¤æ¨¡å—å±äºå“ªä¸ªä»£ç å—ï¼Œå¯èƒ½å±äºå¤šä¸ªä»£ç å—
      dependencies: [], //å®ƒä¾èµ–çš„æ¨¡å—
      _source: "", //è¯¥æ¨¡å—çš„ä»£ç ä¿¡æ¯
    };
    //6.2.3 æ‰¾åˆ°å¯¹åº”çš„ `Loader` å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢
+   let loaders = [];
+   let { rules = [] } = this.options.module;
+   rules.forEach((rule) => {
+     let { test } = rule;
+     //å¦‚æœæ¨¡å—çš„è·¯å¾„å’Œæ­£åˆ™åŒ¹é…ï¼Œå°±æŠŠæ­¤è§„åˆ™å¯¹åº”çš„loaderæ·»åŠ åˆ°loaderæ•°ç»„ä¸­
+     if (modulePath.match(test)) {
+       loaders.push(...rule.use);
+     }
+   });

+   //è‡ªå³å‘å·¦å¯¹æ¨¡å—è¿›è¡Œè½¬è¯‘
+   sourceCode = loaders.reduceRight((code, loader) => {
+     return loader(code);
+   }, sourceCode);

    return module;
  }

  build(callback) {
    //çœç•¥
  }
}
```

### å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `module` å¯¹è±¡ push è¿› `this.modules` ä¸­

```js
class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  buildModule(name, modulePath) {
    //çœç•¥å…¶ä»–
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    //çœç•¥å…¶ä»–
    //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
    for (let entryName in entry) {
      //entryName="main" entryNameå°±æ˜¯entryçš„å±æ€§åï¼Œä¹Ÿå°†ä¼šæˆä¸ºä»£ç å—çš„åç§°
      let entryFilePath = path.posix.join(baseDir, entry[entryName]); //path.posixä¸ºäº†è§£å†³ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„åˆ†éš”ç¬¦,è¿™é‡Œæ‹¿åˆ°çš„å°±æ˜¯å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
      //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
      this.fileDependencies.push(entryFilePath);
      //6.2 å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
      let entryModule = this.buildModule(entryName, entryFilePath);
+     //6.3 å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `module` å¯¹è±¡ push è¿› `this.modules` ä¸­
+     this.modules.push(entryModule);
    }
    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

è¿è¡Œæµç¨‹å›¾ï¼ˆç‚¹å‡»å¯æ”¾å¤§ï¼‰ï¼š

![](../../\images\webpack-study-12.png)

### æ‰¾å‡ºæ­¤æ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œå†å¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘

è¯¥æ­¥éª¤æ˜¯æ•´ä½“æµç¨‹ä¸­æœ€ä¸ºå¤æ‚çš„ï¼Œä¸€éçœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œå¯ä»¥å…ˆç†è§£æ€è·¯ã€‚

è¯¥æ­¥éª¤ç»è¿‡ç»†åŒ–å¯ä»¥å°†å…¶æ‹†åˆ†æˆåä¸ªå°æ­¥éª¤ï¼š

- å…ˆæŠŠæºä»£ç ç¼–è¯‘æˆ [AST](https://astexplorer.net/)
- åœ¨ `AST` ä¸­æŸ¥æ‰¾ `require` è¯­å¥ï¼Œæ‰¾å‡ºä¾èµ–çš„æ¨¡å—åç§°å’Œç»å¯¹è·¯å¾„
- å°†ä¾èµ–æ¨¡å—çš„ç»å¯¹è·¯å¾„ push åˆ° `this.fileDependencies` ä¸­
- ç”Ÿæˆä¾èµ–æ¨¡å—çš„`æ¨¡å— id`
- ä¿®æ”¹è¯­æ³•ç»“æ„ï¼ŒæŠŠä¾èµ–çš„æ¨¡å—æ”¹ä¸ºä¾èµ–`æ¨¡å— id`
- å°†ä¾èµ–æ¨¡å—çš„ä¿¡æ¯ push åˆ°è¯¥æ¨¡å—çš„ `dependencies` å±æ€§ä¸­
- ç”Ÿæˆæ–°ä»£ç ï¼Œå¹¶æŠŠè½¬è¯‘åçš„æºä»£ç æ”¾åˆ° `module._source` å±æ€§ä¸Š
- å¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼ˆå¯¹ `module å¯¹è±¡`ä¸­çš„ `dependencies` è¿›è¡Œé€’å½’æ‰§è¡Œ `buildModule` ï¼‰
- å¯¹ä¾èµ–æ¨¡å—ç¼–è¯‘å®Œæˆåå¾—åˆ°ä¾èµ–æ¨¡å—çš„ `module å¯¹è±¡`ï¼Œpush åˆ° `this.modules` ä¸­
- ç­‰ä¾èµ–æ¨¡å—å…¨éƒ¨ç¼–è¯‘å®Œæˆåï¼Œè¿”å›å…¥å£æ¨¡å—çš„ `module` å¯¹è±¡

```js
+ const parser = require("@babel/parser");
+ let types = require("@babel/types"); //ç”¨æ¥ç”Ÿæˆæˆ–è€…åˆ¤æ–­èŠ‚ç‚¹çš„ASTè¯­æ³•æ ‘çš„èŠ‚ç‚¹
+ const traverse = require("@babel/traverse").default;
+ const generator = require("@babel/generator").default;

//è·å–æ–‡ä»¶è·¯å¾„
+ function tryExtensions(modulePath, extensions) {
+   if (fs.existsSync(modulePath)) {
+     return modulePath;
+   }
+   for (let i = 0; i < extensions?.length; i++) {
+     let filePath = modulePath + extensions[i];
+     if (fs.existsSync(filePath)) {
+       return filePath;
+     }
+   }
+   throw new Error(`æ— æ³•æ‰¾åˆ°${modulePath}`);
+ }

class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
  buildModule(name, modulePath) {
    //çœç•¥å…¶ä»–
    //6.2.1 è¯»å–æ¨¡å—å†…å®¹ï¼Œè·å–æºä»£ç 
    //6.2.2 åˆ›å»ºæ¨¡å—å¯¹è±¡
    //6.2.3 æ‰¾åˆ°å¯¹åº”çš„ `Loader` å¯¹æºä»£ç è¿›è¡Œç¿»è¯‘å’Œæ›¿æ¢

    //è‡ªå³å‘å·¦å¯¹æ¨¡å—è¿›è¡Œè½¬è¯‘
    sourceCode = loaders.reduceRight((code, loader) => {
      return loader(code);
    }, sourceCode);

    //é€šè¿‡loaderç¿»è¯‘åçš„å†…å®¹ä¸€å®šå¾—æ˜¯jså†…å®¹ï¼Œå› ä¸ºæœ€åå¾—èµ°æˆ‘ä»¬babel-parseï¼Œåªæœ‰jsæ‰èƒ½æˆç¼–è¯‘AST
    //ç¬¬ä¸ƒæ­¥ï¼šæ‰¾å‡ºæ­¤æ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œå†å¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘
+     //7.1ï¼šå…ˆæŠŠæºä»£ç ç¼–è¯‘æˆ [AST](https://astexplorer.net/)
+     let ast = parser.parse(sourceCode, { sourceType: "module" });
+     traverse(ast, {
+       CallExpression: (nodePath) => {
+         const { node } = nodePath;
+         //7.2ï¼šåœ¨ `AST` ä¸­æŸ¥æ‰¾ `require` è¯­å¥ï¼Œæ‰¾å‡ºä¾èµ–çš„æ¨¡å—åç§°å’Œç»å¯¹è·¯å¾„
+         if (node.callee.name === "require") {
+           let depModuleName = node.arguments[0].value; //è·å–ä¾èµ–çš„æ¨¡å—
+           let dirname = path.posix.dirname(modulePath); //è·å–å½“å‰æ­£åœ¨ç¼–è¯‘çš„æ¨¡æ‰€åœ¨çš„ç›®å½•
+           let depModulePath = path.posix.join(dirname, depModuleName); //è·å–ä¾èµ–æ¨¡å—çš„ç»å¯¹è·¯å¾„
+           let extensions = this.options.resolve?.extensions || [ ".js" ]; //è·å–é…ç½®ä¸­çš„extensions
+           depModulePath = tryExtensions(depModulePath, extensions); //å°è¯•æ·»åŠ åç¼€ï¼Œæ‰¾åˆ°ä¸€ä¸ªçœŸå®åœ¨ç¡¬ç›˜ä¸Šå­˜åœ¨çš„æ–‡ä»¶
+           //7.3ï¼šå°†ä¾èµ–æ¨¡å—çš„ç»å¯¹è·¯å¾„ push åˆ° `this.fileDependencies` ä¸­
+           this.fileDependencies.push(depModulePath);
+           //7.4ï¼šç”Ÿæˆä¾èµ–æ¨¡å—çš„`æ¨¡å— id`
+           let depModuleId = "./" + path.posix.relative(baseDir, depModulePath);
+           //7.5ï¼šä¿®æ”¹è¯­æ³•ç»“æ„ï¼ŒæŠŠä¾èµ–çš„æ¨¡å—æ”¹ä¸ºä¾èµ–`æ¨¡å— id` require("./name")=>require("./src/name.js")
+           node.arguments = [types.stringLiteral(depModuleId)];
+           //7.6ï¼šå°†ä¾èµ–æ¨¡å—çš„ä¿¡æ¯ push åˆ°è¯¥æ¨¡å—çš„ `dependencies` å±æ€§ä¸­
+           module.dependencies.push({ depModuleId, depModulePath });
+         }
+       },
+     });

+     //7.7ï¼šç”Ÿæˆæ–°ä»£ç ï¼Œå¹¶æŠŠè½¬è¯‘åçš„æºä»£ç æ”¾åˆ° `module._source` å±æ€§ä¸Š
+     let { code } = generator(ast);
+     module._source = code;
+     //7.8ï¼šå¯¹ä¾èµ–æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼ˆå¯¹ `module å¯¹è±¡`ä¸­çš„ `dependencies` è¿›è¡Œé€’å½’æ‰§è¡Œ `buildModule` ï¼‰
+     module.dependencies.forEach(({ depModuleId, depModulePath }) => {
+       //è€ƒè™‘åˆ°å¤šå…¥å£æ‰“åŒ… ï¼šä¸€ä¸ªæ¨¡å—è¢«å¤šä¸ªå…¶ä»–æ¨¡å—å¼•ç”¨ï¼Œä¸éœ€è¦é‡å¤æ‰“åŒ…
+       let existModule = this.modules.find((item) => item.id === depModuleId);
+       //å¦‚æœmodulesé‡Œå·²ç»å­˜åœ¨è¿™ä¸ªå°†è¦ç¼–è¯‘çš„ä¾èµ–æ¨¡å—äº†ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ç¼–è¯‘äº†ï¼Œç›´æ¥æŠŠæ­¤ä»£ç å—çš„åç§°æ·»åŠ åˆ°å¯¹åº”æ¨¡å—çš„nameså­—æ®µé‡Œå°±å¯ä»¥
+       if (existModule) {
+         //namesæŒ‡çš„æ˜¯å®ƒå±äºå“ªä¸ªä»£ç å—chunk
+         existModule.names.push(name);
+       } else {
+         //7.9ï¼šå¯¹ä¾èµ–æ¨¡å—ç¼–è¯‘å®Œæˆåå¾—åˆ°ä¾èµ–æ¨¡å—çš„ `module å¯¹è±¡`ï¼Œpush åˆ° `this.modules` ä¸­
+         let depModule = this.buildModule(name, depModulePath);
+         this.modules.push(depModule);
+       }
+     });
+     //7.10ï¼šç­‰ä¾èµ–æ¨¡å—å…¨éƒ¨ç¼–è¯‘å®Œæˆåï¼Œè¿”å›å…¥å£æ¨¡å—çš„ `module` å¯¹è±¡
+     return module;
   }  
  //çœç•¥å…¶ä»–
}
```

è¿è¡Œæµç¨‹å›¾ï¼ˆç‚¹å‡»å¯æ”¾å¤§ï¼‰ï¼š

![](../../\images\webpack-study-13.png)

### ç­‰æ‰€æœ‰æ¨¡å—éƒ½ç¼–è¯‘å®Œæˆåï¼Œæ ¹æ®æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…ä»£ç å— `chunk`

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†å…¥å£æ¨¡å—å’Œå®ƒæ‰€ä¾èµ–æ¨¡å—çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥å»ç”Ÿæˆå¯¹åº”çš„ä»£ç å—äº†ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªå…¥å£æ–‡ä»¶ä¼šå¯¹åº”ä¸€ä¸ªä»£ç å—`chunk`ï¼Œæ¯ä¸ªä»£ç å—`chunk`é‡Œé¢ä¼šæ”¾ç€æœ¬å…¥å£æ¨¡å—å’Œå®ƒä¾èµ–çš„æ¨¡å—ï¼Œè¿™é‡Œæš‚æ—¶ä¸è€ƒè™‘ä»£ç åˆ†å‰²ã€‚

```js
class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  buildModule(name, modulePath) {
   //çœç•¥å…¶ä»–
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    //çœç•¥å…¶ä»–
    //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
    for (let entryName in entry) {
      //entryName="main" entryNameå°±æ˜¯entryçš„å±æ€§åï¼Œä¹Ÿå°†ä¼šæˆä¸ºä»£ç å—çš„åç§°
      let entryFilePath = path.posix.join(baseDir, entry[entryName]); //path.posixä¸ºäº†è§£å†³ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„åˆ†éš”ç¬¦,è¿™é‡Œæ‹¿åˆ°çš„å°±æ˜¯å…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
      //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
      this.fileDependencies.push(entryFilePath);
      //6.2 å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
      let entryModule = this.buildModule(entryName, entryFilePath);
      //6.3 å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `module` å¯¹è±¡ push è¿› `this.modules` ä¸­
      this.modules.push(entryModule);
      //ç¬¬å…«æ­¥ï¼šç­‰æ‰€æœ‰æ¨¡å—éƒ½ç¼–è¯‘å®Œæˆåï¼Œæ ¹æ®æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…ä»£ç å— `chunk`ï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªå…¥å£æ–‡ä»¶ä¼šå¯¹åº”ä¸€ä¸ªä»£ç å—`chunk`ï¼Œæ¯ä¸ªä»£ç å—`chunk`é‡Œé¢ä¼šæ”¾ç€æœ¬å…¥å£æ¨¡å—å’Œå®ƒä¾èµ–çš„æ¨¡å—ï¼‰
+     let chunk = {
+       name: entryName, //entryName="main" ä»£ç å—çš„åç§°
+       entryModule, //æ­¤ä»£ç å—å¯¹åº”çš„moduleçš„å¯¹è±¡,è¿™é‡Œå°±æ˜¯src/index.js çš„moduleå¯¹è±¡
+       modules: this.modules.filter((item) => item.names.includes(entryName)), //æ‰¾å‡ºå±äºè¯¥ä»£ç å—çš„æ¨¡å—
+     };
+     this.chunks.push(chunk);
    }
    //ç¼–è¯‘æˆåŠŸæ‰§è¡Œcallback
    callback()
  }
}
```

è¿è¡Œæµç¨‹å›¾ï¼ˆç‚¹å‡»å¯æ”¾å¤§ï¼‰ï¼š

![](../../\images\webpack-study-14.png)

### æŠŠå„ä¸ªä»£ç å—Â `chunk`Â è½¬æ¢æˆä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶åŠ å…¥åˆ°è¾“å‡ºåˆ—è¡¨

è¿™ä¸€æ­¥éœ€è¦ç»“åˆé…ç½®æ–‡ä»¶ä¸­çš„`output.filename`å»ç”Ÿæˆè¾“å‡ºæ–‡ä»¶çš„æ–‡ä»¶åç§°ï¼ŒåŒæ—¶è¿˜éœ€è¦ç”Ÿæˆè¿è¡Œæ—¶ä»£ç ï¼š

```js
//ç”Ÿæˆè¿è¡Œæ—¶ä»£ç 
+ function getSource(chunk) {
+   return `
+    (() => {
+     var modules = {
+       ${chunk.modules.map(
+         (module) => `
+         "${module.id}": (module) => {
+           ${module._source}
+         }
+       `
+       )}  
+     };
+     var cache = {};
+     function require(moduleId) {
+       var cachedModule = cache[moduleId];
+       if (cachedModule !== undefined) {
+         return cachedModule.exports;
+       }
+       var module = (cache[moduleId] = {
+         exports: {},
+       });
+       modules[moduleId](module, module.exports, require);
+       return module.exports;
+     }
+     var exports ={};
+     ${chunk.entryModule._source}
+   })();
+    `;
+ }

class Compilation {
  constructor(webpackOptions) {
    this.options = webpackOptions;
    this.modules = []; //æœ¬æ¬¡ç¼–è¯‘æ‰€æœ‰ç”Ÿæˆå‡ºæ¥çš„æ¨¡å—
    this.chunks = []; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„æ‰€æœ‰ä»£ç å—ï¼Œå…¥å£æ¨¡å—å’Œä¾èµ–çš„æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ä¸ºä»£ç å—
    this.assets = {}; //æœ¬æ¬¡ç¼–è¯‘äº§å‡ºçš„èµ„æºæ–‡ä»¶
    this.fileDependencies = []; //æœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å®ç°watchæ¨¡å¼ä¸‹ç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åä¼šé‡æ–°ç¼–è¯‘
  }

  //å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ï¼Œnameï¼šè¿™ä¸ªæ¨¡å—æ˜¯å±äºå“ªä¸ªä»£ç å—chunkçš„ï¼ŒmodulePathï¼šæ¨¡å—ç»å¯¹è·¯å¾„
  buildModule(name, modulePath) {
    //çœç•¥
  }

  build(callback) {
    //ç¬¬äº”æ­¥ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„`entry`é…ç½®é¡¹æ‰¾åˆ°æ‰€æœ‰çš„å…¥å£
    //ç¬¬å…­æ­¥ï¼šä»å…¥å£æ–‡ä»¶å‡ºå‘ï¼Œè°ƒç”¨é…ç½®çš„ `loader` è§„åˆ™ï¼Œå¯¹å„æ¨¡å—è¿›è¡Œç¼–è¯‘
    for (let entryName in entry) {
      //çœç•¥
      //6.1 æŠŠå…¥å£æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ï¼ˆ`this.fileDependencies`ï¼‰ä¸­ï¼Œè®°å½•æ­¤æ¬¡ç¼–è¯‘ä¾èµ–çš„æ¨¡å—
      //6.2 å¾—åˆ°å…¥å£æ¨¡å—çš„çš„ `module` å¯¹è±¡ ï¼ˆé‡Œé¢æ”¾ç€è¯¥æ¨¡å—çš„è·¯å¾„ã€ä¾èµ–æ¨¡å—ã€æºä»£ç ç­‰ï¼‰
      //6.3 å°†ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ `module` å¯¹è±¡ push è¿› `this.modules` ä¸­
      //ç¬¬å…«æ­¥ï¼šç­‰æ‰€æœ‰æ¨¡å—éƒ½ç¼–è¯‘å®Œæˆåï¼Œæ ¹æ®æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç»„è£…ä»£ç å— `chunk`ï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªå…¥å£æ–‡ä»¶ä¼šå¯¹åº”ä¸€ä¸ªä»£ç å—`chunk`ï¼Œæ¯ä¸ªä»£ç å—`chunk`é‡Œé¢ä¼šæ”¾ç€æœ¬å…¥å£æ¨¡å—å’Œå®ƒä¾èµ–çš„æ¨¡å—ï¼‰
    }

    //ç¬¬ä¹æ­¥ï¼šæŠŠå„ä¸ªä»£ç å— `chunk` è½¬æ¢æˆä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶åŠ å…¥åˆ°è¾“å‡ºåˆ—è¡¨
+    this.chunks.forEach((chunk) => {
+      let filename = this.options.output.filename.replace("[name]", chunk.name);
+      this.assets[filename] = getSource(chunk);
+    });

+     callback(
+       null,
+       {
+         chunks: this.chunks,
+         modules: this.modules,
+         assets: this.assets,
+       },
+       this.fileDependencies
+     );
  }
}
```

åˆ°äº†è¿™é‡Œï¼Œ`Compilation`Â çš„é€»è¾‘å°±èµ°å®Œäº†ã€‚

è¿è¡Œæµç¨‹å›¾ï¼ˆç‚¹å‡»å¯æ”¾å¤§ï¼‰ï¼š

![](../../\images\webpack-study-15.png)

### ç¡®å®šå¥½è¾“å‡ºå†…å®¹ä¹‹åï¼Œæ ¹æ®é…ç½®çš„è¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶åï¼Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿ

è¯¥æ­¥éª¤å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥æŒ‰ç…§ Compilation ä¸­çš„ this.status å¯¹è±¡å°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆè¿™é‡Œå°±æ˜¯ç¡¬ç›˜ï¼‰ã€‚

```js
class Compiler {
  constructor(webpackOptions) {
    this.options = webpackOptions; //å­˜å‚¨é…ç½®ä¿¡æ¯
    //å®ƒå†…éƒ¨æä¾›äº†å¾ˆå¤šé’©å­
    this.hooks = {
      run: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘åˆšå¼€å§‹çš„æ—¶å€™è§¦å‘æ­¤runé’©å­
      done: new SyncHook(), //ä¼šåœ¨ç¼–è¯‘ç»“æŸçš„æ—¶å€™è§¦å‘æ­¤doneé’©å­
    };
  }

  compile(callback) {
    //çœç•¥
  }

  //ç¬¬å››æ­¥ï¼šæ‰§è¡Œ`Compiler`å¯¹è±¡çš„`run`æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘
  run(callback) {
    this.hooks.run.call(); //åœ¨ç¼–è¯‘å‰è§¦å‘runé’©å­æ‰§è¡Œï¼Œè¡¨ç¤ºå¼€å§‹å¯åŠ¨ç¼–è¯‘äº†
    const onCompiled = (err, stats, fileDependencies) => {
+     //ç¬¬åæ­¥ï¼šç¡®å®šå¥½è¾“å‡ºå†…å®¹ä¹‹åï¼Œæ ¹æ®é…ç½®çš„è¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶åï¼Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆè¿™é‡Œå°±æ˜¯ç¡¬ç›˜ï¼‰
+     for (let filename in stats.assets) {
+       let filePath = path.join(this.options.output.path, filename);
+       fs.writeFileSync(filePath, stats.assets[filename], "utf8");
+     }

+     callback(err, {
+       toJson: () => stats,
+     });

      this.hooks.done.call(); //å½“ç¼–è¯‘æˆåŠŸåä¼šè§¦å‘doneè¿™ä¸ªé’©å­æ‰§è¡Œ
    };
    this.compile(onCompiled); //å¼€å§‹ç¼–è¯‘ï¼ŒæˆåŠŸä¹‹åè°ƒç”¨onCompiled
  }
}
```

è¿è¡Œæµç¨‹å›¾ï¼ˆç‚¹å‡»å¯æ”¾å¤§ï¼‰ï¼š

![](../../\images\webpack-study-16.png)

### å®Œæ•´æµç¨‹å›¾

ä»¥ä¸Šå°±æ˜¯æ•´ä¸ª Webpack çš„è¿è¡Œæµç¨‹å›¾ï¼Œè¿˜æ˜¯æè¿°çš„æ¯”è¾ƒæ¸…æ™°çš„ï¼Œè·Ÿç€ä¸€æ­¥æ­¥èµ°çœ‹æ‡‚è‚¯å®šæ²¡é—®é¢˜ï¼

![](../../\images\webpack-study-17.jpg)

æ‰§è¡Œ `node ./debugger.js`ï¼Œé€šè¿‡æˆ‘ä»¬æ‰‹å†™çš„ Webpack è¿›è¡Œæ‰“åŒ…ï¼Œå¾—åˆ°è¾“å‡ºæ–‡ä»¶ **dist/main.js**ï¼š

![](../../\images\webpack-study-18.png)

## å®ç° watch æ¨¡å¼

çœ‹å®Œä¸Šé¢çš„å®ç°ï¼Œæœ‰äº›å°ä¼™ä¼´å¯èƒ½æœ‰ç–‘é—®äº†ï¼š`Compilation` ä¸­çš„ `this.fileDependencies`ï¼ˆæœ¬æ¬¡æ‰“åŒ…æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼‰æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿä¸ºä»€ä¹ˆæ²¡æœ‰åœ°æ–¹ç”¨åˆ°è¯¥å±æ€§ï¼Ÿ

è¿™é‡Œå…¶å®æ˜¯ä¸ºäº†å®ç° [Webpack çš„ watch æ¨¡å¼](https://webpack.docschina.org/guides/development/#using-watch-mode)ï¼šå½“æ–‡ä»¶å‘ç”Ÿå˜æ›´æ—¶å°†é‡æ–°ç¼–è¯‘ã€‚

æ€è·¯ï¼šå¯¹ `this.fileDependencies` é‡Œé¢çš„æ–‡ä»¶è¿›è¡Œç›‘å¬ï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé‡æ–°æ‰§è¡Œ `compile` å‡½æ•°ã€‚

```js
class Compiler {
  constructor(webpackOptions) {
   //çœç•¥
  }

  compile(callback) {
    //è™½ç„¶webpackåªæœ‰ä¸€ä¸ªCompilerï¼Œä½†æ˜¯æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šäº§å‡ºä¸€ä¸ªæ–°çš„Compilationï¼Œ
    //è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†è€ƒè™‘åˆ°watchæ¨¡å¼ï¼Œå®ƒä¼šåœ¨å¯åŠ¨æ—¶å…ˆç¼–è¯‘ä¸€æ¬¡ï¼Œç„¶åç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ä¼šé‡æ–°å¼€å§‹ç¼–è¯‘
    //æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šäº§å‡ºä¸€ä¸ªæ–°çš„Compilationï¼Œä»£è¡¨æ¯æ¬¡çš„ç¼–è¯‘ç»“æœ
    let compilation = new Compilation(this.options);
    compilation.build(callback); //æ‰§è¡Œcompilationçš„buildæ–¹æ³•è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æˆåŠŸä¹‹åæ‰§è¡Œå›è°ƒ
  }

  //ç¬¬å››æ­¥ï¼šæ‰§è¡Œ`Compiler`å¯¹è±¡çš„`run`æ–¹æ³•å¼€å§‹æ‰§è¡Œç¼–è¯‘
  run(callback) {
    this.hooks.run.call(); //åœ¨ç¼–è¯‘å‰è§¦å‘runé’©å­æ‰§è¡Œï¼Œè¡¨ç¤ºå¼€å§‹å¯åŠ¨ç¼–è¯‘äº†
    const onCompiled = (err, stats, fileDependencies) => {
      //ç¬¬åæ­¥ï¼šç¡®å®šå¥½è¾“å‡ºå†…å®¹ä¹‹åï¼Œæ ¹æ®é…ç½®çš„è¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶åï¼Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆè¿™é‡Œå°±æ˜¯ç¡¬ç›˜ï¼‰
      for (let filename in stats.assets) {
        let filePath = path.join(this.options.output.path, filename);
        fs.writeFileSync(filePath, stats.assets[filename], "utf8");
      }

      callback(err, {
        toJson: () => stats,
      });

+     fileDependencies.forEach((fileDependencie) => {
+       fs.watch(fileDependencie, () => this.compile(onCompiled));
+     });

      this.hooks.done.call(); //å½“ç¼–è¯‘æˆåŠŸåä¼šè§¦å‘doneè¿™ä¸ªé’©å­æ‰§è¡Œ
    };
    this.compile(onCompiled); //å¼€å§‹ç¼–è¯‘ï¼ŒæˆåŠŸä¹‹åè°ƒç”¨onCompiled
  }
}
```

ç›¸ä¿¡çœ‹åˆ°è¿™é‡Œï¼Œä½ ä¸€å®šä¹Ÿç†è§£äº† compile å’Œ Compilation çš„è®¾è®¡ï¼Œéƒ½æ˜¯ä¸ºäº†è§£è€¦å’Œå¤ç”¨å‘€ã€‚

## æ€»ç»“

æœ¬æ–‡ä» Webpack çš„åŸºæœ¬ä½¿ç”¨å’Œæ„å»ºäº§ç‰©å‡ºå‘ï¼Œä»æ€æƒ³å’Œæ¶æ„ä¸¤æ–¹é¢æ·±åº¦å‰–æäº† Webpack çš„è®¾è®¡ç†å¿µã€‚

## æ¨èé˜…è¯»

1. [ä»é›¶åˆ°äº¿ç³»ç»Ÿæ€§çš„å»ºç«‹å‰ç«¯æ„å»ºçŸ¥è¯†ä½“ç³»âœ¨](https://juejin.cn/post/7145855619096903717)
2. [æˆ‘æ˜¯å¦‚ä½•å¸¦é¢†å›¢é˜Ÿä»é›¶åˆ°ä¸€å»ºç«‹å‰ç«¯è§„èŒƒçš„ï¼ŸğŸ‰ğŸ‰ğŸ‰](https://juejin.cn/post/7085257325165936648)
3. [çº¿ä¸Šå´©äº†ï¼Ÿä¸€æ‹›æ•™ä½ å¿«é€Ÿå®šä½é—®é¢˜ï¼](https://juejin.cn/post/7166031357418668040)
4. [ã€ä¸­çº§/é«˜çº§å‰ç«¯ã€‘ä¸ºä»€ä¹ˆæˆ‘å»ºè®®ä½ ä¸€å®šè¦è¯»ä¸€è¯» Tapable æºç ï¼Ÿ](https://juejin.cn/post/7164175171358556173)
5. [å‰ç«¯å·¥ç¨‹åŒ–åŸºçŸ³ -- ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ä»¥åŠASTçš„å¹¿æ³›åº”ç”¨ğŸ”¥](https://juejin.cn/post/7155151377013047304)
6. [Webpackæ·±åº¦è¿›é˜¶ï¼šä¸¤å¼ å›¾å½»åº•è®²æ˜ç™½çƒ­æ›´æ–°åŸç†ï¼](https://juejin.cn/post/7176963906844246074#comment)
7. [ã€ä¸‡å­—é•¿æ–‡ï½œè¶£å‘³å›¾è§£ã€‘å½»åº•å¼„æ‡‚Webpackä¸­çš„Loaderæœºåˆ¶](https://juejin.cn/post/7157739406835580965)
8. [å­¦ä¼šè¿™äº›è‡ªå®šä¹‰hooksï¼Œè®©ä½ æ‘¸é±¼æ—¶é—´å†ç¿»ä¸€å€ğŸŸğŸŸ](https://juejin.cn/post/7095396322643017742)
9. [æµ…æå‰ç«¯å¼‚å¸¸åŠé™çº§å¤„ç†](https://juejin.cn/post/6979564690787532814)
10. [å‰ç«¯é‡æ–°éƒ¨ç½²åï¼Œé¢†å¯¼è·Ÿæˆ‘è¯´é¡µé¢å´©æºƒäº†...](https://juejin.cn/post/6981718762483679239)
