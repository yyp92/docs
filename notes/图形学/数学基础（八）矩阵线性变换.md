# 矩阵线性变换

我们可以通过添加一些值到它的坐标来平移一个点。 我们还可以利用三角函数来旋转矢量。 简而言之，**矩阵只是将所有这些变换(缩放、旋转、反射、错切、平移)组合成一个单一结构的一种方式。** 通过矩阵的方式我们可以方便的对空间中的点或矢量进行变换，而不用写一大堆的公式。这就是矩阵为何在图形渲染管线中存在重要意义的原因。**图形中的任意变换都可以通过一个矩阵完成。** 对同一个对象的多次变换可以通过矩阵乘积转换为单个矩阵。如下图：

*注：本文所有推导和公式均使用列矢量形式。*

![](../../\images\graphics-mathematics-basic-8-vector-1.jpg)

## 线性变换

### 缩放（Scale）

#### 沿主轴缩放

最简单的缩放是沿每个轴线应用单独的或者统一的缩放。

##### 均匀缩放

保留原始对象的角度和比例， 使被缩放对象统一增大或者减少s因子。

![](../../\images\graphics-mathematics-basic-8-vector-2.jpg)

$$
\begin{bmatrix}
x' \\
y' 
\end{bmatrix} = 
\begin{bmatrix}
S & 0 \\
0 & S
\end{bmatrix}
\begin{bmatrix}
x \\
y
\end{bmatrix}
$$

同理三维空间中采用以下形式:

$$
\begin{bmatrix}
x' \\
y' \\
z'
\end{bmatrix} = 
\begin{bmatrix}
S & 0 & 0 \\
0 & S & 0 \\
0 & 0 & S
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
z
\end{bmatrix}
$$

#### 非均匀缩放

如果希望"拉伸"或者"挤压"对象,则可以在不同方向上应用不同的缩放因子，这样会导致非均匀缩放。非均匀缩放不会保留原始对象的角度。

![](../../\images\graphics-mathematics-basic-8-vector-3.jpg)

$$
\begin{bmatrix}
x' \\
y' 
\end{bmatrix} = 
\begin{bmatrix}
S_x & 0 \\
0 & S_y
\end{bmatrix}
\begin{bmatrix}
x \\
y
\end{bmatrix}
$$

同理三维空间中采用以下形式:

$$
\begin{bmatrix}
x' \\
y' \\
z'
\end{bmatrix} = 
\begin{bmatrix}
S_x & 0 & 0 \\
0 & S_y & 0 \\
0 & 0 & S_z
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
z
\end{bmatrix}
$$

#### 任意方向缩放

除了沿主轴线缩放外，还可以应用独立于坐标系的缩放，即沿任意方向的缩放。设 $\hat n$ 缩放方向（缩放沿着 $\hat n$ 执行），缩放因子s。以下将逐步实现沿任意方向缩放的方法。

**step1**: 推导表达式，给定任意矢量 ${\vec v}$ ，用 $\vec v, s, \hat n$ 计算 $v'$ 。基本思路是将矢量 $\vec v$ 在 $\hat n$ 上投影，分解为 $\vec v_\lVert$ 和 $\vec v_\bot$ ​​。其中 $\vec v_\lVert$ ​​根据k因子缩放，$\vec v_\bot$ 保持不变。以下为推导过程：

![](../../\images\graphics-mathematics-basic-8-vector-4.jpg)

$$
\vec v = \vec v_\lVert + \vec v_\bot
$$

$$
\vec v_\lVert = (\vec v \cdot \hat n) \hat n
$$

$$
\vec v_\bot' = \vec v_\bot = \vec v - \vec v_\lVert = \vec v - (\vec v \cdot \hat n) \hat n
$$

$$
\vec v_\lVert' = s\vec{v_\lVert} = s(\vec v \cdot \hat n) \hat n
$$

$$
\vec v'= \vec v_\lVert' + \vec v_\bot' = \vec v - (\vec v \cdot \hat n) \hat n + s(\vec v \cdot \hat n) \hat n= \vec v + (s-1)(\vec v \cdot \hat n)\hat n
$$

**step2**: 既然我们知道了如何缩放任意矢量，则可以计算出缩放后的基矢量值，将原始基矢量 $x=\begin{bmatrix}1 \\ 0\end{bmatrix}$ , $y=\begin{bmatrix}0 \\ 1\end{bmatrix}$ 带入上式可得:

$$
\vec{x'} = \vec{x} + (s-1)(\vec{x}\cdot \hat{n})\hat{n} \\
= \begin{bmatrix}1 \\ 0\end{bmatrix} + (s-1)(\begin{bmatrix}1 \\ 0\end{bmatrix}\cdot\begin{bmatrix}n_x \\ n_y\end{bmatrix})\cdot\begin{bmatrix}n_x \\ n_y\end{bmatrix} \\
= \begin{bmatrix}1 \\ 0\end{bmatrix} + (s-1)n_x\cdot\begin{bmatrix}n_x \\n_y\end{bmatrix} \\
= \begin{bmatrix}1 + (s-1)n_x^2 \\ (s-1)n_xn_y\end{bmatrix}
$$

$$
\vec{y'} = \begin{bmatrix}(s-1)n_xn_y \\ 1 + (s-1)n_y^2 \end{bmatrix}
$$

推导出二维和三维矢量空间沿任意方向 $\hat n$ 缩放s的矩阵为：

$$
Scale^2(\hat{n}, s) = 
\begin{bmatrix}
1 + (s-1)n_x^2 & (s-1)n_xn_y \\
(s-1)n_xn_y & 1 + (s-1)n_y^2
\end{bmatrix}
$$

$$
Scale^3(\hat{n}, s) = 
\begin{bmatrix}
1 + (s-1)n_x^2 & (s-1)n_xn_y & (s-1)n_xn_z \\
(s-1)n_xn_y & 1 + (s-1)n_y^2 & (s-1)n_yn_z \\
(s-1)n_xn_z & (s-1)n_yn_z & 1 + (s-1)n_z^2
\end{bmatrix}
$$

### 反射（Reflection）

**反射其实是一种特殊的缩放，即按照某个轴线执行-1缩放。**

#### 沿主轴线的反射

![](../../\images\graphics-mathematics-basic-8-vector-5.jpg)

$$
\begin{bmatrix}
x' \\
y' 
\end{bmatrix} = 
\begin{bmatrix}
-1 & 0 \\
0 & 1
\end{bmatrix}
\begin{bmatrix}
x \\
y
\end{bmatrix}
$$

#### 沿任意轴反射

根据沿任意轴缩放得到的矩阵公式，将-1带入，可得沿任意轴反射的矩阵公式：

$$
Reflection^2(\hat{n}) = 
\begin{bmatrix}
1 + (-1-1)n_x^2 & (-1-1)n_xn_y \\
(-1-1)n_xn_y & 1 + (-1-1)n_y^2
\end{bmatrix}
$$

$$
Reflection^3(\hat{n}) = 
\begin{bmatrix}
1 + (-1-1)n_x^2 & (-1-1)n_xn_y & (-1-1)n_xn_z \\
(-1-1)n_xn_y & 1 + (-1-1)n_y^2 & (-1-1)n_yn_z \\
(-1-1)n_xn_z & (-1-1)n_yn_z & 1 + (-1-1)n_z^2
\end{bmatrix}
$$

### 错切（Shaearing）

错切是一种“倾斜”坐标空间的变形。它将不均匀的拉伸空间，不保留角度。但是保留面积和体积。基本思路是将一个坐标的倍数添加到另一个坐标上。

![](../../\images\graphics-mathematics-basic-8-vector-6.jpg)

$$
\begin{bmatrix}
x' \\
y' 
\end{bmatrix} = 
\begin{bmatrix}
1 & a \\
0 & 1
\end{bmatrix}
\begin{bmatrix}
x \\
y
\end{bmatrix}
$$

二维错切矩阵公式：

$$
H_x(s) = 
\begin{bmatrix}
1 & s \\
0 & 1 
\end{bmatrix}(沿x轴方向拉拽)
$$

$$
H_y(s) = 
\begin{bmatrix}
1 & 0 \\
s & 1 
\end{bmatrix}(沿y轴方向拉拽)
$$

三维错切矩阵公式：

$$
H_{xy}(s, t) = 
\begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
s & t & 1
\end{bmatrix}
$$

$$
H_{xz}(s, t) = 
\begin{bmatrix}
1 & 0 & 0 \\
s & 1 & t \\
s & t & 1
\end{bmatrix}
$$

$$
H_{yz}(s, t) = 
\begin{bmatrix}
1 & s & t \\
0 & 1 & 0 \\
s & t & 1
\end{bmatrix}
$$

### 旋转（Rotation）

#### 二维空间绕原点的旋转

在二维空间中只能绕点旋转，本小节公式和实例将旋转点限定为坐标系原点（绕任意点的旋转需要先平移 再旋转 再平移回去，涉及到齐次坐标，暂不讨论）。
定义二维空间中旋转角度为 $\theta$ ，根据三角函数的定义可知，基矢量 $\vec x, \vec y$ 绕原点旋转后得到 $\vec x', \vec y'$ ​如下图所示：

![](../../\images\graphics-mathematics-basic-8-vector-7.jpg)

> 其中蓝色虚线表示的应该是 $\vec{y'}$

$$
R(\theta) = 
\begin{bmatrix}
\cos{\theta} & -\sin{\theta} \\
\sin{\theta} & \cos{\theta}
\end{bmatrix}
$$

#### 三维空间绕主轴线的旋转

和二维不同，三种中旋转是绕某个轴线进行的。本小节将介绍围绕主轴线（x，y，z）的旋转.
和缩放矩阵的推导类似，首先我们对三个基矢量进行变换,以围绕x轴旋转为例：

**step1**：对基矢量应用旋转变换：

$$
\vec{x'} = \vec{x} = 
\begin{bmatrix}
1 \\
0 \\
0
\end{bmatrix}
$$

$$
\vec{y'} = 
\begin{bmatrix}
0 \\
\cos{\theta} \\
\sin{\theta}
\end{bmatrix}
$$

$$
\vec{z'} = 
\begin{bmatrix}
0 \\
-\sin{\theta} \\
\cos{\theta}
\end{bmatrix}
$$

**step2**:组合基矢量形成旋转矩阵：

$$
R_x(\theta) = 
\begin{bmatrix}
1 & 0 & 0 \\
0 & \cos{\theta} & -\sin{\theta} \\
0 & \sin{\theta} & \cos{\theta}
\end{bmatrix}
$$

同理可推导出沿y,z轴的旋转矩阵公式如下：

$$
R_y(\theta) = 
\begin{bmatrix}
\cos{\theta} & 0 & \sin{\theta} \\
0 & 1 & 0 \\
-\sin{\theta} & 0 & \cos{\theta}
\end{bmatrix}
$$

$$
R_z(\theta) = 
\begin{bmatrix}
\cos{\theta} & -\sin{\theta} & 0 \\
\sin{\theta} & \cos{\theta} & 0 \\
0 & 0 & 1
\end{bmatrix}
$$

#### 三维空间绕任意轴的旋转

![](../../\images\graphics-mathematics-basic-8-vector-8.jpg)

让我们推导出一个围绕 $\hat{n}$ 旋转θ角度的矩阵 $R(\hat{n}, \theta)$ ,使得当矩阵 $R(\hat{n}, \theta)$ 乘以矢量v得到的矢量 $\vec{v'}$ 是将 $\vec{v}$ 围绕 $\hat{n}$ 旋转 $\theta$ 角度的结果.

$$
\vec{v'} = R(\hat{n}, \theta)\vec{v}
$$

**推导思路**

- 为了得到矩阵 $R(\hat{n}, \theta)$ ,需要用 $\vec{v}, \hat{n}, \theta$ 来表达 $\vec{v'}$ ,基本思路是解决垂直于 $\hat{n}$ 的平面中的问题,为此,将 $\vec v$ 分解为 $\vec{v_\lVert}$ ​和 $\vec{v_\bot}$ ​两个矢量,分别平行和垂直于单位矢量 $\hat n$ .通过单独旋转每个分量,剋将矢量作为一个整体旋转.即: $\vec{v'} = \vec{v_\lVert'} + \vec{v_\bot'}$ ​.

- 由于 $\vec{v_\lVert}$ 与 $\hat n$ 平行,因此它不受旋转影响.即: $\vec{v_\lVert'} = \vec{v_\Vert}$

- 根据矢量的投影计算可得: $\vec{v_\lVert} = (\vec{v} \cdot \hat{n})\hat{n} , \vec{v_\bot}=\vec{v} - \vec{v_\lVert}$

- 利用矢量叉积构造 $\vec{w}: \vec{w} = \hat{n} \times \vec{v_\bot}= \hat{n} \times \vec{v}$

- 注意上图所示,矢量 $\vec w$ 和 $\vec {v_\bot}$ ​构成了一个二维空间. $\vec {v_\bot}$ ​作为x轴, $\vec w$ 作为y轴. $\vec {v_\bot '}$ ​是在这个平面上按角度 $\theta$ 旋转 $\vec {v_\bot}$ ​的结果.

**推导过程**

$$
\vec{v_\lVert} = (\vec{v}\cdot\hat{n})\hat{n}
$$

$$
\vec{v_\bot} = \vec{v} - \vec{v_\bot} = \vec{v} - (\vec{v}\cdot\hat{n})\hat{n}
$$

$$
\vec{w} = \hat{n} \times \vec{n_\bot} = \hat{n} \times \vec{v}
$$

$$
\vec{v_\bot'} = \cos\theta\vec{v_\bot} + \sin\theta\vec{w} = \cos\theta(\vec{v} - (\vec{v}\cdot\hat{n})\hat{n}) + \sin\theta(\hat{n} \times \vec{v})
$$

$$
\vec{v'} = \vec{v_\bot'} + \vec{v_\lVert} = \cos\theta(\vec{v} - (\vec{v}\cdot\hat{n})\hat{n}) + \sin\theta(\hat{n} \times \vec{v}) + (\vec{v}\cdot\hat{n})\hat{n}
$$

接下来,计算变换后的基矢量.简单的带入上式即可.

$$
\vec{x'} =
\begin{bmatrix}
n_x^2(1 - \cos\theta) + \cos\theta \\
n_xn_y(1 - \cos\theta) + n_z\sin\theta \\
n_xn_z(1 - \cos\theta) - n_y\sin\theta
\end{bmatrix}
$$

$$
\vec{y'} =
\begin{bmatrix}
n_xn_y(1 - \cos\theta) - n_z\sin\theta \\
n_y^2(1 - \cos\theta) + \cos\theta \\
n_yn_z(1 - \cos\theta) + n_x\sin\theta
\end{bmatrix}
$$

$$
\vec{z'} =
\begin{bmatrix}
n_xn_z(1 - \cos\theta) + n_y\sin\theta \\
n_yn_z(1 - \cos\theta) - n_x\sin\theta \\
n_z^2(1 - \cos\theta) + \cos\theta 
\end{bmatrix}
$$

通过变换后基矢量的简单组合,即可构造出旋转矩阵

$$
R(\hat{n}, \theta) =
\begin{bmatrix}
| & | & | \\
\vec{x'} & \vec{y'} & \vec{z'} \\
| & | & |
\end{bmatrix} \\
= \begin{bmatrix}
n_x^2(1 - \cos\theta) + \cos\theta & n_xn_y(1 - \cos\theta) - n_z\sin\theta & n_xn_z(1 - \cos\theta) + n_y\sin\theta   \\
n_xn_y(1 - \cos\theta) + n_z\sin\theta & n_y^2(1 - \cos\theta) + \cos\theta & n_yn_z(1 - \cos\theta) - n_x\sin\theta \\
n_xn_z(1 - \cos\theta) - n_y\sin\theta & n_yn_z(1 - \cos\theta) + n_x\sin\theta & n_z^2(1 - \cos\theta) + \cos\theta 
\end{bmatrix}
$$

至此绕任意轴的三维旋转矩阵推导完毕.

## 引用

[《3D数学基础》图形和游戏开发(第二版)](https://item.jd.com/12659881.html)

[GAMES101 -现代计算机图形学入门-闫令琪](https://www.bilibili.com/video/BV1X7411F744?p=3&vd_source=b3b87210888ec87be647603921054a36)

[scratchapixel](https://www.scratchapixel.com/)










